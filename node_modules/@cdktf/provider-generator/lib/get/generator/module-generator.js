"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ModuleGenerator = void 0;
// Copyright (c) HashiCorp, Inc
// SPDX-License-Identifier: MPL-2.0
const codemaker_1 = require("codemaker");
const models_1 = require("./models");
const sanitized_comments_1 = require("./sanitized-comments");
class ModuleGenerator {
    constructor(code, targets) {
        this.code = code;
        this.targets = targets;
        this.code.indentation = 2;
        for (const target of this.targets) {
            this.emitSubmodule(target);
        }
    }
    emitSubmodule(target) {
        const spec = target.spec;
        if (!spec) {
            throw new Error(`missing spec for ${target.fqn}`);
        }
        this.code.openFile(target.fileName);
        this.code.line(`// generated by cdktf get`);
        this.code.line(`// ${target.source}`);
        this.code.line(`import { TerraformModule, TerraformModuleUserConfig } from 'cdktf';`);
        this.code.line(`import { Construct } from 'constructs';`);
        const baseName = this.code.toPascalCase(target.name.replace(/[-/.]/g, "_"));
        const configType = `${baseName}Config`;
        this.code.openBlock(`export interface ${configType} extends TerraformModuleUserConfig`);
        for (const input of spec.inputs) {
            const optional = input.required && input.default === undefined ? "" : "?";
            const comment = (0, sanitized_comments_1.sanitizedComment)(this.code);
            if (input.description) {
                comment.line(input.description);
            }
            if (input.default) {
                comment.line(input.default);
            }
            if (input.type.includes("map(")) {
                comment.line(`The property type contains a map, they have special handling, please see {@link cdk.tf/module-map-inputs the docs}`);
            }
            comment.end();
            this.code.line(`readonly ${models_1.AttributeModel.escapeName((0, codemaker_1.toCamelCase)(input.name))}${optional}: ${parseType(input.type)};`);
        }
        this.code.closeBlock();
        // Add a link to the Terraform Registry if it is sourced from there
        // https://developer.hashicorp.com/terraform/language/modules/sources
        // Registry modules are referred to as <NAMESPACE>/<NAME>/<PROVIDER>
        // Other sources contain dots, e.g.
        // app.terraform.io/example-corp/k8s-cluster/azurerm (private registries)
        // github.com/hashicorp/example (Github)
        // git@github.com:hashicorp/example.git
        // bitbucket.org/hashicorp/terraform-consul-aws (Bitbucket)
        // ... and more
        // ../module and ./module (local paths)
        const isNonRegistryModule = target.source.includes(".");
        let registryPath;
        // Submodules also exist (e.g. terraform-aws-modules/vpc/aws//modules/vpc-endpoints)
        // And linking directly to them in the Registry requires including the version
        // like e.g. https://registry.terraform.io/modules/terraform-aws-modules/vpc/aws/latest/submodules/vpc-endpoints
        if (target.source.includes("//")) {
            registryPath = target.source.replace("//modules", `/${target.version || "latest"}/submodules`);
            // terraform-aws-modules/vpc/aws//modules/vpc-endpoints
            // ->
            // terraform-aws-modules/vpc/aws/latest/submodules/vpc-endpoints
        }
        else {
            // not submodule specified, just append the version
            registryPath = `${target.source}/${target.version || "latest"}`;
        }
        const comment = (0, sanitized_comments_1.sanitizedComment)(this.code);
        comment.line(`Defines an ${baseName} based on a Terraform module`);
        comment.line(``);
        comment.line(isNonRegistryModule
            ? `Source at ${target.source}`
            : `Docs at Terraform Registry: {@link https://registry.terraform.io/modules/${registryPath} ${target.source}}`);
        comment.end();
        this.code.openBlock(`export class ${baseName} extends TerraformModule`);
        this.code.line(`private readonly inputs: { [name: string]: any } = { }`);
        const allOptional = spec.inputs.find((x) => x.required) ? "" : " = {}";
        this.code.open(`public constructor(scope: Construct, id: string, config: ${configType}${allOptional}) {`);
        this.code.open(`super(scope, id, {`);
        this.code.line("...config,");
        this.code.line(`source: '${target.source}',`);
        if (target.version) {
            this.code.line(`version: '${target.version}',`);
        }
        this.code.close(`});`);
        for (const input of spec.inputs) {
            const inputName = models_1.AttributeModel.escapeName((0, codemaker_1.toCamelCase)(input.name));
            this.code.line(`this.${inputName} = config.${inputName};`);
        }
        this.code.close(`}`); // ctor
        for (const input of spec.inputs) {
            const inputName = models_1.AttributeModel.escapeName((0, codemaker_1.toCamelCase)(input.name));
            const inputType = parseType(input.type) +
                (input.required && input.default === undefined ? "" : " | undefined");
            this.code.openBlock(`public get ${inputName}(): ${inputType}`);
            this.code.line(`return this.inputs['${input.name}'] as ${inputType};`);
            this.code.closeBlock();
            this.code.openBlock(`public set ${inputName}(value: ${inputType})`);
            this.code.line(`this.inputs['${input.name}'] = value;`);
            this.code.closeBlock();
        }
        for (const output of spec.outputs) {
            const outputName = (0, codemaker_1.toCamelCase)(output.name);
            this.code.openBlock(`public get ${outputName}Output()`);
            this.code.line(`return this.getString('${output.name}')`);
            this.code.closeBlock();
        }
        this.code.openBlock(`protected synthesizeAttributes()`);
        this.code.line(`return this.inputs;`);
        this.code.closeBlock();
        this.code.openBlock(`protected synthesizeHclAttributes(): { [name: string]: any }`);
        this.code.line(`return Object.fromEntries(`);
        this.code.line(`  Object.entries(this.inputs)`);
        this.code.line(`    .filter(([, val]) => val !== undefined)`);
        this.code.line(`    .map(([key, val]) => {`);
        this.code.line(`      return [`);
        this.code.line(`        key,`);
        this.code.line(`        {`);
        this.code.line(`          value: val,`);
        this.code.line(`          type: "any",`);
        this.code.line(`        },`);
        this.code.line(`      ];`);
        this.code.line(`    })`);
        this.code.line(`);`);
        this.code.closeBlock();
        this.code.closeBlock(); // class
        this.code.closeFile(target.fileName);
    }
}
exports.ModuleGenerator = ModuleGenerator;
function parseType(type) {
    if (type === "string") {
        return "string";
    }
    if (type === "number") {
        return "number";
    }
    if (type === "bool") {
        return "boolean";
    }
    if (type === "list") {
        return "string[]";
    }
    if (type === "map") {
        return "{ [key: string]: string }";
    }
    if (type === "tuple") {
        return "string[]";
    }
    if (type === "any") {
        return "any";
    }
    const complexType = parseComplexType(type);
    if (complexType) {
        return complexType;
    }
    throw new Error(`unknown type ${type}`);
}
function parseComplexType(type) {
    const complex = /^(object|list|map|set|tuple)\(([\s\S]+)\)/;
    const match = complex.exec(type);
    if (!match) {
        return undefined;
    }
    const [, kind, innerType] = match;
    if (kind === "object") {
        return `any`;
    }
    if (kind === "list" || kind === "set") {
        return `${parseType(innerType)}[]`;
    }
    if (kind === "tuple") {
        return `any[]`;
    }
    if (kind === "map") {
        return `{ [key: string]: ${parseType(innerType)} }`;
    }
    throw new Error(`unexpected kind ${kind}`);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kdWxlLWdlbmVyYXRvci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIm1vZHVsZS1nZW5lcmF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsK0JBQStCO0FBQy9CLG1DQUFtQztBQUNuQyx5Q0FBbUQ7QUFDbkQscUNBQTBDO0FBQzFDLDZEQUF3RDtBQUd4RCxNQUFhLGVBQWU7SUFDMUIsWUFDbUIsSUFBZSxFQUNmLE9BQXNDO1FBRHRDLFNBQUksR0FBSixJQUFJLENBQVc7UUFDZixZQUFPLEdBQVAsT0FBTyxDQUErQjtRQUV2RCxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUM7UUFFMUIsS0FBSyxNQUFNLE1BQU0sSUFBSSxJQUFJLENBQUMsT0FBTyxFQUFFO1lBQ2pDLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDNUI7SUFDSCxDQUFDO0lBRU8sYUFBYSxDQUFDLE1BQW1DO1FBQ3ZELE1BQU0sSUFBSSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFFekIsSUFBSSxDQUFDLElBQUksRUFBRTtZQUNULE1BQU0sSUFBSSxLQUFLLENBQUMsb0JBQW9CLE1BQU0sQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO1NBQ25EO1FBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBRXBDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLDJCQUEyQixDQUFDLENBQUM7UUFDNUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztRQUV0QyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FDWixxRUFBcUUsQ0FDdEUsQ0FBQztRQUNGLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLHlDQUF5QyxDQUFDLENBQUM7UUFFMUQsTUFBTSxRQUFRLEdBQUcsSUFBSSxD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RywyQ0FBMkMsQ0FBQztJQUM1RCxNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2pDLElBQUksQ0FBQyxLQUFLLEVBQUU7UUFDVixPQUFPLFNBQVMsQ0FBQztLQUNsQjtJQUVELE1BQU0sQ0FBQyxFQUFFLElBQUksRUFBRSxTQUFTLENBQUMsR0FBRyxLQUFLLENBQUM7SUFFbEMsSUFBSSxJQUFJLEtBQUssUUFBUSxFQUFFO1FBQ3JCLE9BQU8sS0FBSyxDQUFDO0tBQ2Q7SUFFRCxJQUFJLElBQUksS0FBSyxNQUFNLElBQUksSUFBSSxLQUFLLEtBQUssRUFBRTtRQUNyQyxPQUFPLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUM7S0FDcEM7SUFFRCxJQUFJLElBQUksS0FBSyxPQUFPLEVBQUU7UUFDcEIsT0FBTyxPQUFPLENBQUM7S0FDaEI7SUFFRCxJQUFJLElBQUksS0FBSyxLQUFLLEVBQUU7UUFDbEIsT0FBTyxvQkFBb0IsU0FBUyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUM7S0FDckQ7SUFFRCxNQUFNLElBQUksS0FBSyxDQUFDLG1CQUFtQixJQUFJLEVBQUUsQ0FBQyxDQUFDO0FBQzdDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIEhhc2hpQ29ycCwgSW5jXG4vLyBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogTVBMLTIuMFxuaW1wb3J0IHsgQ29kZU1ha2VyLCB0b0NhbWVsQ2FzZSB9IGZyb20gXCJjb2RlbWFrZXJcIjtcbmltcG9ydCB7IEF0dHJpYnV0ZU1vZGVsIH0gZnJvbSBcIi4vbW9kZWxzXCI7XG5pbXBvcnQgeyBzYW5pdGl6ZWRDb21tZW50IH0gZnJvbSBcIi4vc2FuaXRpemVkLWNvbW1lbnRzXCI7XG5pbXBvcnQgeyBDb25zdHJ1Y3RzTWFrZXJNb2R1bGVUYXJnZXQgfSBmcm9tIFwiQGNka3RmL2NvbW1vbnNcIjtcblxuZXhwb3J0IGNsYXNzIE1vZHVsZUdlbmVyYXRvciB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcmVhZG9ubHkgY29kZTogQ29kZU1ha2VyLFxuICAgIHByaXZhdGUgcmVhZG9ubHkgdGFyZ2V0czogQ29uc3RydWN0c01ha2VyTW9kdWxlVGFyZ2V0W11cbiAgKSB7XG4gICAgdGhpcy5jb2RlLmluZGVudGF0aW9uID0gMjtcblxuICAgIGZvciAoY29uc3QgdGFyZ2V0IG9mIHRoaXMudGFyZ2V0cykge1xuICAgICAgdGhpcy5lbWl0U3VibW9kdWxlKHRhcmdldCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBlbWl0U3VibW9kdWxlKHRhcmdldDogQ29uc3RydWN0c01ha2VyTW9kdWxlVGFyZ2V0KSB7XG4gICAgY29uc3Qgc3BlYyA9IHRhcmdldC5zcGVjO1xuXG4gICAgaWYgKCFzcGVjKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYG1pc3Npbmcgc3BlYyBmb3IgJHt0YXJnZXQuZnFufWApO1xuICAgIH1cblxuICAgIHRoaXMuY29kZS5vcGVuRmlsZSh0YXJnZXQuZmlsZU5hbWUpO1xuXG4gICAgdGhpcy5jb2RlLmxpbmUoYC8vIGdlbmVyYXRlZCBieSBjZGt0ZiBnZXRgKTtcbiAgICB0aGlzLmNvZGUubGluZShgLy8gJHt0YXJnZXQuc291cmNlfWApO1xuXG4gICAgdGhpcy5jb2RlLmxpbmUoXG4gICAgICBgaW1wb3J0IHsgVGVycmFmb3JtTW9kdWxlLCBUZXJyYWZvcm1Nb2R1bGVVc2VyQ29uZmlnIH0gZnJvbSAnY2RrdGYnO2BcbiAgICApO1xuICAgIHRoaXMuY29kZS5saW5lKGBpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztgKTtcblxuICAgIGNvbnN0IGJhc2VOYW1lID0gdGhpcy5jb2RlLnRvUGFzY2FsQ2FzZSh0YXJnZXQubmFtZS5yZXBsYWNlKC9bLS8uXS9nLCBcIl9cIikpO1xuICAgIGNvbnN0IGNvbmZpZ1R5cGUgPSBgJHtiYXNlTmFtZX1Db25maWdgO1xuXG4gICAgdGhpcy5jb2RlLm9wZW5CbG9jayhcbiAgICAgIGBleHBvcnQgaW50ZXJmYWNlICR7Y29uZmlnVHlwZX0gZXh0ZW5kcyBUZXJyYWZvcm1Nb2R1bGVVc2VyQ29uZmlnYFxuICAgICk7XG4gICAgZm9yIChjb25zdCBpbnB1dCBvZiBzcGVjLmlucHV0cykge1xuICAgICAgY29uc3Qgb3B0aW9uYWwgPSBpbnB1dC5yZXF1aXJlZCAmJiBpbnB1dC5kZWZhdWx0ID09PSB1bmRlZmluZWQgPyBcIlwiIDogXCI/XCI7XG5cbiAgICAgIGNvbnN0IGNvbW1lbnQgPSBzYW5pdGl6ZWRDb21tZW50KHRoaXMuY29kZSk7XG4gICAgICBpZiAoaW5wdXQuZGVzY3JpcHRpb24pIHtcbiAgICAgICAgY29tbWVudC5saW5lKGlucHV0LmRlc2NyaXB0aW9uKTtcbiAgICAgIH1cbiAgICAgIGlmIChpbnB1dC5kZWZhdWx0KSB7XG4gICAgICAgIGNvbW1lbnQubGluZShpbnB1dC5kZWZhdWx0KTtcbiAgICAgIH1cbiAgICAgIGlmIChpbnB1dC50eXBlLmluY2x1ZGVzKFwibWFwKFwiKSkge1xuICAgICAgICBjb21tZW50LmxpbmUoXG4gICAgICAgICAgYFRoZSBwcm9wZXJ0eSB0eXBlIGNvbnRhaW5zIGEgbWFwLCB0aGV5IGhhdmUgc3BlY2lhbCBoYW5kbGluZywgcGxlYXNlIHNlZSB7QGxpbmsgY2RrLnRmL21vZHVsZS1tYXAtaW5wdXRzIHRoZSBkb2NzfWBcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIGNvbW1lbnQuZW5kKCk7XG5cbiAgICAgIHRoaXMuY29kZS5saW5lKFxuICAgICAgICBgcmVhZG9ubHkgJHtBdHRyaWJ1dGVNb2RlbC5lc2NhcGVOYW1lKFxuICAgICAgICAgIHRvQ2FtZWxDYXNlKGlucHV0Lm5hbWUpXG4gICAgICAgICl9JHtvcHRpb25hbH06ICR7cGFyc2VUeXBlKGlucHV0LnR5cGUpfTtgXG4gICAgICApO1xuICAgIH1cbiAgICB0aGlzLmNvZGUuY2xvc2VCbG9jaygpO1xuXG4gICAgLy8gQWRkIGEgbGluayB0byB0aGUgVGVycmFmb3JtIFJlZ2lzdHJ5IGlmIGl0IGlzIHNvdXJjZWQgZnJvbSB0aGVyZVxuICAgIC8vIGh0dHBzOi8vZGV2ZWxvcGVyLmhhc2hpY29ycC5jb20vdGVycmFmb3JtL2xhbmd1YWdlL21vZHVsZXMvc291cmNlc1xuICAgIC8vIFJlZ2lzdHJ5IG1vZHVsZXMgYXJlIHJlZmVycmVkIHRvIGFzIDxOQU1FU1BBQ0U+LzxOQU1FPi88UFJPVklERVI+XG4gICAgLy8gT3RoZXIgc291cmNlcyBjb250YWluIGRvdHMsIGUuZy5cbiAgICAvLyBhcHAudGVycmFmb3JtLmlvL2V4YW1wbGUtY29ycC9rOHMtY2x1c3Rlci9henVyZXJtIChwcml2YXRlIHJlZ2lzdHJpZXMpXG4gICAgLy8gZ2l0aHViLmNvbS9oYXNoaWNvcnAvZXhhbXBsZSAoR2l0aHViKVxuICAgIC8vIGdpdEBnaXRodWIuY29tOmhhc2hpY29ycC9leGFtcGxlLmdpdFxuICAgIC8vIGJpdGJ1Y2tldC5vcmcvaGFzaGljb3JwL3RlcnJhZm9ybS1jb25zdWwtYXdzIChCaXRidWNrZXQpXG4gICAgLy8gLi4uIGFuZCBtb3JlXG4gICAgLy8gLi4vbW9kdWxlIGFuZCAuL21vZHVsZSAobG9jYWwgcGF0aHMpXG4gICAgY29uc3QgaXNOb25SZWdpc3RyeU1vZHVsZSA9IHRhcmdldC5zb3VyY2UuaW5jbHVkZXMoXCIuXCIpO1xuICAgIGxldCByZWdpc3RyeVBhdGg7XG4gICAgLy8gU3VibW9kdWxlcyBhbHNvIGV4aXN0IChlLmcuIHRlcnJhZm9ybS1hd3MtbW9kdWxlcy92cGMvYXdzLy9tb2R1bGVzL3ZwYy1lbmRwb2ludHMpXG4gICAgLy8gQW5kIGxpbmtpbmcgZGlyZWN0bHkgdG8gdGhlbSBpbiB0aGUgUmVnaXN0cnkgcmVxdWlyZXMgaW5jbHVkaW5nIHRoZSB2ZXJzaW9uXG4gICAgLy8gbGlrZSBlLmcuIGh0dHBzOi8vcmVnaXN0cnkudGVycmFmb3JtLmlvL21vZHVsZXMvdGVycmFmb3JtLWF3cy1tb2R1bGVzL3ZwYy9hd3MvbGF0ZXN0L3N1Ym1vZHVsZXMvdnBjLWVuZHBvaW50c1xuICAgIGlmICh0YXJnZXQuc291cmNlLmluY2x1ZGVzKFwiLy9cIikpIHtcbiAgICAgIHJlZ2lzdHJ5UGF0aCA9IHRhcmdldC5zb3VyY2UucmVwbGFjZShcbiAgICAgICAgXCIvL21vZHVsZXNcIixcbiAgICAgICAgYC8ke3RhcmdldC52ZXJzaW9uIHx8IFwibGF0ZXN0XCJ9L3N1Ym1vZHVsZXNgXG4gICAgICApO1xuICAgICAgLy8gdGVycmFmb3JtLWF3cy1tb2R1bGVzL3ZwYy9hd3MvL21vZHVsZXMvdnBjLWVuZHBvaW50c1xuICAgICAgLy8gLT5cbiAgICAgIC8vIHRlcnJhZm9ybS1hd3MtbW9kdWxlcy92cGMvYXdzL2xhdGVzdC9zdWJtb2R1bGVzL3ZwYy1lbmRwb2ludHNcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gbm90IHN1Ym1vZHVsZSBzcGVjaWZpZWQsIGp1c3QgYXBwZW5kIHRoZSB2ZXJzaW9uXG4gICAgICByZWdpc3RyeVBhdGggPSBgJHt0YXJnZXQuc291cmNlfS8ke3RhcmdldC52ZXJzaW9uIHx8IFwibGF0ZXN0XCJ9YDtcbiAgICB9XG5cbiAgICBjb25zdCBjb21tZW50ID0gc2FuaXRpemVkQ29tbWVudCh0aGlzLmNvZGUpO1xuICAgIGNvbW1lbnQubGluZShgRGVmaW5lcyBhbiAke2Jhc2VOYW1lfSBiYXNlZCBvbiBhIFRlcnJhZm9ybSBtb2R1bGVgKTtcbiAgICBjb21tZW50LmxpbmUoYGApO1xuICAgIGNvbW1lbnQubGluZShcbiAgICAgIGlzTm9uUmVnaXN0cnlNb2R1bGVcbiAgICAgICAgPyBgU291cmNlIGF0ICR7dGFyZ2V0LnNvdXJjZX1gXG4gICAgICAgIDogYERvY3MgYXQgVGVycmFmb3JtIFJlZ2lzdHJ5OiB7QGxpbmsgaHR0cHM6Ly9yZWdpc3RyeS50ZXJyYWZvcm0uaW8vbW9kdWxlcy8ke3JlZ2lzdHJ5UGF0aH0gJHt0YXJnZXQuc291cmNlfX1gXG4gICAgKTtcbiAgICBjb21tZW50LmVuZCgpO1xuICAgIHRoaXMuY29kZS5vcGVuQmxvY2soYGV4cG9ydCBjbGFzcyAke2Jhc2VOYW1lfSBleHRlbmRzIFRlcnJhZm9ybU1vZHVsZWApO1xuXG4gICAgdGhpcy5jb2RlLmxpbmUoYHByaXZhdGUgcmVhZG9ubHkgaW5wdXRzOiB7IFtuYW1lOiBzdHJpbmddOiBhbnkgfSA9IHsgfWApO1xuXG4gICAgY29uc3QgYWxsT3B0aW9uYWwgPSBzcGVjLmlucHV0cy5maW5kKCh4KSA9PiB4LnJlcXVpcmVkKSA/IFwiXCIgOiBcIiA9IHt9XCI7XG5cbiAgICB0aGlzLmNvZGUub3BlbihcbiAgICAgIGBwdWJsaWMgY29uc3RydWN0b3Ioc2NvcGU6IENvbnN0cnVjdCwgaWQ6IHN0cmluZywgY29uZmlnOiAke2NvbmZpZ1R5cGV9JHthbGxPcHRpb25hbH0pIHtgXG4gICAgKTtcbiAgICB0aGlzLmNvZGUub3Blbihgc3VwZXIoc2NvcGUsIGlkLCB7YCk7XG4gICAgdGhpcy5jb2RlLmxpbmUoXCIuLi5jb25maWcsXCIpO1xuICAgIHRoaXMuY29kZS5saW5lKGBzb3VyY2U6ICcke3RhcmdldC5zb3VyY2V9JyxgKTtcbiAgICBpZiAodGFyZ2V0LnZlcnNpb24pIHtcbiAgICAgIHRoaXMuY29kZS5saW5lKGB2ZXJzaW9uOiAnJHt0YXJnZXQudmVyc2lvbn0nLGApO1xuICAgIH1cbiAgICB0aGlzLmNvZGUuY2xvc2UoYH0pO2ApO1xuXG4gICAgZm9yIChjb25zdCBpbnB1dCBvZiBzcGVjLmlucHV0cykge1xuICAgICAgY29uc3QgaW5wdXROYW1lID0gQXR0cmlidXRlTW9kZWwuZXNjYXBlTmFtZSh0b0NhbWVsQ2FzZShpbnB1dC5uYW1lKSk7XG4gICAgICB0aGlzLmNvZGUubGluZShgdGhpcy4ke2lucHV0TmFtZX0gPSBjb25maWcuJHtpbnB1dE5hbWV9O2ApO1xuICAgIH1cblxuICAgIHRoaXMuY29kZS5jbG9zZShgfWApOyAvLyBjdG9yXG5cbiAgICBmb3IgKGNvbnN0IGlucHV0IG9mIHNwZWMuaW5wdXRzKSB7XG4gICAgICBjb25zdCBpbnB1dE5hbWUgPSBBdHRyaWJ1dGVNb2RlbC5lc2NhcGVOYW1lKHRvQ2FtZWxDYXNlKGlucHV0Lm5hbWUpKTtcbiAgICAgIGNvbnN0IGlucHV0VHlwZSA9XG4gICAgICAgIHBhcnNlVHlwZShpbnB1dC50eXBlKSArXG4gICAgICAgIChpbnB1dC5yZXF1aXJlZCAmJiBpbnB1dC5kZWZhdWx0ID09PSB1bmRlZmluZWQgPyBcIlwiIDogXCIgfCB1bmRlZmluZWRcIik7XG4gICAgICB0aGlzLmNvZGUub3BlbkJsb2NrKGBwdWJsaWMgZ2V0ICR7aW5wdXROYW1lfSgpOiAke2lucHV0VHlwZX1gKTtcbiAgICAgIHRoaXMuY29kZS5saW5lKGByZXR1cm4gdGhpcy5pbnB1dHNbJyR7aW5wdXQubmFtZX0nXSBhcyAke2lucHV0VHlwZX07YCk7XG4gICAgICB0aGlzLmNvZGUuY2xvc2VCbG9jaygpO1xuXG4gICAgICB0aGlzLmNvZGUub3BlbkJsb2NrKGBwdWJsaWMgc2V0ICR7aW5wdXROYW1lfSh2YWx1ZTogJHtpbnB1dFR5cGV9KWApO1xuICAgICAgdGhpcy5jb2RlLmxpbmUoYHRoaXMuaW5wdXRzWycke2lucHV0Lm5hbWV9J10gPSB2YWx1ZTtgKTtcbiAgICAgIHRoaXMuY29kZS5jbG9zZUJsb2NrKCk7XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBvdXRwdXQgb2Ygc3BlYy5vdXRwdXRzKSB7XG4gICAgICBjb25zdCBvdXRwdXROYW1lID0gdG9DYW1lbENhc2Uob3V0cHV0Lm5hbWUpO1xuICAgICAgdGhpcy5jb2RlLm9wZW5CbG9jayhgcHVibGljIGdldCAke291dHB1dE5hbWV9T3V0cHV0KClgKTtcbiAgICAgIHRoaXMuY29kZS5saW5lKGByZXR1cm4gdGhpcy5nZXRTdHJpbmcoJyR7b3V0cHV0Lm5hbWV9JylgKTtcbiAgICAgIHRoaXMuY29kZS5jbG9zZUJsb2NrKCk7XG4gICAgfVxuXG4gICAgdGhpcy5jb2RlLm9wZW5CbG9jayhgcHJvdGVjdGVkIHN5bnRoZXNpemVBdHRyaWJ1dGVzKClgKTtcbiAgICB0aGlzLmNvZGUubGluZShgcmV0dXJuIHRoaXMuaW5wdXRzO2ApO1xuICAgIHRoaXMuY29kZS5jbG9zZUJsb2NrKCk7XG5cbiAgICB0aGlzLmNvZGUub3BlbkJsb2NrKFxuICAgICAgYHByb3RlY3RlZCBzeW50aGVzaXplSGNsQXR0cmlidXRlcygpOiB7IFtuYW1lOiBzdHJpbmddOiBhbnkgfWBcbiAgICApO1xuICAgIHRoaXMuY29kZS5saW5lKGByZXR1cm4gT2JqZWN0LmZyb21FbnRyaWVzKGApO1xuICAgIHRoaXMuY29kZS5saW5lKGAgIE9iamVjdC5lbnRyaWVzKHRoaXMuaW5wdXRzKWApO1xuICAgIHRoaXMuY29kZS5saW5lKGAgICAgLmZpbHRlcigoWywgdmFsXSkgPT4gdmFsICE9PSB1bmRlZmluZWQpYCk7XG4gICAgdGhpcy5jb2RlLmxpbmUoYCAgICAubWFwKChba2V5LCB2YWxdKSA9PiB7YCk7XG4gICAgdGhpcy5jb2RlLmxpbmUoYCAgICAgIHJldHVybiBbYCk7XG4gICAgdGhpcy5jb2RlLmxpbmUoYCAgICAgICAga2V5LGApO1xuICAgIHRoaXMuY29kZS5saW5lKGAgICAgICAgIHtgKTtcbiAgICB0aGlzLmNvZGUubGluZShgICAgICAgICAgIHZhbHVlOiB2YWwsYCk7XG4gICAgdGhpcy5jb2RlLmxpbmUoYCAgICAgICAgICB0eXBlOiBcImFueVwiLGApO1xuICAgIHRoaXMuY29kZS5saW5lKGAgICAgICAgIH0sYCk7XG4gICAgdGhpcy5jb2RlLmxpbmUoYCAgICAgIF07YCk7XG4gICAgdGhpcy5jb2RlLmxpbmUoYCAgICB9KWApO1xuICAgIHRoaXMuY29kZS5saW5lKGApO2ApO1xuICAgIHRoaXMuY29kZS5jbG9zZUJsb2NrKCk7XG5cbiAgICB0aGlzLmNvZGUuY2xvc2VCbG9jaygpOyAvLyBjbGFzc1xuICAgIHRoaXMuY29kZS5jbG9zZUZpbGUodGFyZ2V0LmZpbGVOYW1lKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBwYXJzZVR5cGUodHlwZTogc3RyaW5nKSB7XG4gIGlmICh0eXBlID09PSBcInN0cmluZ1wiKSB7XG4gICAgcmV0dXJuIFwic3RyaW5nXCI7XG4gIH1cbiAgaWYgKHR5cGUgPT09IFwibnVtYmVyXCIpIHtcbiAgICByZXR1cm4gXCJudW1iZXJcIjtcbiAgfVxuICBpZiAodHlwZSA9PT0gXCJib29sXCIpIHtcbiAgICByZXR1cm4gXCJib29sZWFuXCI7XG4gIH1cbiAgaWYgKHR5cGUgPT09IFwibGlzdFwiKSB7XG4gICAgcmV0dXJuIFwic3RyaW5nW11cIjtcbiAgfVxuICBpZiAodHlwZSA9PT0gXCJtYXBcIikge1xuICAgIHJldHVybiBcInsgW2tleTogc3RyaW5nXTogc3RyaW5nIH1cIjtcbiAgfVxuICBpZiAodHlwZSA9PT0gXCJ0dXBsZVwiKSB7XG4gICAgcmV0dXJuIFwic3RyaW5nW11cIjtcbiAgfVxuICBpZiAodHlwZSA9PT0gXCJhbnlcIikge1xuICAgIHJldHVybiBcImFueVwiO1xuICB9XG5cbiAgY29uc3QgY29tcGxleFR5cGUgPSBwYXJzZUNvbXBsZXhUeXBlKHR5cGUpO1xuICBpZiAoY29tcGxleFR5cGUpIHtcbiAgICByZXR1cm4gY29tcGxleFR5cGU7XG4gIH1cblxuICB0aHJvdyBuZXcgRXJyb3IoYHVua25vd24gdHlwZSAke3R5cGV9YCk7XG59XG5cbmZ1bmN0aW9uIHBhcnNlQ29tcGxleFR5cGUodHlwZTogc3RyaW5nKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgY29uc3QgY29tcGxleCA9IC9eKG9iamVjdHxsaXN0fG1hcHxzZXR8dHVwbGUpXFwoKFtcXHNcXFNdKylcXCkvO1xuICBjb25zdCBtYXRjaCA9IGNvbXBsZXguZXhlYyh0eXBlKTtcbiAgaWYgKCFtYXRjaCkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBjb25zdCBbLCBraW5kLCBpbm5lclR5cGVdID0gbWF0Y2g7XG5cbiAgaWYgKGtpbmQgPT09IFwib2JqZWN0XCIpIHtcbiAgICByZXR1cm4gYGFueWA7XG4gIH1cblxuICBpZiAoa2luZCA9PT0gXCJsaXN0XCIgfHwga2luZCA9PT0gXCJzZXRcIikge1xuICAgIHJldHVybiBgJHtwYXJzZVR5cGUoaW5uZXJUeXBlKX1bXWA7XG4gIH1cblxuICBpZiAoa2luZCA9PT0gXCJ0dXBsZVwiKSB7XG4gICAgcmV0dXJuIGBhbnlbXWA7XG4gIH1cblxuICBpZiAoa2luZCA9PT0gXCJtYXBcIikge1xuICAgIHJldHVybiBgeyBba2V5OiBzdHJpbmddOiAke3BhcnNlVHlwZShpbm5lclR5cGUpfSB9YDtcbiAgfVxuXG4gIHRocm93IG5ldyBFcnJvcihgdW5leHBlY3RlZCBraW5kICR7a2luZH1gKTtcbn1cbiJdfQ==