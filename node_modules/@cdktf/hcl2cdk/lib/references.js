"use strict";
/**
 * Copyright (c) HashiCorp, Inc.
 * SPDX-License-Identifier: MPL-2.0
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.findUsedReferences = exports.extractReferencesFromExpression = exports.containsReference = exports.referenceToVariableName = void 0;
const hcl2json_1 = require("@cdktf/hcl2json");
const utils_1 = require("./utils");
const variables_1 = require("./variables");
function referenceToVariableName(scope, ref) {
    const parts = ref.referencee.id.split(".");
    const resource = parts[0] === "data" ? `${parts[0]}.${parts[1]}` : parts[0];
    const name = parts[0] === "data" ? parts[2] : parts[1];
    return (0, variables_1.variableName)(scope, resource, name);
}
exports.referenceToVariableName = referenceToVariableName;
function containsReference(expression) {
    if (!hcl2json_1.TFExpressionSyntaxTree.isScopeTraversalExpression(expression)) {
        return false;
    }
    const segments = expression.meta.traversal;
    const rootSegment = segments[0].segment;
    const fullAccessor = expression.meta.fullAccessor;
    if (rootSegment === "count" || // count variable
        rootSegment === "each" || // each variable
        // https://www.terraform.io/docs/language/expressions/references.html#filesystem-and-workspace-info
        fullAccessor.startsWith("path.module") ||
        fullAccessor.startsWith("path.root") ||
        fullAccessor.startsWith("path.cwd") ||
        fullAccessor.startsWith("terraform.workspace") ||
        fullAccessor.startsWith("self.") // block local value
    ) {
        utils_1.logger.debug(`skipping ${fullAccessor}`);
        return false;
    }
    return true;
}
exports.containsReference = containsReference;
async function extractReferencesFromExpression(input, nodeIds, scopedIds = [] // dynamics introduce new scoped variables that are not the globally accessible ids
) {
    utils_1.logger.debug(`extractReferencesFromExpression(${input})`);
    const possibleVariableSpots = await (0, hcl2json_1.getReferencesInExpression)("main.tf", input);
    utils_1.logger.debug(`found possible variable spots: ${JSON.stringify(possibleVariableSpots)}`);
    return possibleVariableSpots.reduce((carry, spot) => {
        const { value, startPosition, endPosition } = spot;
        // no reference
        if (!value.includes(".") || // just a literal
            value.startsWith(".") || // dangling property access
            value.endsWith("...") || // spread (likely in for loop)
            value.startsWith("count.") || // count variable
            value.startsWith("each.") || // each variable
            // https://www.terraform.io/docs/language/expressions/references.html#filesystem-and-workspace-info
            value.startsWith("path.module") ||
            value.startsWith("path.root") ||
            value.startsWith("path.cwd") ||
            value.startsWith("terraform.workspace") ||
            value.startsWith("self.") // block local value
        ) {
            utils_1.logger.debug(`skipping ${value}`);
            return carry;
        }
        const referenceParts = value.split(".");
        utils_1.logger.debug(`Searching for node id '${value}' in ${JSON.stringify(nodeIds)}`);
        const corespondingNodeId = [...nodeIds, ...scopedIds].find((id) => {
            const parts = id.split(".");
            const matchesFirst = parts[0] === referenceParts[0];
            const matchesFirstTwo = matchesFirst &&
                (parts[1] === referenceParts[1] || referenceParts.length === 1);
            return (matchesFirstTwo &&
                (parts[0] === "data" ? parts[2] === referenceParts[2] : true));
        });
        if (!corespondingNodeId) {
            // This is most likely a false positive, so we just ignore it
            // We include the log below to help debugging
            utils_1.logger.error(`Found a reference that is unknown: ${input} has reference "${value}".The id was not found in ${JSON.stringify(nodeIds)} with temporary values ${JSON.stringify(scopedIds)}.
${utils_1.leaveCommentText}`);
            return carry;
        }
        if (scopedIds.includes(corespondingNodeId)) {
            utils_1.logger.debug(`skipping '${value}' since it's a scoped variable`);
            return carry;
        }
        utils_1.logger.debug(`Found node id '${corespondingNodeId}'`);
        const spotParts = value.split(".");
        let isThereANumericAccessor = false;
        const referenceSpotParts = spotParts.filter((part) => {
            if (!Number.isNaN(parseInt(part, 10))) {
                isThereANumericAccessor = true;
                return false;
            }
            return !isThereANumericAccessor;
        });
        const fullReference = isThereANumericAccessor
            ? referenceSpotParts.slice(0, 2).join(".")
            : value;
        const isVariable = value.startsWith("var.");
        const useFqn = 
        // Can not use FQN on vars
        !isVariable &&
            // Can not use FQN on locals
            !value.startsWith("local.") &&
            // If the following character is
            (input.substr(endPosition + 1, 1) === "*" || // a * (splat) we need to use the FQN
                input.substr(endPosition, 1) === "[" || // a property access
                isThereANumericAccessor); // a numeric access
        const ref = {
            start: startPosition,
            end: endPosition,
            referencee: {
                id: corespondingNodeId,
                full: fullReference,
            },
            useFqn,
            isVariable,
        };
        utils_1.logger.debug(`Found reference ${JSON.stringify(ref)}`);
        return [...carry, ref];
    }, []);
}
exports.extractReferencesFromExpression = extractReferencesFromExpression;
async function findUsedReferences(nodeIds, item) {
    utils_1.logger.debug(`findUsedReferences(${nodeIds}, ${item})`);
    if (typeof item === "string") {
        return await extractReferencesFromExpression(item, nodeIds, []);
    }
    if (typeof item !== "object" || item === null || item === undefined) {
        return [];
    }
    if (Array.isArray(item)) {
        return (await Promise.all(item.map((i) => findUsedReferences(nodeIds, i)))).flat();
    }
    if (item && "dynamic" in item) {
        const dyn = item["dynamic"];
        const { for_each, ...others } = dyn;
        const dynamicRef = Object.keys(others)[0];
        return await findUsedReferences([...nodeIds, dynamicRef], dyn);
    }
    return (await Promise.all(Object.values(item).map((i) => findUsedReferences(nodeIds, i)))).flat();
}
exports.findUsedReferences = findUsedReferences;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVmZXJlbmNlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInJlZmVyZW5jZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7R0FHRzs7O0FBRUgsOENBR3lCO0FBQ3pCLG1DQUFtRDtBQUVuRCwyQ0FBMkM7QUFFM0MsU0FBZ0IsdUJBQXVCLENBQ3JDLEtBQW1CLEVBQ25CLEdBQWM7SUFFZCxNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsVUFBVSxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDM0MsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQyxLQUFLLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUM1RSxNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssTUFBTSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN2RCxPQUFPLElBQUEsd0JBQVksRUFBQyxLQUFLLEVBQUUsUUFBUSxFQUFFLElBQUksQ0FBQyxDQUFDO0FBQzdDLENBQUM7QUFSRCwwREFRQztBQUVELFNBQWdCLGlCQUFpQixDQUFDLFVBQThCO0lBQzlELElBQUksQ0FBQyxpQ0FBRyxDQUFDLDBCQUEwQixDQUFDLFVBQVUsQ0FBQyxFQUFFO1FBQy9DLE9BQU8sS0FBSyxDQUFDO0tBQ2Q7SUFFRCxNQUFNLFFBQVEsR0FBRyxVQUFVLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUMzQyxNQUFNLFdBQVcsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDO0lBQ3hDLE1BQU0sWUFBWSxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMs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Q0FBQyxDQUFDLEVBQUUsRUFBRSxDQUNuRCxrQkFBa0IsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQy9CLENBQ0YsQ0FDRixDQUFDLElBQUksRUFBRSxDQUFDO0FBQ1gsQ0FBQztBQWpDRCxnREFpQ0MiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAoYykgSGFzaGlDb3JwLCBJbmMuXG4gKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogTVBMLTIuMFxuICovXG5cbmltcG9ydCB7XG4gIGdldFJlZmVyZW5jZXNJbkV4cHJlc3Npb24sXG4gIFRGRXhwcmVzc2lvblN5bnRheFRyZWUgYXMgdGV4LFxufSBmcm9tIFwiQGNka3RmL2hjbDJqc29uXCI7XG5pbXBvcnQgeyBsZWF2ZUNvbW1lbnRUZXh0LCBsb2dnZXIgfSBmcm9tIFwiLi91dGlsc1wiO1xuaW1wb3J0IHsgUHJvZ3JhbVNjb3BlLCBSZWZlcmVuY2UsIFRlcnJhZm9ybVJlc291cmNlQmxvY2sgfSBmcm9tIFwiLi90eXBlc1wiO1xuaW1wb3J0IHsgdmFyaWFibGVOYW1lIH0gZnJvbSBcIi4vdmFyaWFibGVzXCI7XG5cbmV4cG9ydCBmdW5jdGlvbiByZWZlcmVuY2VUb1ZhcmlhYmxlTmFtZShcbiAgc2NvcGU6IFByb2dyYW1TY29wZSxcbiAgcmVmOiBSZWZlcmVuY2Vcbik6IHN0cmluZyB7XG4gIGNvbnN0IHBhcnRzID0gcmVmLnJlZmVyZW5jZWUuaWQuc3BsaXQoXCIuXCIpO1xuICBjb25zdCByZXNvdXJjZSA9IHBhcnRzWzBdID09PSBcImRhdGFcIiA/IGAke3BhcnRzWzBdfS4ke3BhcnRzWzFdfWAgOiBwYXJ0c1swXTtcbiAgY29uc3QgbmFtZSA9IHBhcnRzWzBdID09PSBcImRhdGFcIiA/IHBhcnRzWzJdIDogcGFydHNbMV07XG4gIHJldHVybiB2YXJpYWJsZU5hbWUoc2NvcGUsIHJlc291cmNlLCBuYW1lKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNvbnRhaW5zUmVmZXJlbmNlKGV4cHJlc3Npb246IHRleC5FeHByZXNzaW9uVHlwZSkge1xuICBpZiAoIXRleC5pc1Njb3BlVHJhdmVyc2FsRXhwcmVzc2lvbihleHByZXNzaW9uKSkge1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGNvbnN0IHNlZ21lbnRzID0gZXhwcmVzc2lvbi5tZXRhLnRyYXZlcnNhbDtcbiAgY29uc3Qgcm9vdFNlZ21lbnQgPSBzZWdtZW50c1swXS5zZWdtZW50O1xuICBjb25zdCBmdWxsQWNjZXNzb3IgPSBleHByZXNzaW9uLm1ldGEuZnVsbEFjY2Vzc29yO1xuXG4gIGlmIChcbiAgICByb290U2VnbWVudCA9PT0gXCJjb3VudFwiIHx8IC8vIGNvdW50IHZhcmlhYmxlXG4gICAgcm9vdFNlZ21lbnQgPT09IFwiZWFjaFwiIHx8IC8vIGVhY2ggdmFyaWFibGVcbiAgICAvLyBodHRwczovL3d3dy50ZXJyYWZvcm0uaW8vZG9jcy9sYW5ndWFnZS9leHByZXNzaW9ucy9yZWZlcmVuY2VzLmh0bWwjZmlsZXN5c3RlbS1hbmQtd29ya3NwYWNlLWluZm9cbiAgICBmdWxsQWNjZXNzb3Iuc3RhcnRzV2l0aChcInBhdGgubW9kdWxlXCIpIHx8XG4gICAgZnVsbEFjY2Vzc29yLnN0YXJ0c1dpdGgoXCJwYXRoLnJvb3RcIikgfHxcbiAgICBmdWxsQWNjZXNzb3Iuc3RhcnRzV2l0aChcInBhdGguY3dkXCIpIHx8XG4gICAgZnVsbEFjY2Vzc29yLnN0YXJ0c1dpdGgoXCJ0ZXJyYWZvcm0ud29ya3NwYWNlXCIpIHx8XG4gICAgZnVsbEFjY2Vzc29yLnN0YXJ0c1dpdGgoXCJzZWxmLlwiKSAvLyBibG9jayBsb2NhbCB2YWx1ZVxuICApIHtcbiAgICBsb2dnZXIuZGVidWcoYHNraXBwaW5nICR7ZnVsbEFjY2Vzc29yfWApO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHJldHVybiB0cnVlO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZXh0cmFjdFJlZmVyZW5jZXNGcm9tRXhwcmVzc2lvbihcbiAgaW5wdXQ6IHN0cmluZyxcbiAgbm9kZUlkczogcmVhZG9ubHkgc3RyaW5nW10sXG4gIHNjb3BlZElkczogcmVhZG9ubHkgc3RyaW5nW10gPSBbXSAvLyBkeW5hbWljcyBpbnRyb2R1Y2UgbmV3IHNjb3BlZCB2YXJpYWJsZXMgdGhhdCBhcmUgbm90IHRoZSBnbG9iYWxseSBhY2Nlc3NpYmxlIGlkc1xuKTogUHJvbWlzZTxSZWZlcmVuY2VbXT4ge1xuICBsb2dnZXIuZGVidWcoYGV4dHJhY3RSZWZlcmVuY2VzRnJvbUV4cHJlc3Npb24oJHtpbnB1dH0pYCk7XG4gIGNvbnN0IHBvc3NpYmxlVmFyaWFibGVTcG90cyA9IGF3YWl0IGdldFJlZmVyZW5jZXNJbkV4cHJlc3Npb24oXG4gICAgXCJtYWluLnRmXCIsXG4gICAgaW5wdXRcbiAgKTtcblxuICBsb2dnZXIuZGVidWcoXG4gICAgYGZvdW5kIHBvc3NpYmxlIHZhcmlhYmxlIHNwb3RzOiAke0pTT04uc3RyaW5naWZ5KHBvc3NpYmxlVmFyaWFibGVTcG90cyl9YFxuICApO1xuXG4gIHJldHVybiBwb3NzaWJsZVZhcmlhYmxlU3BvdHMucmVkdWNlKChjYXJyeSwgc3BvdCkgPT4ge1xuICAgIGNvbnN0IHsgdmFsdWUsIHN0YXJ0UG9zaXRpb24sIGVuZFBvc2l0aW9uIH0gPSBzcG90O1xuICAgIC8vIG5vIHJlZmVyZW5jZVxuICAgIGlmIChcbiAgICAgICF2YWx1ZS5pbmNsdWRlcyhcIi5cIikgfHwgLy8ganVzdCBhIGxpdGVyYWxcbiAgICAgIHZhbHVlLnN0YXJ0c1dpdGgoXCIuXCIpIHx8IC8vIGRhbmdsaW5nIHByb3BlcnR5IGFjY2Vzc1xuICAgICAgdmFsdWUuZW5kc1dpdGgoXCIuLi5cIikgfHwgLy8gc3ByZWFkIChsaWtlbHkgaW4gZm9yIGxvb3ApXG4gICAgICB2YWx1ZS5zdGFydHNXaXRoKFwiY291bnQuXCIpIHx8IC8vIGNvdW50IHZhcmlhYmxlXG4gICAgICB2YWx1ZS5zdGFydHNXaXRoKFwiZWFjaC5cIikgfHwgLy8gZWFjaCB2YXJpYWJsZVxuICAgICAgLy8gaHR0cHM6Ly93d3cudGVycmFmb3JtLmlvL2RvY3MvbGFuZ3VhZ2UvZXhwcmVzc2lvbnMvcmVmZXJlbmNlcy5odG1sI2ZpbGVzeXN0ZW0tYW5kLXdvcmtzcGFjZS1pbmZvXG4gICAgICB2YWx1ZS5zdGFydHNXaXRoKFwicGF0aC5tb2R1bGVcIikgfHxcbiAgICAgIHZhbHVlLnN0YXJ0c1dpdGgoXCJwYXRoLnJvb3RcIikgfHxcbiAgICAgIHZhbHVlLnN0YXJ0c1dpdGgoXCJwYXRoLmN3ZFwiKSB8fFxuICAgICAgdmFsdWUuc3RhcnRzV2l0aChcInRlcnJhZm9ybS53b3Jrc3BhY2VcIikgfHxcbiAgICAgIHZhbHVlLnN0YXJ0c1dpdGgoXCJzZWxmLlwiKSAvLyBibG9jayBsb2NhbCB2YWx1ZVxuICAgICkge1xuICAgICAgbG9nZ2VyLmRlYnVnKGBza2lwcGluZyAke3ZhbHVlfWApO1xuICAgICAgcmV0dXJuIGNhcnJ5O1xuICAgIH1cblxuICAgIGNvbnN0IHJlZmVyZW5jZVBhcnRzID0gdmFsdWUuc3BsaXQoXCIuXCIpO1xuXG4gICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgYFNlYXJjaGluZyBmb3Igbm9kZSBpZCAnJHt2YWx1ZX0nIGluICR7SlNPTi5zdHJpbmdpZnkobm9kZUlkcyl9YFxuICAgICk7XG4gICAgY29uc3QgY29yZXNwb25kaW5nTm9kZUlkID0gWy4uLm5vZGVJZHMsIC4uLnNjb3BlZElkc10uZmluZCgoaWQpID0+IHtcbiAgICAgIGNvbnN0IHBhcnRzID0gaWQuc3BsaXQoXCIuXCIpO1xuICAgICAgY29uc3QgbWF0Y2hlc0ZpcnN0ID0gcGFydHNbMF0gPT09IHJlZmVyZW5jZVBhcnRzWzBdO1xuICAgICAgY29uc3QgbWF0Y2hlc0ZpcnN0VHdvID1cbiAgICAgICAgbWF0Y2hlc0ZpcnN0ICYmXG4gICAgICAgIChwYXJ0c1sxXSA9PT0gcmVmZXJlbmNlUGFydHNbMV0gfHwgcmVmZXJlbmNlUGFydHMubGVuZ3RoID09PSAxKTtcblxuICAgICAgcmV0dXJuIChcbiAgICAgICAgbWF0Y2hlc0ZpcnN0VHdvICYmXG4gICAgICAgIChwYXJ0c1swXSA9PT0gXCJkYXRhXCIgPyBwYXJ0c1syXSA9PT0gcmVmZXJlbmNlUGFydHNbMl0gOiB0cnVlKVxuICAgICAgKTtcbiAgICB9KTtcblxuICAgIGlmICghY29yZXNwb25kaW5nTm9kZUlkKSB7XG4gICAgICAvLyBUaGlzIGlzIG1vc3QgbGlrZWx5IGEgZmFsc2UgcG9zaXRpdmUsIHNvIHdlIGp1c3QgaWdub3JlIGl0XG4gICAgICAvLyBXZSBpbmNsdWRlIHRoZSBsb2cgYmVsb3cgdG8gaGVscCBkZWJ1Z2dpbmdcbiAgICAgIGxvZ2dlci5lcnJvcihcbiAgICAgICAgYEZvdW5kIGEgcmVmZXJlbmNlIHRoYXQgaXMgdW5rbm93bjogJHtpbnB1dH0gaGFzIHJlZmVyZW5jZSBcIiR7dmFsdWV9XCIuVGhlIGlkIHdhcyBub3QgZm91bmQgaW4gJHtKU09OLnN0cmluZ2lmeShcbiAgICAgICAgICBub2RlSWRzXG4gICAgICAgICl9IHdpdGggdGVtcG9yYXJ5IHZhbHVlcyAke0pTT04uc3RyaW5naWZ5KHNjb3BlZElkcyl9LlxuJHtsZWF2ZUNvbW1lbnRUZXh0fWBcbiAgICAgICk7XG4gICAgICByZXR1cm4gY2Fycnk7XG4gICAgfVxuXG4gICAgaWYgKHNjb3BlZElkcy5pbmNsdWRlcyhjb3Jlc3BvbmRpbmdOb2RlSWQpKSB7XG4gICAgICBsb2dnZXIuZGVidWcoYHNraXBwaW5nICcke3ZhbHVlfScgc2luY2UgaXQncyBhIHNjb3BlZCB2YXJpYWJsZWApO1xuICAgICAgcmV0dXJuIGNhcnJ5O1xuICAgIH1cbiAgICBsb2dnZXIuZGVidWcoYEZvdW5kIG5vZGUgaWQgJyR7Y29yZXNwb25kaW5nTm9kZUlkfSdgKTtcblxuICAgIGNvbnN0IHNwb3RQYXJ0cyA9IHZhbHVlLnNwbGl0KFwiLlwiKTtcbiAgICBsZXQgaXNUaGVyZUFOdW1lcmljQWNjZXNzb3IgPSBmYWxzZTtcbiAgICBjb25zdCByZWZlcmVuY2VTcG90UGFydHMgPSBzcG90UGFydHMuZmlsdGVyKChwYXJ0KSA9PiB7XG4gICAgICBpZiAoIU51bWJlci5pc05hTihwYXJzZUludChwYXJ0LCAxMCkpKSB7XG4gICAgICAgIGlzVGhlcmVBTnVtZXJpY0FjY2Vzc29yID0gdHJ1ZTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gIWlzVGhlcmVBTnVtZXJpY0FjY2Vzc29yO1xuICAgIH0pO1xuICAgIGNvbnN0IGZ1bGxSZWZlcmVuY2UgPSBpc1RoZXJlQU51bWVyaWNBY2Nlc3NvclxuICAgICAgPyByZWZlcmVuY2VTcG90UGFydHMuc2xpY2UoMCwgMikuam9pbihcIi5cIilcbiAgICAgIDogdmFsdWU7XG5cbiAgICBjb25zdCBpc1ZhcmlhYmxlID0gdmFsdWUuc3RhcnRzV2l0aChcInZhci5cIik7XG4gICAgY29uc3QgdXNlRnFuID1cbiAgICAgIC8vIENhbiBub3QgdXNlIEZRTiBvbiB2YXJzXG4gICAgICAhaXNWYXJpYWJsZSAmJlxuICAgICAgLy8gQ2FuIG5vdCB1c2UgRlFOIG9uIGxvY2Fsc1xuICAgICAgIXZhbHVlLnN0YXJ0c1dpdGgoXCJsb2NhbC5cIikgJiZcbiAgICAgIC8vIElmIHRoZSBmb2xsb3dpbmcgY2hhcmFjdGVyIGlzXG4gICAgICAoaW5wdXQuc3Vic3RyKGVuZFBvc2l0aW9uICsgMSwgMSkgPT09IFwiKlwiIHx8IC8vIGEgKiAoc3BsYXQpIHdlIG5lZWQgdG8gdXNlIHRoZSBGUU5cbiAgICAgICAgaW5wdXQuc3Vic3RyKGVuZFBvc2l0aW9uLCAxKSA9PT0gXCJbXCIgfHwgLy8gYSBwcm9wZXJ0eSBhY2Nlc3NcbiAgICAgICAgaXNUaGVyZUFOdW1lcmljQWNjZXNzb3IpOyAvLyBhIG51bWVyaWMgYWNjZXNzXG5cbiAgICBjb25zdCByZWY6IFJlZmVyZW5jZSA9IHtcbiAgICAgIHN0YXJ0OiBzdGFydFBvc2l0aW9uLFxuICAgICAgZW5kOiBlbmRQb3NpdGlvbixcbiAgICAgIHJlZmVyZW5jZWU6IHtcbiAgICAgICAgaWQ6IGNvcmVzcG9uZGluZ05vZGVJZCxcbiAgICAgICAgZnVsbDogZnVsbFJlZmVyZW5jZSxcbiAgICAgIH0sXG4gICAgICB1c2VGcW4sXG4gICAgICBpc1ZhcmlhYmxlLFxuICAgIH07XG4gICAgbG9nZ2VyLmRlYnVnKGBGb3VuZCByZWZlcmVuY2UgJHtKU09OLnN0cmluZ2lmeShyZWYpfWApO1xuICAgIHJldHVybiBbLi4uY2FycnksIHJlZl07XG4gIH0sIFtdIGFzIFJlZmVyZW5jZVtdKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGZpbmRVc2VkUmVmZXJlbmNlcyhcbiAgbm9kZUlkczogc3RyaW5nW10sXG4gIGl0ZW06IFRlcnJhZm9ybVJlc291cmNlQmxvY2tcbik6IFByb21pc2U8UmVmZXJlbmNlW10+IHtcbiAgbG9nZ2VyLmRlYnVnKGBmaW5kVXNlZFJlZmVyZW5jZXMoJHtub2RlSWRzfSwgJHtpdGVtfSlgKTtcbiAgaWYgKHR5cGVvZiBpdGVtID09PSBcInN0cmluZ1wiKSB7XG4gICAgcmV0dXJuIGF3YWl0IGV4dHJhY3RSZWZlcmVuY2VzRnJvbUV4cHJlc3Npb24oaXRlbSwgbm9kZUlkcywgW10pO1xuICB9XG5cbiAgaWYgKHR5cGVvZiBpdGVtICE9PSBcIm9iamVjdFwiIHx8IGl0ZW0gPT09IG51bGwgfHwgaXRlbSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG5cbiAgaWYgKEFycmF5LmlzQXJyYXkoaXRlbSkpIHtcbiAgICByZXR1cm4gKFxuICAgICAgYXdhaXQgUHJvbWlzZS5hbGwoaXRlbS5tYXAoKGkpID0+IGZpbmRVc2VkUmVmZXJlbmNlcyhub2RlSWRzLCBpKSkpXG4gICAgKS5mbGF0KCk7XG4gIH1cblxuICBpZiAoaXRlbSAmJiBcImR5bmFtaWNcIiBpbiBpdGVtKSB7XG4gICAgY29uc3QgZHluID0gKGl0ZW0gYXMgYW55KVtcImR5bmFtaWNcIl07XG4gICAgY29uc3QgeyBmb3JfZWFjaCwgLi4ub3RoZXJzIH0gPSBkeW47XG4gICAgY29uc3QgZHluYW1pY1JlZiA9IE9iamVjdC5rZXlzKG90aGVycylbMF07XG4gICAgcmV0dXJuIGF3YWl0IGZpbmRVc2VkUmVmZXJlbmNlcyhbLi4ubm9kZUlkcywgZHluYW1pY1JlZl0sIGR5bik7XG4gIH1cblxuICByZXR1cm4gKFxuICAgIGF3YWl0IFByb21pc2UuYWxsKFxuICAgICAgT2JqZWN0LnZhbHVlcyhpdGVtIGFzIFJlY29yZDxzdHJpbmcsIGFueT4pLm1hcCgoaSkgPT5cbiAgICAgICAgZmluZFVzZWRSZWZlcmVuY2VzKG5vZGVJZHMsIGkpXG4gICAgICApXG4gICAgKVxuICApLmZsYXQoKTtcbn1cbiJdfQ==