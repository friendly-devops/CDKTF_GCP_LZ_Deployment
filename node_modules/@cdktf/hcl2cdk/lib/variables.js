"use strict";
/**
 * Copyright (c) HashiCorp, Inc.
 * SPDX-License-Identifier: MPL-2.0
 */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.variableName = exports.constructAst = exports.referenceToVariableName = void 0;
const t = __importStar(require("@babel/types"));
const utils_1 = require("./utils");
const provider_generator_1 = require("@cdktf/provider-generator");
const provider_1 = require("./provider");
const reserved_words_1 = __importDefault(require("reserved-words"));
function referenceToVariableName(scope, ref) {
    const parts = ref.referencee.id.split(".");
    const resource = parts[0] === "data" ? `${parts[0]}.${parts[1]}` : parts[0];
    const name = parts[0] === "data" ? parts[2] : parts[1];
    return variableName(scope, resource, name);
}
exports.referenceToVariableName = referenceToVariableName;
function validVarName(name) {
    if (reserved_words_1.default.check(name)) {
        return `${name}Var`;
    }
    if (!Number.isNaN(parseInt(name[0], 10))) {
        return `d${name}`;
    }
    return name;
}
function getUniqueName(scope, provider, type) {
    var _a;
    // early abort on cdktf
    if (provider === "cdktf") {
        return (0, utils_1.pascalCase)(type.replace("cdktf_", ""));
    }
    if (provider === "NullProvider") {
        return (0, utils_1.pascalCase)(type.replace("NullProvider_", ""));
    }
    // Special handling for provider blocks, e.g. aws_AwsProvider
    if (type === `${(0, utils_1.pascalCase)(provider)}Provider`) {
        return (0, provider_generator_1.sanitizeClassOrNamespaceName)(type, true);
    }
    const fullProviderName = (0, provider_1.getFullProviderName)(scope.providerSchema, provider);
    if (fullProviderName && scope.providerGenerator[fullProviderName]) {
        return (_a = scope.providerGenerator[fullProviderName]) === null || _a === void 0 ? void 0 : _a.getClassNameForResource(type);
    }
    else {
        // If we can not find the class name for a resource the caller needs to find a sensible default
        return null;
    }
}
function getResourceNamespace(scope, provider, resource, isDataSource, type) {
    var _a;
    // happens e.g. for references to cdktf.TerraformStack (and similar) in generated code
    if (provider === "cdktf") {
        return undefined;
    }
    // e.g. awsProvider -> provider
    if (resource === (0, utils_1.pascalCase)(`${provider}_provider`) ||
        (provider === "NullProvider" && resource === "NullProvider")) {
        return "provider";
    }
    const fullProviderName = (0, provider_1.getFullProviderName)(scope.providerSchema, provider);
    if (fullProviderName && scope.providerGenerator[fullProviderName]) {
        return (0, utils_1.camelCase)((_a = scope.providerGenerator[fullProviderName]) === null || _a === void 0 ? void 0 : _a.getNamespaceNameForResource(type.replace(/\./g, "_")));
    }
    if (isDataSource) {
        return (0, utils_1.camelCase)((0, provider_generator_1.sanitizeClassOrNamespaceName)(`data_${provider}_${resource}`));
    }
    return (0, utils_1.camelCase)((0, provider_generator_1.sanitizeClassOrNamespaceName)(resource));
}
function constructAst(scope, type, isModuleImport) {
    if (isModuleImport) {
        return t.memberExpression(t.identifier(type), t.identifier(type));
    }
    if (type.startsWith("var.")) {
        scope.importables.push({
            provider: "cdktf",
            constructName: "TerraformVariable",
        });
        return t.identifier("TerraformVariable");
    }
    if (type === "terraform.data") {
        scope.importables.push({
            constructName: "DataResource",
            provider: "cdktf",
        });
        return t.identifier("DataResource");
    }
    // resources or data sources
    if (!type.includes("./") && type.includes(".")) {
        const parts = type.split(".");
        if (parts[0] === "data") {
            const [, provider, resource] = parts;
            const namespace = getResourceNamespace(scope, provider, resource, true, type);
            const resourceName = getUniqueName(scope, provider, parts.join("_")) ||
                (0, utils_1.pascalCase)((0, provider_generator_1.sanitizeClassOrNamespaceName)(`data_${provider}_${resource}`));
            scope.importables.push({
                provider: provider,
                constructName: resourceName,
                namespace,
            });
            if (namespace) {
                return t.identifier(resourceName); // e.g. DataAwsInstance
            }
            return t.identifier(resourceName); // e.g. DataAwsNatGateway
        }
        const [provider, resource] = parts;
        const namespace = getResourceNamespace(scope, provider, resource, false, type);
        const resourceName = getUniqueName(scope, provider, parts.join("_")) ||
            (0, utils_1.pascalCase)((0, provider_generator_1.sanitizeClassOrNamespaceName)(resource));
        scope.importables.push({
            provider: provider,
            constructName: resourceName,
            namespace,
        });
        if (namespace) {
            return t.identifier(resourceName); // e.g. Instance
        }
        return t.identifier(resourceName); // e.g. BigQueryTable
    }
    return t.identifier((0, utils_1.pascalCase)(type));
}
exports.constructAst = constructAst;
function variableName(scope, resource, name) {
    const consistentResourceName = resource.replace(/\./g, "_");
    // name collision, we need to prefix the name
    if (scope.variables[name]) {
        if (consistentResourceName === scope.variables[name].resource) {
            return scope.variables[name].variableName;
        }
        // we only cache one per name
        return validVarName((0, utils_1.camelCase)([resource, name].join("_")));
    }
    const variableName = validVarName((0, utils_1.camelCase)(name));
    scope.variables[name] = {
        variableName,
        resource: consistentResourceName,
    };
    return variableName;
}
exports.variableName = variableName;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFyaWFibGVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsidmFyaWFibGVzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRUgsZ0RBQWtDO0FBRWxDLG1DQUFnRDtBQUNoRCxrRUFBeUU7QUFDekUseUNBQWlEO0FBQ2pELG9FQUEyQztBQUUzQyxTQUFnQix1QkFBdUIsQ0FDckMsS0FBbUIsRUFDbkIsR0FBYztJQUVkLE1BQU0sS0FBSyxHQUFHLEdBQUcsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMzQyxNQUFNLFFBQVEsR0FBRyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssTUFBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzVFLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsS0FBSyxNQUFNLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3ZELE9BQU8sWUFBWSxDQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDN0MsQ0FBQztBQVJELDBEQVFDO0FBRUQsU0FBUyxZQUFZLENBQUMsSUFBWTtJQUNoQyxJQUFJLHdCQUFhLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQzdCLE9BQU8sR0FBRyxJQUFJLEtBQUssQ0FBQztLQUNyQjtJQUVELElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsRUFBRTtRQUN4QyxPQUFPLElB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SUFBSSxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQ3pCLElBQUksc0JBQXNCLEtBQUssS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUU7WUFDN0QsT0FBTyxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLFlBQVksQ0FBQztTQUMzQztRQUVELDZCQUE2QjtRQUM3QixPQUFPLFlBQVksQ0FBQyxJQUFBLGlCQUFTLEVBQUMsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztLQUM1RDtJQUVELE1BQU0sWUFBWSxHQUFHLFlBQVksQ0FBQyxJQUFBLGlCQUFTLEVBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUVuRCxLQUFLLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxHQUFHO1FBQ3RCLFlBQVk7UUFDWixRQUFRLEVBQUUsc0JBQXNCO0tBQ2pDLENBQUM7SUFFRixPQUFPLFlBQVksQ0FBQztBQUN0QixDQUFDO0FBeEJELG9DQXdCQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSBIYXNoaUNvcnAsIEluYy5cbiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBNUEwtMi4wXG4gKi9cblxuaW1wb3J0ICogYXMgdCBmcm9tIFwiQGJhYmVsL3R5cGVzXCI7XG5pbXBvcnQgeyBQcm9ncmFtU2NvcGUsIFJlZmVyZW5jZSB9IGZyb20gXCIuL3R5cGVzXCI7XG5pbXBvcnQgeyBjYW1lbENhc2UsIHBhc2NhbENhc2UgfSBmcm9tIFwiLi91dGlsc1wiO1xuaW1wb3J0IHsgc2FuaXRpemVDbGFzc09yTmFtZXNwYWNlTmFtZSB9IGZyb20gXCJAY2RrdGYvcHJvdmlkZXItZ2VuZXJhdG9yXCI7XG5pbXBvcnQgeyBnZXRGdWxsUHJvdmlkZXJOYW1lIH0gZnJvbSBcIi4vcHJvdmlkZXJcIjtcbmltcG9ydCByZXNlcnZlZFdvcmRzIGZyb20gXCJyZXNlcnZlZC13b3Jkc1wiO1xuXG5leHBvcnQgZnVuY3Rpb24gcmVmZXJlbmNlVG9WYXJpYWJsZU5hbWUoXG4gIHNjb3BlOiBQcm9ncmFtU2NvcGUsXG4gIHJlZjogUmVmZXJlbmNlXG4pOiBzdHJpbmcge1xuICBjb25zdCBwYXJ0cyA9IHJlZi5yZWZlcmVuY2VlLmlkLnNwbGl0KFwiLlwiKTtcbiAgY29uc3QgcmVzb3VyY2UgPSBwYXJ0c1swXSA9PT0gXCJkYXRhXCIgPyBgJHtwYXJ0c1swXX0uJHtwYXJ0c1sxXX1gIDogcGFydHNbMF07XG4gIGNvbnN0IG5hbWUgPSBwYXJ0c1swXSA9PT0gXCJkYXRhXCIgPyBwYXJ0c1syXSA6IHBhcnRzWzFdO1xuICByZXR1cm4gdmFyaWFibGVOYW1lKHNjb3BlLCByZXNvdXJjZSwgbmFtZSk7XG59XG5cbmZ1bmN0aW9uIHZhbGlkVmFyTmFtZShuYW1lOiBzdHJpbmcpIHtcbiAgaWYgKHJlc2VydmVkV29yZHMuY2hlY2sobmFtZSkpIHtcbiAgICByZXR1cm4gYCR7bmFtZX1WYXJgO1xuICB9XG5cbiAgaWYgKCFOdW1iZXIuaXNOYU4ocGFyc2VJbnQobmFtZVswXSwgMTApKSkge1xuICAgIHJldHVybiBgZCR7bmFtZX1gO1xuICB9XG5cbiAgcmV0dXJuIG5hbWU7XG59XG5cbmZ1bmN0aW9uIGdldFVuaXF1ZU5hbWUoc2NvcGU6IFByb2dyYW1TY29wZSwgcHJvdmlkZXI6IHN0cmluZywgdHlwZTogc3RyaW5nKSB7XG4gIC8vIGVhcmx5IGFib3J0IG9uIGNka3RmXG4gIGlmIChwcm92aWRlciA9PT0gXCJjZGt0ZlwiKSB7XG4gICAgcmV0dXJuIHBhc2NhbENhc2UodHlwZS5yZXBsYWNlKFwiY2RrdGZfXCIsIFwiXCIpKTtcbiAgfVxuXG4gIGlmIChwcm92aWRlciA9PT0gXCJOdWxsUHJvdmlkZXJcIikge1xuICAgIHJldHVybiBwYXNjYWxDYXNlKHR5cGUucmVwbGFjZShcIk51bGxQcm92aWRlcl9cIiwgXCJcIikpO1xuICB9XG5cbiAgLy8gU3BlY2lhbCBoYW5kbGluZyBmb3IgcHJvdmlkZXIgYmxvY2tzLCBlLmcuIGF3c19Bd3NQcm92aWRlclxuICBpZiAodHlwZSA9PT0gYCR7cGFzY2FsQ2FzZShwcm92aWRlcil9UHJvdmlkZXJgKSB7XG4gICAgcmV0dXJuIHNhbml0aXplQ2xhc3NPck5hbWVzcGFjZU5hbWUodHlwZSwgdHJ1ZSk7XG4gIH1cblxuICBjb25zdCBmdWxsUHJvdmlkZXJOYW1lID0gZ2V0RnVsbFByb3ZpZGVyTmFtZShzY29wZS5wcm92aWRlclNjaGVtYSwgcHJvdmlkZXIpO1xuICBpZiAoZnVsbFByb3ZpZGVyTmFtZSAmJiBzY29wZS5wcm92aWRlckdlbmVyYXRvcltmdWxsUHJvdmlkZXJOYW1lXSkge1xuICAgIHJldHVybiBzY29wZS5wcm92aWRlckdlbmVyYXRvcltmdWxsUHJvdmlkZXJOYW1lXT8uZ2V0Q2xhc3NOYW1lRm9yUmVzb3VyY2UoXG4gICAgICB0eXBlXG4gICAgKTtcbiAgfSBlbHNlIHtcbiAgICAvLyBJZiB3ZSBjYW4gbm90IGZpbmQgdGhlIGNsYXNzIG5hbWUgZm9yIGEgcmVzb3VyY2UgdGhlIGNhbGxlciBuZWVkcyB0byBmaW5kIGEgc2Vuc2libGUgZGVmYXVsdFxuICAgIHJldHVybiBudWxsO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldFJlc291cmNlTmFtZXNwYWNlKFxuICBzY29wZTogUHJvZ3JhbVNjb3BlLFxuICBwcm92aWRlcjogc3RyaW5nLFxuICByZXNvdXJjZTogc3RyaW5nLFxuICBpc0RhdGFTb3VyY2U6IGJvb2xlYW4sXG4gIHR5cGU6IHN0cmluZ1xuKSB7XG4gIC8vIGhhcHBlbnMgZS5nLiBmb3IgcmVmZXJlbmNlcyB0byBjZGt0Zi5UZXJyYWZvcm1TdGFjayAoYW5kIHNpbWlsYXIpIGluIGdlbmVyYXRlZCBjb2RlXG4gIGlmIChwcm92aWRlciA9PT0gXCJjZGt0ZlwiKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIC8vIGUuZy4gYXdzUHJvdmlkZXIgLT4gcHJvdmlkZXJcbiAgaWYgKFxuICAgIHJlc291cmNlID09PSBwYXNjYWxDYXNlKGAke3Byb3ZpZGVyfV9wcm92aWRlcmApIHx8XG4gICAgKHByb3ZpZGVyID09PSBcIk51bGxQcm92aWRlclwiICYmIHJlc291cmNlID09PSBcIk51bGxQcm92aWRlclwiKVxuICApIHtcbiAgICByZXR1cm4gXCJwcm92aWRlclwiO1xuICB9XG5cbiAgY29uc3QgZnVsbFByb3ZpZGVyTmFtZSA9IGdldEZ1bGxQcm92aWRlck5hbWUoc2NvcGUucHJvdmlkZXJTY2hlbWEsIHByb3ZpZGVyKTtcblxuICBpZiAoZnVsbFByb3ZpZGVyTmFtZSAmJiBzY29wZS5wcm92aWRlckdlbmVyYXRvcltmdWxsUHJvdmlkZXJOYW1lXSkge1xuICAgIHJldHVybiBjYW1lbENhc2UoXG4gICAgICBzY29wZS5wcm92aWRlckdlbmVyYXRvcltmdWxsUHJvdmlkZXJOYW1lXT8uZ2V0TmFtZXNwYWNlTmFtZUZvclJlc291cmNlKFxuICAgICAgICB0eXBlLnJlcGxhY2UoL1xcLi9nLCBcIl9cIilcbiAgICAgIClcbiAgICApO1xuICB9XG5cbiAgaWYgKGlzRGF0YVNvdXJjZSkge1xuICAgIHJldHVybiBjYW1lbENhc2UoXG4gICAgICBzYW5pdGl6ZUNsYXNzT3JOYW1lc3BhY2VOYW1lKGBkYXRhXyR7cHJvdmlkZXJ9XyR7cmVzb3VyY2V9YClcbiAgICApO1xuICB9XG5cbiAgcmV0dXJuIGNhbWVsQ2FzZShzYW5pdGl6ZUNsYXNzT3JOYW1lc3BhY2VOYW1lKHJlc291cmNlKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjb25zdHJ1Y3RBc3QoXG4gIHNjb3BlOiBQcm9ncmFtU2NvcGUsXG4gIHR5cGU6IHN0cmluZyxcbiAgaXNNb2R1bGVJbXBvcnQ6IGJvb2xlYW5cbikge1xuICBpZiAoaXNNb2R1bGVJbXBvcnQpIHtcbiAgICByZXR1cm4gdC5tZW1iZXJFeHByZXNzaW9uKHQuaWRlbnRpZmllcih0eXBlKSwgdC5pZGVudGlmaWVyKHR5cGUpKTtcbiAgfVxuXG4gIGlmICh0eXBlLnN0YXJ0c1dpdGgoXCJ2YXIuXCIpKSB7XG4gICAgc2NvcGUuaW1wb3J0YWJsZXMucHVzaCh7XG4gICAgICBwcm92aWRlcjogXCJjZGt0ZlwiLFxuICAgICAgY29uc3RydWN0TmFtZTogXCJUZXJyYWZvcm1WYXJpYWJsZVwiLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHQuaWRlbnRpZmllcihcIlRlcnJhZm9ybVZhcmlhYmxlXCIpO1xuICB9XG5cbiAgaWYgKHR5cGUgPT09IFwidGVycmFmb3JtLmRhdGFcIikge1xuICAgIHNjb3BlLmltcG9ydGFibGVzLnB1c2goe1xuICAgICAgY29uc3RydWN0TmFtZTogXCJEYXRhUmVzb3VyY2VcIixcbiAgICAgIHByb3ZpZGVyOiBcImNka3RmXCIsXG4gICAgfSk7XG4gICAgcmV0dXJuIHQuaWRlbnRpZmllcihcIkRhdGFSZXNvdXJjZVwiKTtcbiAgfVxuXG4gIC8vIHJlc291cmNlcyBvciBkYXRhIHNvdXJjZXNcbiAgaWYgKCF0eXBlLmluY2x1ZGVzKFwiLi9cIikgJiYgdHlwZS5pbmNsdWRlcyhcIi5cIikpIHtcbiAgICBjb25zdCBwYXJ0cyA9IHR5cGUuc3BsaXQoXCIuXCIpO1xuICAgIGlmIChwYXJ0c1swXSA9PT0gXCJkYXRhXCIpIHtcbiAgICAgIGNvbnN0IFssIHByb3ZpZGVyLCByZXNvdXJjZV0gPSBwYXJ0cztcblxuICAgICAgY29uc3QgbmFtZXNwYWNlID0gZ2V0UmVzb3VyY2VOYW1lc3BhY2UoXG4gICAgICAgIHNjb3BlLFxuICAgICAgICBwcm92aWRlcixcbiAgICAgICAgcmVzb3VyY2UsXG4gICAgICAgIHRydWUsXG4gICAgICAgIHR5cGVcbiAgICAgICk7XG4gICAgICBjb25zdCByZXNvdXJjZU5hbWUgPVxuICAgICAgICBnZXRVbmlxdWVOYW1lKHNjb3BlLCBwcm92aWRlciwgcGFydHMuam9pbihcIl9cIikpIHx8XG4gICAgICAgIHBhc2NhbENhc2UoXG4gICAgICAgICAgc2FuaXRpemVDbGFzc09yTmFtZXNwYWNlTmFtZShgZGF0YV8ke3Byb3ZpZGVyfV8ke3Jlc291cmNlfWApXG4gICAgICAgICk7XG5cbiAgICAgIHNjb3BlLmltcG9ydGFibGVzLnB1c2goe1xuICAgICAgICBwcm92aWRlcjogcHJvdmlkZXIsXG4gICAgICAgIGNvbnN0cnVjdE5hbWU6IHJlc291cmNlTmFtZSxcbiAgICAgICAgbmFtZXNwYWNlLFxuICAgICAgfSk7XG5cbiAgICAgIGlmIChuYW1lc3BhY2UpIHtcbiAgICAgICAgcmV0dXJuIHQuaWRlbnRpZmllcihyZXNvdXJjZU5hbWUpOyAvLyBlLmcuIERhdGFBd3NJbnN0YW5jZVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gdC5pZGVudGlmaWVyKHJlc291cmNlTmFtZSk7IC8vIGUuZy4gRGF0YUF3c05hdEdhdGV3YXlcbiAgICB9XG5cbiAgICBjb25zdCBbcHJvdmlkZXIsIHJlc291cmNlXSA9IHBhcnRzO1xuICAgIGNvbnN0IG5hbWVzcGFjZSA9IGdldFJlc291cmNlTmFtZXNwYWNlKFxuICAgICAgc2NvcGUsXG4gICAgICBwcm92aWRlcixcbiAgICAgIHJlc291cmNlLFxuICAgICAgZmFsc2UsXG4gICAgICB0eXBlXG4gICAgKTtcbiAgICBjb25zdCByZXNvdXJjZU5hbWUgPVxuICAgICAgZ2V0VW5pcXVlTmFtZShzY29wZSwgcHJvdmlkZXIsIHBhcnRzLmpvaW4oXCJfXCIpKSB8fFxuICAgICAgcGFzY2FsQ2FzZShzYW5pdGl6ZUNsYXNzT3JOYW1lc3BhY2VOYW1lKHJlc291cmNlKSk7XG5cbiAgICBzY29wZS5pbXBvcnRhYmxlcy5wdXNoKHtcbiAgICAgIHByb3ZpZGVyOiBwcm92aWRlcixcbiAgICAgIGNvbnN0cnVjdE5hbWU6IHJlc291cmNlTmFtZSxcbiAgICAgIG5hbWVzcGFjZSxcbiAgICB9KTtcblxuICAgIGlmIChuYW1lc3BhY2UpIHtcbiAgICAgIHJldHVybiB0LmlkZW50aWZpZXIocmVzb3VyY2VOYW1lKTsgLy8gZS5nLiBJbnN0YW5jZVxuICAgIH1cblxuICAgIHJldHVybiB0LmlkZW50aWZpZXIocmVzb3VyY2VOYW1lKTsgLy8gZS5nLiBCaWdRdWVyeVRhYmxlXG4gIH1cblxuICByZXR1cm4gdC5pZGVudGlmaWVyKHBhc2NhbENhc2UodHlwZSkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdmFyaWFibGVOYW1lKFxuICBzY29wZTogUHJvZ3JhbVNjb3BlLFxuICByZXNvdXJjZTogc3RyaW5nLFxuICBuYW1lOiBzdHJpbmdcbik6IHN0cmluZyB7XG4gIGNvbnN0IGNvbnNpc3RlbnRSZXNvdXJjZU5hbWUgPSByZXNvdXJjZS5yZXBsYWNlKC9cXC4vZywgXCJfXCIpO1xuICAvLyBuYW1lIGNvbGxpc2lvbiwgd2UgbmVlZCB0byBwcmVmaXggdGhlIG5hbWVcbiAgaWYgKHNjb3BlLnZhcmlhYmxlc1tuYW1lXSkge1xuICAgIGlmIChjb25zaXN0ZW50UmVzb3VyY2VOYW1lID09PSBzY29wZS52YXJpYWJsZXNbbmFtZV0ucmVzb3VyY2UpIHtcbiAgICAgIHJldHVybiBzY29wZS52YXJpYWJsZXNbbmFtZV0udmFyaWFibGVOYW1lO1xuICAgIH1cblxuICAgIC8vIHdlIG9ubHkgY2FjaGUgb25lIHBlciBuYW1lXG4gICAgcmV0dXJuIHZhbGlkVmFyTmFtZShjYW1lbENhc2UoW3Jlc291cmNlLCBuYW1lXS5qb2luKFwiX1wiKSkpO1xuICB9XG5cbiAgY29uc3QgdmFyaWFibGVOYW1lID0gdmFsaWRWYXJOYW1lKGNhbWVsQ2FzZShuYW1lKSk7XG5cbiAgc2NvcGUudmFyaWFibGVzW25hbWVdID0ge1xuICAgIHZhcmlhYmxlTmFtZSxcbiAgICByZXNvdXJjZTogY29uc2lzdGVudFJlc291cmNlTmFtZSxcbiAgfTtcblxuICByZXR1cm4gdmFyaWFibGVOYW1lO1xufVxuIl19