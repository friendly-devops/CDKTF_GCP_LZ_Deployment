"use strict";
/**
 * Copyright (c) HashiCorp, Inc.
 * SPDX-License-Identifier: MPL-2.0
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getGradlePackageVersionFromBuild = exports.getGradlePackageVersion = exports.getDependencyInformationFromLine = exports.getGradleDependencies = exports.isGradleProject = void 0;
const path_1 = __importDefault(require("path"));
const fs_extra_1 = __importDefault(require("fs-extra"));
const logging_1 = require("./logging");
const util_1 = require("./util");
function isGradleProject(workingDirectory) {
    const buildGradlePath = path_1.default.join(workingDirectory, "build.gradle");
    try {
        fs_extra_1.default.accessSync(buildGradlePath, fs_extra_1.default.constants.R_OK | fs_extra_1.default.constants.W_OK);
        return true;
    }
    catch (_a) {
        logging_1.logger.debug(`No build.gradle found at ${buildGradlePath}`);
        return false;
    }
}
exports.isGradleProject = isGradleProject;
async function getGradleDependencies() {
    let output;
    try {
        output = await (0, util_1.exec)("gradle", ["dependencies", "--console=plain"], {
            env: process.env,
        });
    }
    catch (e) {
        logging_1.logger.debug(`Unable to run 'gradle dependencies': ${e}`);
        return undefined;
    }
    const lines = output.split(/\r\n|\r|\n/);
    // find the implementation section
    const implementationSection = lines.findIndex((line) => line.includes("implementation - "));
    if (implementationSection === -1) {
        logging_1.logger.debug(`Unable to find implementation section in output of 'gradle dependencies': ${output}`);
        return undefined;
    }
    const emptyLineRegex = /^\s*$/;
    const implementationSectionLines = lines.slice(implementationSection + 1);
    const sectionEnd = implementationSectionLines.findIndex((line) => emptyLineRegex.test(line));
    const implementationLines = implementationSectionLines.slice(0, sectionEnd);
    // find the api section
    const apiSection = lines.findIndex((line) => line.includes("api - "));
    if (apiSection === -1) {
        logging_1.logger.debug(`Unable to find api section in output of 'gradle dependencies': ${output}`);
        return undefined;
    }
    const apiSectionLines = lines.slice(apiSection + 1);
    const apiSectionEnd = apiSectionLines.findIndex((line) => emptyLineRegex.test(line));
    const apiLines = apiSectionLines.slice(0, apiSectionEnd);
    const prefixRegex = /^\s*[+\\-]+\s*/;
    const suffixRegex = /\s+\([nc*]\)\s*$/;
    return [...implementationLines, ...apiLines]
        .filter((line) => line !== "No dependencies")
        .map((line) => line.replace(prefixRegex, "").replace(suffixRegex, ""));
}
exports.getGradleDependencies = getGradleDependencies;
function getDependencyInformationFromLine(line) {
    const packageNameRegex = /^\s*([^:]+):([^:]+)(?::([^\s]+))?/;
    const matches = line.match(packageNameRegex);
    if (!matches) {
        logging_1.logger.debug("Unexpected format for gradle build. Please file an issue at https://cdk.tf/bug");
        return undefined;
    }
    if (matches[3] === undefined) {
        return {
            group: "",
            name: matches[1],
            version: matches[2],
        };
    }
    return {
        group: matches[1],
        name: matches[2],
        version: matches[3],
    };
}
exports.getDependencyInformationFromLine = getDependencyInformationFromLine;
/*
 * Example output:
  implementation - Implementation dependencies for the 'main' feature. (n)
  +--- com.hashicorp:cdktf:0.18.0 (n)
  +--- software.constructs:constructs:10.0.25 (n)
  +--- junit:junit:4.13.2 (n)
  \--- org.junit.jupiter:junit-jupiter:5.8.0 (n)
*/
async function getGradlePackageVersion(packageName) {
    const translationMap = {
        jsii: "jsii-runtime",
    };
    const gradlePackageName = translationMap[packageName] || packageName;
    logging_1.logger.debug("Running 'gradle dependencies' to find package version", gradlePackageName);
    const lines = await getGradleDependencies();
    if (!lines || lines.length === 0) {
        return undefined;
    }
    // loop through the subsequent lines to find the one starting with package name
    for (const line of lines) {
        if (line.includes(`:${gradlePackageName}:`)) {
            const dep = getDependencyInformationFromLine(line);
            if (dep) {
                return dep.version;
            }
            return undefined;
        }
    }
    // Didn't find the right file, read the build.gradle file as a backup
    const buildVersion = await getGradlePackageVersionFromBuild(packageName);
    if (buildVersion) {
        return buildVersion.version;
    }
    return undefined;
}
exports.getGradlePackageVersion = getGradlePackageVersion;
async function getGradlePackageVersionFromBuild(packageName) {
    const buildGradlePath = path_1.default.join(process.cwd(), "build.gradle");
    const buildGradleContents = await fs_extra_1.default.readFile(buildGradlePath, "utf-8");
    const buildLines = buildGradleContents.split(/\r\n|\r|\n/);
    const dependenciesRegex = /^\s*dependencies\s*\{/i;
    const dependenciesStart = buildLines.findIndex((line) => dependenciesRegex.test(line));
    if (dependenciesStart === -1) {
        logging_1.logger.debug(`Unable to find dependencies section in output build.gradle`);
        return undefined;
    }
    const foundIndex = buildLines.findIndex((line) => line.includes(packageName));
    if (foundIndex === -1) {
        logging_1.logger.debug(`Unable to find package ${packageName} in output build.gradle`);
        return undefined;
    }
    const line = buildLines[foundIndex];
    const colonSeparatedPackageNameRegex = new RegExp(`([^:]+):${packageName}(?::([^\\s]+))?`, "i");
    const colonMatch = colonSeparatedPackageNameRegex.exec(line);
    if (colonMatch) {
        return {
            group: colonMatch[1],
            name: packageName,
            version: colonMatch[2] || "",
        };
    }
    const fileSeparatedPackageNameRegex = new RegExp(`java/(.*)/${packageName}/([^/]+)/.*\\.jar`, "i");
    const fileMatch = fileSeparatedPackageNameRegex.exec(line);
    if (fileMatch) {
        return {
            group: fileMatch[1].replace(/\//g, "."),
            name: packageName,
            version: fileMatch[2],
        };
    }
    return undefined;
}
exports.getGradlePackageVersionFromBuild = getGradlePackageVersionFromBuild;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ3JhZGxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZ3JhZGxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7O0dBR0c7Ozs7OztBQUVILGdEQUF3QjtBQUN4Qix3REFBMEI7QUFDMUIsdUNBQW1DO0FBQ25DLGlDQUE4QjtBQUU5QixTQUFnQixlQUFlLENBQUMsZ0JBQXdCO0lBQ3RELE1BQU0sZUFBZSxHQUFHLGNBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsY0FBYyxDQUFDLENBQUM7SUFFcEUsSUFBSTtRQUNGLGtCQUFFLENBQUMsVUFBVSxDQUFDLGVBQWUsRUFBRSxrQkFBRSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEdBQUcsa0JBQUUsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdEUsT0FBTyxJQUFJLENBQUM7S0FDYjtJQUFDLFdBQU07UUFDTixnQkFBTSxDQUFDLEtBQUssQ0FBQyw0QkFBNEIsZUFBZSxFQUFFLENBQUMsQ0FBQztRQUM1RCxPQUFPLEtBQUssQ0FBQztLQUNkO0FBQ0gsQ0FBQztBQVZELDBDQVVDO0FBRU0sS0FBSyxVQUFVLHFCQUFxQjtJQUN6QyxJQUFJLE1BQU0sQ0FBQztJQUNYLElBQUk7UUFDRixNQUFNLEdBQUcsTUFBTSxJQUFBLFdBQUksRUFBQyxRQUFRLEVBQUUsQ0FBQyxjQUFjLEVBQUUsaUJBQWlCLENBQUMsRUFBRTtZQUNqRSxHQUFHLEVBQUUsT0FBTyxDQUFDLEdBQUc7U0FDakIsQ0FBQyxDQUFDO0tBQ0o7SUFBQyxPQUFPLENBQUMsRUFBRTtRQUNWLGdCQUFNLENBQUMsS0FBSyxDQUFDLHdDQUF3QyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQzFELE9BQU8sU0FBUyxDQUFDO0tBQ2xCO0lBRUQsTUFBTSxLQUFLLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUV6QyxrQ0FBa0M7SUFDbEMsTUFBTSxxQkFBcUIsR0FBRyxLQUFLLENBQUMsU0FBUyxD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QUM7S0FDSDtJQUVELE1BQU0sNkJBQTZCLEdBQUcsSUFBSSxNQUFNLENBQzlDLGFBQWEsV0FBVyxtQkFBbUIsRUFDM0MsR0FBRyxDQUNKLENBQUM7SUFFRixNQUFNLFNBQVMsR0FBRyw2QkFBNkIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDM0QsSUFBSSxTQUFTLEVBQUU7UUFDYixPQUFPO1lBQ0wsS0FBSyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQztZQUN2QyxJQUFJLEVBQUUsV0FBVztZQUNqQixPQUFPLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQztTQUN0QixDQUFDO0tBQ0g7SUFFRCxPQUFPLFNBQVMsQ0FBQztBQUNuQixDQUFDO0FBckRELDRFQXFEQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSBIYXNoaUNvcnAsIEluYy5cbiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBNUEwtMi4wXG4gKi9cblxuaW1wb3J0IHBhdGggZnJvbSBcInBhdGhcIjtcbmltcG9ydCBmcyBmcm9tIFwiZnMtZXh0cmFcIjtcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCIuL2xvZ2dpbmdcIjtcbmltcG9ydCB7IGV4ZWMgfSBmcm9tIFwiLi91dGlsXCI7XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0dyYWRsZVByb2plY3Qod29ya2luZ0RpcmVjdG9yeTogc3RyaW5nKTogYm9vbGVhbiB7XG4gIGNvbnN0IGJ1aWxkR3JhZGxlUGF0aCA9IHBhdGguam9pbih3b3JraW5nRGlyZWN0b3J5LCBcImJ1aWxkLmdyYWRsZVwiKTtcblxuICB0cnkge1xuICAgIGZzLmFjY2Vzc1N5bmMoYnVpbGRHcmFkbGVQYXRoLCBmcy5jb25zdGFudHMuUl9PSyB8IGZzLmNvbnN0YW50cy5XX09LKTtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSBjYXRjaCB7XG4gICAgbG9nZ2VyLmRlYnVnKGBObyBidWlsZC5ncmFkbGUgZm91bmQgYXQgJHtidWlsZEdyYWRsZVBhdGh9YCk7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRHcmFkbGVEZXBlbmRlbmNpZXMoKSB7XG4gIGxldCBvdXRwdXQ7XG4gIHRyeSB7XG4gICAgb3V0cHV0ID0gYXdhaXQgZXhlYyhcImdyYWRsZVwiLCBbXCJkZXBlbmRlbmNpZXNcIiwgXCItLWNvbnNvbGU9cGxhaW5cIl0sIHtcbiAgICAgIGVudjogcHJvY2Vzcy5lbnYsXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2dnZXIuZGVidWcoYFVuYWJsZSB0byBydW4gJ2dyYWRsZSBkZXBlbmRlbmNpZXMnOiAke2V9YCk7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIGNvbnN0IGxpbmVzID0gb3V0cHV0LnNwbGl0KC9cXHJcXG58XFxyfFxcbi8pO1xuXG4gIC8vIGZpbmQgdGhlIGltcGxlbWVudGF0aW9uIHNlY3Rpb25cbiAgY29uc3QgaW1wbGVtZW50YXRpb25TZWN0aW9uID0gbGluZXMuZmluZEluZGV4KChsaW5lKSA9PlxuICAgIGxpbmUuaW5jbHVkZXMoXCJpbXBsZW1lbnRhdGlvbiAtIFwiKVxuICApO1xuICBpZiAoaW1wbGVtZW50YXRpb25TZWN0aW9uID09PSAtMSkge1xuICAgIGxvZ2dlci5kZWJ1ZyhcbiAgICAgIGBVbmFibGUgdG8gZmluZCBpbXBsZW1lbnRhdGlvbiBzZWN0aW9uIGluIG91dHB1dCBvZiAnZ3JhZGxlIGRlcGVuZGVuY2llcyc6ICR7b3V0cHV0fWBcbiAgICApO1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBjb25zdCBlbXB0eUxpbmVSZWdleCA9IC9eXFxzKiQvO1xuICBjb25zdCBpbXBsZW1lbnRhdGlvblNlY3Rpb25MaW5lcyA9IGxpbmVzLnNsaWNlKGltcGxlbWVudGF0aW9uU2VjdGlvbiArIDEpO1xuICBjb25zdCBzZWN0aW9uRW5kID0gaW1wbGVtZW50YXRpb25TZWN0aW9uTGluZXMuZmluZEluZGV4KChsaW5lKSA9PlxuICAgIGVtcHR5TGluZVJlZ2V4LnRlc3QobGluZSlcbiAgKTtcbiAgY29uc3QgaW1wbGVtZW50YXRpb25MaW5lcyA9IGltcGxlbWVudGF0aW9uU2VjdGlvbkxpbmVzLnNsaWNlKDAsIHNlY3Rpb25FbmQpO1xuXG4gIC8vIGZpbmQgdGhlIGFwaSBzZWN0aW9uXG4gIGNvbnN0IGFwaVNlY3Rpb24gPSBsaW5lcy5maW5kSW5kZXgoKGxpbmUpID0+IGxpbmUuaW5jbHVkZXMoXCJhcGkgLSBcIikpO1xuICBpZiAoYXBpU2VjdGlvbiA9PT0gLTEpIHtcbiAgICBsb2dnZXIuZGVidWcoXG4gICAgICBgVW5hYmxlIHRvIGZpbmQgYXBpIHNlY3Rpb24gaW4gb3V0cHV0IG9mICdncmFkbGUgZGVwZW5kZW5jaWVzJzogJHtvdXRwdXR9YFxuICAgICk7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIGNvbnN0IGFwaVNlY3Rpb25MaW5lcyA9IGxpbmVzLnNsaWNlKGFwaVNlY3Rpb24gKyAxKTtcbiAgY29uc3QgYXBpU2VjdGlvbkVuZCA9IGFwaVNlY3Rpb25MaW5lcy5maW5kSW5kZXgoKGxpbmUpID0+XG4gICAgZW1wdHlMaW5lUmVnZXgudGVzdChsaW5lKVxuICApO1xuXG4gIGNvbnN0IGFwaUxpbmVzID0gYXBpU2VjdGlvbkxpbmVzLnNsaWNlKDAsIGFwaVNlY3Rpb25FbmQpO1xuXG4gIGNvbnN0IHByZWZpeFJlZ2V4ID0gL15cXHMqWytcXFxcLV0rXFxzKi87XG4gIGNvbnN0IHN1ZmZpeFJlZ2V4ID0gL1xccytcXChbbmMqXVxcKVxccyokLztcblxuICByZXR1cm4gWy4uLmltcGxlbWVudGF0aW9uTGluZXMsIC4uLmFwaUxpbmVzXVxuICAgIC5maWx0ZXIoKGxpbmUpID0+IGxpbmUgIT09IFwiTm8gZGVwZW5kZW5jaWVzXCIpXG4gICAgLm1hcCgobGluZSkgPT4gbGluZS5yZXBsYWNlKHByZWZpeFJlZ2V4LCBcIlwiKS5yZXBsYWNlKHN1ZmZpeFJlZ2V4LCBcIlwiKSk7XG59XG5cbmV4cG9ydCB0eXBlIERlcGVuZGVuY3lJbmZvcm1hdGlvbiA9IHtcbiAgZ3JvdXA6IHN0cmluZztcbiAgbmFtZTogc3RyaW5nO1xuICB2ZXJzaW9uOiBzdHJpbmc7XG59O1xuZXhwb3J0IGZ1bmN0aW9uIGdldERlcGVuZGVuY3lJbmZvcm1hdGlvbkZyb21MaW5lKFxuICBsaW5lOiBzdHJpbmdcbik6IERlcGVuZGVuY3lJbmZvcm1hdGlvbiB8IHVuZGVmaW5lZCB7XG4gIGNvbnN0IHBhY2thZ2VOYW1lUmVnZXggPSAvXlxccyooW146XSspOihbXjpdKykoPzo6KFteXFxzXSspKT8vO1xuICBjb25zdCBtYXRjaGVzID0gbGluZS5tYXRjaChwYWNrYWdlTmFtZVJlZ2V4KTtcbiAgaWYgKCFtYXRjaGVzKSB7XG4gICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgXCJVbmV4cGVjdGVkIGZvcm1hdCBmb3IgZ3JhZGxlIGJ1aWxkLiBQbGVhc2UgZmlsZSBhbiBpc3N1ZSBhdCBodHRwczovL2Nkay50Zi9idWdcIlxuICAgICk7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuXG4gIGlmIChtYXRjaGVzWzNdID09PSB1bmRlZmluZWQpIHtcbiAgICByZXR1cm4ge1xuICAgICAgZ3JvdXA6IFwiXCIsXG4gICAgICBuYW1lOiBtYXRjaGVzWzFdLFxuICAgICAgdmVyc2lvbjogbWF0Y2hlc1syXSxcbiAgICB9O1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBncm91cDogbWF0Y2hlc1sxXSxcbiAgICBuYW1lOiBtYXRjaGVzWzJdLFxuICAgIHZlcnNpb246IG1hdGNoZXNbM10sXG4gIH07XG59XG5cbi8qXG4gKiBFeGFtcGxlIG91dHB1dDpcbiAgaW1wbGVtZW50YXRpb24gLSBJbXBsZW1lbnRhdGlvbiBkZXBlbmRlbmNpZXMgZm9yIHRoZSAnbWFpbicgZmVhdHVyZS4gKG4pXG4gICstLS0gY29tLmhhc2hpY29ycDpjZGt0ZjowLjE4LjAgKG4pXG4gICstLS0gc29mdHdhcmUuY29uc3RydWN0czpjb25zdHJ1Y3RzOjEwLjAuMjUgKG4pXG4gICstLS0ganVuaXQ6anVuaXQ6NC4xMy4yIChuKVxuICBcXC0tLSBvcmcuanVuaXQuanVwaXRlcjpqdW5pdC1qdXBpdGVyOjUuOC4wIChuKVxuKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRHcmFkbGVQYWNrYWdlVmVyc2lvbihwYWNrYWdlTmFtZTogc3RyaW5nKSB7XG4gIGNvbnN0IHRyYW5zbGF0aW9uTWFwOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0ge1xuICAgIGpzaWk6IFwianNpaS1ydW50aW1lXCIsXG4gIH07XG4gIGNvbnN0IGdyYWRsZVBhY2thZ2VOYW1lID0gdHJhbnNsYXRpb25NYXBbcGFja2FnZU5hbWVdIHx8IHBhY2thZ2VOYW1lO1xuICBsb2dnZXIuZGVidWcoXG4gICAgXCJSdW5uaW5nICdncmFkbGUgZGVwZW5kZW5jaWVzJyB0byBmaW5kIHBhY2thZ2UgdmVyc2lvblwiLFxuICAgIGdyYWRsZVBhY2thZ2VOYW1lXG4gICk7XG5cbiAgY29uc3QgbGluZXMgPSBhd2FpdCBnZXRHcmFkbGVEZXBlbmRlbmNpZXMoKTtcbiAgaWYgKCFsaW5lcyB8fCBsaW5lcy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG5cbiAgLy8gbG9vcCB0aHJvdWdoIHRoZSBzdWJzZXF1ZW50IGxpbmVzIHRvIGZpbmQgdGhlIG9uZSBzdGFydGluZyB3aXRoIHBhY2thZ2UgbmFtZVxuICBmb3IgKGNvbnN0IGxpbmUgb2YgbGluZXMpIHtcbiAgICBpZiAobGluZS5pbmNsdWRlcyhgOiR7Z3JhZGxlUGFja2FnZU5hbWV9OmApKSB7XG4gICAgICBjb25zdCBkZXAgPSBnZXREZXBlbmRlbmN5SW5mb3JtYXRpb25Gcm9tTGluZShsaW5lKTtcbiAgICAgIGlmIChkZXApIHtcbiAgICAgICAgcmV0dXJuIGRlcC52ZXJzaW9uO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICAvLyBEaWRuJ3QgZmluZCB0aGUgcmlnaHQgZmlsZSwgcmVhZCB0aGUgYnVpbGQuZ3JhZGxlIGZpbGUgYXMgYSBiYWNrdXBcbiAgY29uc3QgYnVpbGRWZXJzaW9uID0gYXdhaXQgZ2V0R3JhZGxlUGFja2FnZVZlcnNpb25Gcm9tQnVpbGQocGFja2FnZU5hbWUpO1xuICBpZiAoYnVpbGRWZXJzaW9uKSB7XG4gICAgcmV0dXJuIGJ1aWxkVmVyc2lvbi52ZXJzaW9uO1xuICB9XG5cbiAgcmV0dXJuIHVuZGVmaW5lZDtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEdyYWRsZVBhY2thZ2VWZXJzaW9uRnJvbUJ1aWxkKHBhY2thZ2VOYW1lOiBzdHJpbmcpIHtcbiAgY29uc3QgYnVpbGRHcmFkbGVQYXRoID0gcGF0aC5qb2luKHByb2Nlc3MuY3dkKCksIFwiYnVpbGQuZ3JhZGxlXCIpO1xuICBjb25zdCBidWlsZEdyYWRsZUNvbnRlbnRzID0gYXdhaXQgZnMucmVhZEZpbGUoYnVpbGRHcmFkbGVQYXRoLCBcInV0Zi04XCIpO1xuICBjb25zdCBidWlsZExpbmVzID0gYnVpbGRHcmFkbGVDb250ZW50cy5zcGxpdCgvXFxyXFxufFxccnxcXG4vKTtcblxuICBjb25zdCBkZXBlbmRlbmNpZXNSZWdleCA9IC9eXFxzKmRlcGVuZGVuY2llc1xccypcXHsvaTtcbiAgY29uc3QgZGVwZW5kZW5jaWVzU3RhcnQgPSBidWlsZExpbmVzLmZpbmRJbmRleCgobGluZSkgPT5cbiAgICBkZXBlbmRlbmNpZXNSZWdleC50ZXN0KGxpbmUpXG4gICk7XG5cbiAgaWYgKGRlcGVuZGVuY2llc1N0YXJ0ID09PSAtMSkge1xuICAgIGxvZ2dlci5kZWJ1ZyhgVW5hYmxlIHRvIGZpbmQgZGVwZW5kZW5jaWVzIHNlY3Rpb24gaW4gb3V0cHV0IGJ1aWxkLmdyYWRsZWApO1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBjb25zdCBmb3VuZEluZGV4ID0gYnVpbGRMaW5lcy5maW5kSW5kZXgoKGxpbmUpID0+IGxpbmUuaW5jbHVkZXMocGFja2FnZU5hbWUpKTtcbiAgaWYgKGZvdW5kSW5kZXggPT09IC0xKSB7XG4gICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgYFVuYWJsZSB0byBmaW5kIHBhY2thZ2UgJHtwYWNrYWdlTmFtZX0gaW4gb3V0cHV0IGJ1aWxkLmdyYWRsZWBcbiAgICApO1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cbiAgY29uc3QgbGluZSA9IGJ1aWxkTGluZXNbZm91bmRJbmRleF07XG5cbiAgY29uc3QgY29sb25TZXBhcmF0ZWRQYWNrYWdlTmFtZVJlZ2V4ID0gbmV3IFJlZ0V4cChcbiAgICBgKFteOl0rKToke3BhY2thZ2VOYW1lfSg/OjooW15cXFxcc10rKSk/YCxcbiAgICBcImlcIlxuICApO1xuXG4gIGNvbnN0IGNvbG9uTWF0Y2ggPSBjb2xvblNlcGFyYXRlZFBhY2thZ2VOYW1lUmVnZXguZXhlYyhsaW5lKTtcbiAgaWYgKGNvbG9uTWF0Y2gpIHtcbiAgICByZXR1cm4ge1xuICAgICAgZ3JvdXA6IGNvbG9uTWF0Y2hbMV0sXG4gICAgICBuYW1lOiBwYWNrYWdlTmFtZSxcbiAgICAgIHZlcnNpb246IGNvbG9uTWF0Y2hbMl0gfHwgXCJcIixcbiAgICB9O1xuICB9XG5cbiAgY29uc3QgZmlsZVNlcGFyYXRlZFBhY2thZ2VOYW1lUmVnZXggPSBuZXcgUmVnRXhwKFxuICAgIGBqYXZhLyguKikvJHtwYWNrYWdlTmFtZX0vKFteL10rKS8uKlxcXFwuamFyYCxcbiAgICBcImlcIlxuICApO1xuXG4gIGNvbnN0IGZpbGVNYXRjaCA9IGZpbGVTZXBhcmF0ZWRQYWNrYWdlTmFtZVJlZ2V4LmV4ZWMobGluZSk7XG4gIGlmIChmaWxlTWF0Y2gpIHtcbiAgICByZXR1cm4ge1xuICAgICAgZ3JvdXA6IGZpbGVNYXRjaFsxXS5yZXBsYWNlKC9cXC8vZywgXCIuXCIpLFxuICAgICAgbmFtZTogcGFja2FnZU5hbWUsXG4gICAgICB2ZXJzaW9uOiBmaWxlTWF0Y2hbMl0sXG4gICAgfTtcbiAgfVxuXG4gIHJldHVybiB1bmRlZmluZWQ7XG59XG4iXX0=