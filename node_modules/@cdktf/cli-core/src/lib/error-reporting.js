"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.captureException = exports.initializErrorReporting = exports.persistReportCrashReportDecision = exports.shouldReportCrash = void 0;
// Copyright (c) HashiCorp, Inc
// SPDX-License-Identifier: MPL-2.0
const Sentry = __importStar(require("@sentry/node"));
const commons_1 = require("@cdktf/commons");
const commons_2 = require("@cdktf/commons");
const path = __importStar(require("path"));
const fs = __importStar(require("fs-extra"));
const ci_info_1 = __importDefault(require("ci-info"));
function shouldReportCrash(projectPath = process.cwd()) {
    try {
        const cdktfJson = JSON.parse(fs.readFileSync(path.resolve(projectPath, "cdktf.json"), "utf8"));
        return typeof cdktfJson.sendCrashReports === "boolean"
            ? cdktfJson.sendCrashReports
            : cdktfJson.sendCrashReports === "true";
    }
    catch (e) {
        commons_2.logger.debug(`Error determining if crash reporting should be enabled, defaulting to false: ${e}`);
        return false;
    }
}
exports.shouldReportCrash = shouldReportCrash;
function persistReportCrashReportDecision(decision, projectPath = process.cwd()) {
    const cdktfJson = JSON.parse(fs.readFileSync(path.resolve(projectPath, "cdktf.json"), "utf8"));
    cdktfJson.sendCrashReports = decision;
    fs.writeFileSync(path.resolve(projectPath, "cdktf.json"), JSON.stringify(cdktfJson, null, 2));
}
exports.persistReportCrashReportDecision = persistReportCrashReportDecision;
function isPromise(p) {
    return (typeof p === "object" &&
        typeof p.then === "function" &&
        typeof p.catch === "function");
}
async function initializErrorReporting(runConsentPrompt) {
    let shouldReport = shouldReportCrash();
    const ci = ci_info_1.default.isCI ? ci_info_1.default.name || "unknown" : false;
    // We have no info yet, so we need to ask the user
    if (shouldReport === undefined && runConsentPrompt) {
        // But only if it's a user
        if (ci) {
            return;
        }
        shouldReport = await runConsentPrompt();
        persistReportCrashReportDecision(shouldReport);
    }
    if (!shouldReport) {
        commons_2.logger.debug("Error reporting disabled");
        return;
    }
    if (!process.env.SENTRY_DSN) {
        commons_2.logger.info("Error reporting disabled: SENTRY_DSN not set");
        return;
    }
    commons_2.logger.debug("Initializing error reporting");
    Sentry.init({
        autoSessionTracking: true,
        dsn: process.env.SENTRY_DSN,
        release: `cdktf-cli-${commons_1.DISPLAY_VERSION}`,
        async beforeSend(event, hint) {
            if (!hint) {
                return event;
            }
            // The promise character is not documented, but it happens
            const originalException = hint.originalException;
            let error;
            if (isPromise(originalException)) {
                originalException.catch((e) => (error = e));
                await Promise.allSettled([originalException]);
            }
            else {
                error = originalException;
            }
            const errorMessage = (error === null || error === void 0 ? void 0 : error.toString()) || "";
            if (errorMessage.includes("Usage Error")) {
                // This is a usage error, so we don't want to report it
                return null;
            }
            return event;
        },
    });
    Sentry.configureScope(function (scope) {
        scope.setUser({
            id: (0, commons_1.getUserId)(),
        });
        scope.setTag("projectId", (0, commons_1.getProjectId)());
    });
    commons_2.logger.debug("Collecting environment information for error reporting");
    (0, commons_1.collectDebugInformation)().then((debugOutput) => {
        Sentry.setContext("environment", debugOutput);
    });
}
exports.initializErrorReporting = initializErrorReporting;
function captureException({ message, type, command, context, }) {
    if (process.env.SENTRY_DSN && shouldReportCrash()) {
        Sentry.captureException(new Error(message), {
            tags: {
                context: JSON.stringify(context),
                type,
                command,
            },
        });
    }
}
exports.captureException = captureException;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXJyb3ItcmVwb3J0aW5nLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZXJyb3ItcmVwb3J0aW5nLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsK0JBQStCO0FBQy9CLG1DQUFtQztBQUNuQyxxREFBdUM7QUFDdkMsNENBS3dCO0FBQ3hCLDRDQUF3QztBQUN4QywyQ0FBNkI7QUFDN0IsNkNBQStCO0FBQy9CLHNEQUE2QjtBQUU3QixTQUFnQixpQkFBaUIsQ0FDL0IsV0FBVyxHQUFHLE9BQU8sQ0FBQyxHQUFHLEVBQUU7SUFFM0IsSUFBSTtRQUNGLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQzFCLEVBQUUsQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsWUFBWSxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQ2pFLENBQUM7UUFFRixPQUFPLE9BQU8sU0FBUyxDQUFDLGdCQUFnQixLQUFLLFNBQVM7WUFDcEQsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0I7WUFDNUIsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxnQkFBZ0IsS0FBSyxNQUFNLENBQUM7S0FDM0M7SUFBQyxPQUFPLENBQUMsRUFBRTtRQUNWLGdCQUFNLENBQUMsS0FBSyxDQUNWLGdGQUFnRixDQUFDLEVBQUUsQ0FDcEYsQ0FBQztRQUNGLE9BQU8sS0FBSyxDQUFDO0tBQ2Q7QUFDSCxDQUFDO0FBakJELDhDQWlCQztBQUVELFNBQWdCLGdDQUFnQyxDQUM5QyxRQUFpQixFQUNqQixXQUFXLEdBQUcsT0FBTyxDQUFDLEdBQUcsRUFBRTtJQUUzQixNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUMxQixFQUFFLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsV0FBVyxFQUFFLFlBQVksQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUNqRSxDQUFDO0lBQ0YsU0FBUyxDQUFDLGdC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LElBQUEsc0JBQVksR0FBRSxDQUFDLENBQUM7SUFDNUMsQ0FBQyxDQUFDLENBQUM7SUFFSCxnQkFBTSxDQUFDLEtBQUssQ0FBQyx3REFBd0QsQ0FBQyxDQUFDO0lBQ3ZFLElBQUEsaUNBQXVCLEdBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxXQUFXLEVBQUUsRUFBRTtRQUM3QyxNQUFNLENBQUMsVUFBVSxDQUFDLGFBQWEsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUNoRCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUM7QUEzRUQsMERBMkVDO0FBRUQsU0FBZ0IsZ0JBQWdCLENBQUMsRUFDL0IsT0FBTyxFQUNQLElBQUksRUFDSixPQUFPLEVBQ1AsT0FBTyxHQU1SO0lBQ0MsSUFBSSxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsSUFBSSxpQkFBaUIsRUFBRSxFQUFFO1FBQ2pELE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRTtZQUMxQyxJQUFJLEVBQUU7Z0JBQ0osT0FBTyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDO2dCQUNoQyxJQUFJO2dCQUNKLE9BQU87YUFDUjtTQUNGLENBQUMsQ0FBQztLQUNKO0FBQ0gsQ0FBQztBQXBCRCw0Q0FvQkMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIEhhc2hpQ29ycCwgSW5jXG4vLyBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogTVBMLTIuMFxuaW1wb3J0ICogYXMgU2VudHJ5IGZyb20gXCJAc2VudHJ5L25vZGVcIjtcbmltcG9ydCB7XG4gIGdldFByb2plY3RJZCxcbiAgZ2V0VXNlcklkLFxuICBjb2xsZWN0RGVidWdJbmZvcm1hdGlvbixcbiAgRElTUExBWV9WRVJTSU9OLFxufSBmcm9tIFwiQGNka3RmL2NvbW1vbnNcIjtcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJAY2RrdGYvY29tbW9uc1wiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0ICogYXMgZnMgZnJvbSBcImZzLWV4dHJhXCI7XG5pbXBvcnQgY2lJbmZvIGZyb20gXCJjaS1pbmZvXCI7XG5cbmV4cG9ydCBmdW5jdGlvbiBzaG91bGRSZXBvcnRDcmFzaChcbiAgcHJvamVjdFBhdGggPSBwcm9jZXNzLmN3ZCgpXG4pOiBib29sZWFuIHwgdW5kZWZpbmVkIHtcbiAgdHJ5IHtcbiAgICBjb25zdCBjZGt0Zkpzb24gPSBKU09OLnBhcnNlKFxuICAgICAgZnMucmVhZEZpbGVTeW5jKHBhdGgucmVzb2x2ZShwcm9qZWN0UGF0aCwgXCJjZGt0Zi5qc29uXCIpLCBcInV0ZjhcIilcbiAgICApO1xuXG4gICAgcmV0dXJuIHR5cGVvZiBjZGt0Zkpzb24uc2VuZENyYXNoUmVwb3J0cyA9PT0gXCJib29sZWFuXCJcbiAgICAgID8gY2RrdGZKc29uLnNlbmRDcmFzaFJlcG9ydHNcbiAgICAgIDogY2RrdGZKc29uLnNlbmRDcmFzaFJlcG9ydHMgPT09IFwidHJ1ZVwiO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgYEVycm9yIGRldGVybWluaW5nIGlmIGNyYXNoIHJlcG9ydGluZyBzaG91bGQgYmUgZW5hYmxlZCwgZGVmYXVsdGluZyB0byBmYWxzZTogJHtlfWBcbiAgICApO1xuICAgIHJldHVybiBmYWxzZTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcGVyc2lzdFJlcG9ydENyYXNoUmVwb3J0RGVjaXNpb24oXG4gIGRlY2lzaW9uOiBib29sZWFuLFxuICBwcm9qZWN0UGF0aCA9IHByb2Nlc3MuY3dkKClcbikge1xuICBjb25zdCBjZGt0Zkpzb24gPSBKU09OLnBhcnNlKFxuICAgIGZzLnJlYWRGaWxlU3luYyhwYXRoLnJlc29sdmUocHJvamVjdFBhdGgsIFwiY2RrdGYuanNvblwiKSwgXCJ1dGY4XCIpXG4gICk7XG4gIGNka3RmSnNvbi5zZW5kQ3Jhc2hSZXBvcnRzID0gZGVjaXNpb247XG4gIGZzLndyaXRlRmlsZVN5bmMoXG4gICAgcGF0aC5yZXNvbHZlKHByb2plY3RQYXRoLCBcImNka3RmLmpzb25cIiksXG4gICAgSlNPTi5zdHJpbmdpZnkoY2RrdGZKc29uLCBudWxsLCAyKVxuICApO1xufVxuXG5mdW5jdGlvbiBpc1Byb21pc2UocDogYW55KTogcCBpcyBQcm9taXNlPGFueT4ge1xuICByZXR1cm4gKFxuICAgIHR5cGVvZiBwID09PSBcIm9iamVjdFwiICYmXG4gICAgdHlwZW9mIHAudGhlbiA9PT0gXCJmdW5jdGlvblwiICYmXG4gICAgdHlwZW9mIHAuY2F0Y2ggPT09IFwiZnVuY3Rpb25cIlxuICApO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaW5pdGlhbGl6RXJyb3JSZXBvcnRpbmcoXG4gIHJ1bkNvbnNlbnRQcm9tcHQ/OiAoKSA9PiBQcm9taXNlPGJvb2xlYW4+XG4pIHtcbiAgbGV0IHNob3VsZFJlcG9ydCA9IHNob3VsZFJlcG9ydENyYXNoKCk7XG4gIGNvbnN0IGNpOiBzdHJpbmcgfCBmYWxzZSA9IGNpSW5mby5pc0NJID8gY2lJbmZvLm5hbWUgfHwgXCJ1bmtub3duXCIgOiBmYWxzZTtcblxuICAvLyBXZSBoYXZlIG5vIGluZm8geWV0LCBzbyB3ZSBuZWVkIHRvIGFzayB0aGUgdXNlclxuICBpZiAoc2hvdWxkUmVwb3J0ID09PSB1bmRlZmluZWQgJiYgcnVuQ29uc2VudFByb21wdCkge1xuICAgIC8vIEJ1dCBvbmx5IGlmIGl0J3MgYSB1c2VyXG4gICAgaWYgKGNpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgc2hvdWxkUmVwb3J0ID0gYXdhaXQgcnVuQ29uc2VudFByb21wdCgpO1xuICAgIHBlcnNpc3RSZXBvcnRDcmFzaFJlcG9ydERlY2lzaW9uKHNob3VsZFJlcG9ydCk7XG4gIH1cblxuICBpZiAoIXNob3VsZFJlcG9ydCkge1xuICAgIGxvZ2dlci5kZWJ1ZyhcIkVycm9yIHJlcG9ydGluZyBkaXNhYmxlZFwiKTtcbiAgICByZXR1cm47XG4gIH1cbiAgaWYgKCFwcm9jZXNzLmVudi5TRU5UUllfRFNOKSB7XG4gICAgbG9nZ2VyLmluZm8oXCJFcnJvciByZXBvcnRpbmcgZGlzYWJsZWQ6IFNFTlRSWV9EU04gbm90IHNldFwiKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBsb2dnZXIuZGVidWcoXCJJbml0aWFsaXppbmcgZXJyb3IgcmVwb3J0aW5nXCIpO1xuXG4gIFNlbnRyeS5pbml0KHtcbiAgICBhdXRvU2Vzc2lvblRyYWNraW5nOiB0cnVlLFxuICAgIGRzbjogcHJvY2Vzcy5lbnYuU0VOVFJZX0RTTixcbiAgICByZWxlYXNlOiBgY2RrdGYtY2xpLSR7RElTUExBWV9WRVJTSU9OfWAsXG4gICAgYXN5bmMgYmVmb3JlU2VuZChldmVudCwgaGludCkge1xuICAgICAgaWYgKCFoaW50KSB7XG4gICAgICAgIHJldHVybiBldmVudDtcbiAgICAgIH1cblxuICAgICAgLy8gVGhlIHByb21pc2UgY2hhcmFjdGVyIGlzIG5vdCBkb2N1bWVudGVkLCBidXQgaXQgaGFwcGVuc1xuICAgICAgY29uc3Qgb3JpZ2luYWxFeGNlcHRpb246XG4gICAgICAgIHwgUHJvbWlzZTxFcnJvcj5cbiAgICAgICAgfCBFcnJvclxuICAgICAgICB8IHN0cmluZ1xuICAgICAgICB8IG51bGxcbiAgICAgICAgfCB1bmRlZmluZWRcbiAgICAgICAgfCB1bmtub3duID0gaGludC5vcmlnaW5hbEV4Y2VwdGlvbjtcbiAgICAgIGxldCBlcnJvcjogRXJyb3IgfCBzdHJpbmcgfCBudWxsIHwgdW5kZWZpbmVkIHwgdW5rbm93bjtcbiAgICAgIGlmIChpc1Byb21pc2Uob3JpZ2luYWxFeGNlcHRpb24pKSB7XG4gICAgICAgIChvcmlnaW5hbEV4Y2VwdGlvbiBhcyB1bmtub3duIGFzIFByb21pc2U8RXJyb3I+KS5jYXRjaChcbiAgICAgICAgICAoZSkgPT4gKGVycm9yID0gZSlcbiAgICAgICAgKTtcbiAgICAgICAgYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKFtvcmlnaW5hbEV4Y2VwdGlvbl0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZXJyb3IgPSBvcmlnaW5hbEV4Y2VwdGlvbjtcbiAgICAgIH1cblxuICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID0gZXJyb3I/LnRvU3RyaW5nKCkgfHwgXCJcIjtcbiAgICAgIGlmIChlcnJvck1lc3NhZ2UuaW5jbHVkZXMoXCJVc2FnZSBFcnJvclwiKSkge1xuICAgICAgICAvLyBUaGlzIGlzIGEgdXNhZ2UgZXJyb3IsIHNvIHdlIGRvbid0IHdhbnQgdG8gcmVwb3J0IGl0XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGV2ZW50O1xuICAgIH0sXG4gIH0pO1xuXG4gIFNlbnRyeS5jb25maWd1cmVTY29wZShmdW5jdGlvbiAoc2NvcGUpIHtcbiAgICBzY29wZS5zZXRVc2VyKHtcbiAgICAgIGlkOiBnZXRVc2VySWQoKSxcbiAgICB9KTtcbiAgICBzY29wZS5zZXRUYWcoXCJwcm9qZWN0SWRcIiwgZ2V0UHJvamVjdElkKCkpO1xuICB9KTtcblxuICBsb2dnZXIuZGVidWcoXCJDb2xsZWN0aW5nIGVudmlyb25tZW50IGluZm9ybWF0aW9uIGZvciBlcnJvciByZXBvcnRpbmdcIik7XG4gIGNvbGxlY3REZWJ1Z0luZm9ybWF0aW9uKCkudGhlbigoZGVidWdPdXRwdXQpID0+IHtcbiAgICBTZW50cnkuc2V0Q29udGV4dChcImVudmlyb25tZW50XCIsIGRlYnVnT3V0cHV0KTtcbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjYXB0dXJlRXhjZXB0aW9uKHtcbiAgbWVzc2FnZSxcbiAgdHlwZSxcbiAgY29tbWFuZCxcbiAgY29udGV4dCxcbn06IHtcbiAgbWVzc2FnZTogc3RyaW5nO1xuICB0eXBlOiBzdHJpbmc7XG4gIGNvbW1hbmQ6IHN0cmluZztcbiAgY29udGV4dD86IFJlY29yZDxzdHJpbmcsIGFueT47XG59KSB7XG4gIGlmIChwcm9jZXNzLmVudi5TRU5UUllfRFNOICYmIHNob3VsZFJlcG9ydENyYXNoKCkpIHtcbiAgICBTZW50cnkuY2FwdHVyZUV4Y2VwdGlvbihuZXcgRXJyb3IobWVzc2FnZSksIHtcbiAgICAgIHRhZ3M6IHtcbiAgICAgICAgY29udGV4dDogSlNPTi5zdHJpbmdpZnkoY29udGV4dCksXG4gICAgICAgIHR5cGUsXG4gICAgICAgIGNvbW1hbmQsXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG59XG4iXX0=