"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.SynthStack = exports.StackDependencies = void 0;
// Copyright (c) HashiCorp, Inc
// SPDX-License-Identifier: MPL-2.0
const fs = __importStar(require("fs-extra"));
const path = __importStar(require("path"));
const chalk = __importStar(require("chalk"));
const indent_string_1 = __importDefault(require("indent-string"));
const cdktf_1 = require("cdktf");
const perf_hooks_1 = require("perf_hooks");
const commons_1 = require("@cdktf/commons");
const cdktf_config_1 = require("./cdktf-config");
const hcl_tools_1 = require("@cdktf/hcl-tools");
const chalkColour = new chalk.Instance();
class StackDependencies {
    constructor(stacks) {
        this.stacks = stacks;
        this.pendingStacks = [];
        this.inflightStacks = [];
        this.deployedStacks = [];
        this.pendingStacks = [...this.stacks];
    }
    startRun(stack) {
        this.pendingStacks = this.pendingStacks.filter((item) => item.name !== stack.name);
        this.inflightStacks.push(stack);
    }
    finishRun(stack) {
        this.inflightStacks = this.inflightStacks.filter((item) => item.name !== stack.name);
        this.deployedStacks.push(stack);
    }
    get pendingDeployableStacks() {
        return this.pendingStacks.filter((pendingStack) => {
            const unmetDependencies = pendingStack.dependencies.filter((dependency) => {
                return !this.deployedStacks.some((deployedStack) => {
                    return deployedStack.name === dependency;
                });
            });
            return unmetDependencies.length === 0;
        });
    }
}
exports.StackDependencies = StackDependencies;
class SynthStack {
    static async synth(abortSignal, command, outdir, workingDirectory = process.cwd(), graceful = false, // will not exit the process but rethrow the error instead
    noColor = false, synthOrigin, hcl = false) {
        // start performance timer
        const startTime = perf_hooks_1.performance.now();
        const isDirectory = (source) => fs.lstatSync(source).isDirectory();
        const getDirectories = (source) => {
            if (!fs.existsSync(source))
                return [];
            return fs
                .readdirSync(source)
                .map((name) => path.join(source, name))
                .filter(isDirectory);
        };
        const existingDirectories = getDirectories(path.join(outdir, cdktf_1.Manifest.stacksFolder));
        const env = Object.fromEntries(Object.entries(process.env).filter(
        // We don't want to pass Terraform variables to the synth command since they should only be used at execution time
        ([key]) => !key.startsWith("TF_VAR_")));
        // Increases the default memory available to Node.js when synthesizing a TypeScript CDK project.
        const nodeOptsSwitch = "--max-old-space-size";
        const nodeOptsSetting = `${nodeOptsSwitch}=4096`;
        if (env.NODE_OPTIONS && !env.NODE_OPTIONS.includes(nodeOptsSwitch)) {
            commons_1.logger.warn(`WARNING: Found NODE_OPTIONS environment variable without a setting for ${nodeOptsSwitch}
The synthesizing step for TypeScript may need an increased amount of memory if multiple large providers
are used with locally generated bindings. You can ignore this if you don't use CDKTF with TypeScript.
If not present, the cdktf-cli sets it to NODE_OPTIONS="${nodeOptsSetting}" by default. But as
your environment already contains a NODE_OPTIONS variable, we won't override it. Hence, the app command
might fail while synthesizing with an out of memory error.`);
        }
        else if (!env.NODE_OPTIONS) {
            // increase memory to allow ts-node (when using TypeScript) to handle large amounts of generated code in memory
            env.NODE_OPTIONS = `${env.NODE_OPTIONS || ""} ${nodeOptsSetting}`.trim();
        }
        const currentContext = process.env[cdktf_1.CONTEXT_ENV]
            ? JSON.parse(process.env.CDKTF_CONTEXT_JSON)
            : {};
        const relativeModules = getRelativeTerraformModules();
        try {
            await (0, commons_1.shell)(command, [], {
                shell: true,
                env: {
                    ...env,
                    CDKTF_OUTDIR: outdir,
                    CDKTF_CONTINUE_SYNTH_ON_ERROR_ANNOTATIONS: "true",
                    [cdktf_1.CONTEXT_ENV]: JSON.stringify({
                        ...currentContext,
                        cdktfRelativeModules: relativeModules,
                    }),
                    SYNTH_HCL_OUTPUT: hcl.toString(),
                },
                cwd: workingDirectory,
                signal: abortSignal,
                noColor: noColor,
            });
        }
        catch (e) {
            const errorOutput = chalkColour `{redBright cdktf encountered an error while synthesizing}

Synth command: {blue ${command}}
Error:         {redBright ${e.message}}
${e.stderr
                ? chalkColour `
Command output on stderr:

{dim ${(0, indent_string_1.default)(e.stderr, 4)}}
`
                : ""}
${e.stdout
                ? chalkColour `
Command output on stdout:

{dim ${(0, indent_string_1.default)(e.stdout, 4)}}
`
                : ""}`;
            await this.synthErrorTelemetry(synthOrigin);
            if (graceful) {
                e.errorOutput = errorOutput;
                throw e;
            }
            console.error(`ERROR: ${errorOutput}`);
            process.exit(1);
        }
        // Apply formatting to HCL files if hcl output was selected
        if (hcl) {
            await SynthStack.formatHclFiles(outdir);
        }
        // end performance timer
        const endTime = perf_hooks_1.performance.now();
        let stacks = [];
        try {
            stacks = await SynthStack.readSynthesizedStacks(outdir);
        }
        catch (e) {
            const errorMessage = `ERROR: synthesis failed, because app was expected to call 'synth()', but didn't. Thus "${outdir}/${cdktf_1.Manifest.fileName}"  was not created: ${e}`;
            if (graceful) {
                throw new Error(errorMessage);
            }
            commons_1.logger.error(errorMessage);
            process.exit(1);
        }
        await this.synthTelemetry(endTime - startTime, stacks, synthOrigin);
        if (stacks.length === 0) {
            commons_1.logger.error("ERROR: No Terraform code synthesized.");
        }
        const stackNames = stacks.map((s) => s.name);
        const orphanedDirectories = existingDirectories.filter((e) => !stackNames.includes(path.basename(e)));
        for (const orphanedDirectory of orphanedDirectories) {
            fs.rmSync(orphanedDirectory, { recursive: true });
        }
        return stacks;
    }
    static async formatHclFiles(outDir) {
        const manifestPath = path.join(outDir, cdktf_1.Manifest.fileName);
        if (!(await fs.pathExists(manifestPath))) {
            throw new Error(`Could not find manifest file at ${manifestPath}. In case --skip-synth was passed, please try again without the flag.`);
        }
        const manifest = JSON.parse(fs.readFileSync(manifestPath).toString());
        for (const stackName in manifest.stacks) {
            const stack = manifest.stacks[stackName];
            const filePath = path.join(outDir, stack.synthesizedStackPath);
            const hclContent = fs.readFileSync(filePath).toString();
            const formattedHcl = await (0, hcl_tools_1.format)(hclContent);
            fs.writeFileSync(filePath, formattedHcl);
        }
    }
    static async readSynthesizedStacks(outdir) {
        const manifestPath = path.join(outdir, cdktf_1.Manifest.fileName);
        if (!(await fs.pathExists(manifestPath))) {
            throw new Error(`Could not find manifest file at ${manifestPath}. In case --skip-synth was passed, please try again without the flag.`);
        }
        const stacks = [];
        const manifest = JSON.parse(fs.readFileSync(manifestPath).toString());
        for (const stackName in manifest.stacks) {
            const stack = manifest.stacks[stackName];
            const filePath = path.join(outdir, stack.synthesizedStackPath);
            let jsonContent = {};
            if (filePath.endsWith(".tf.json")) {
                jsonContent = JSON.parse(fs.readFileSync(filePath).toString());
            }
            else {
                const metadataPath = path.join(outdir, stack.stackMetadataPath);
                jsonContent = JSON.parse(fs.readFileSync(metadataPath).toString());
            }
            stacks.push({
                ...stack,
                workingDirectory: path.join(outdir, stack.workingDirectory),
                content: JSON.stringify(jsonContent, null, 2),
            });
        }
        return stacks;
    }
    static async synthTelemetry(totalTime, stacks, synthOrigin) {
        const config = (0, commons_1.readConfigSync)();
        await (0, commons_1.sendTelemetry)("synth", {
            totalTime: totalTime,
            language: config.language,
            synthOrigin,
            stackMetadata: stacks.map((stack) => JSON.parse(stack.content)["//"].metadata),
            requiredProviders: stacks.map((stack) => JSON.parse(stack.content)["terraform"].required_providers),
        });
    }
    static async synthErrorTelemetry(synthOrigin) {
        await (0, commons_1.sendTelemetry)("synth", { error: true, synthOrigin });
    }
}
exports.SynthStack = SynthStack;
function getRelativeTerraformModules() {
    let cfg;
    try {
        cfg = cdktf_config_1.CdktfConfig.read();
    }
    catch (e) {
        commons_1.logger.trace("Could not read cdktf.json: " + e);
        return [];
    }
    return cfg.terraformModules.filter((mod) => {
        return typeof mod === "string"
            ? mod.startsWith("./") || mod.startsWith("../")
            : mod.source.startsWith("./") || mod.source.startsWith("../");
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3ludGgtc3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzeW50aC1zdGFjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLCtCQUErQjtBQUMvQixtQ0FBbUM7QUFDbkMsNkNBQStCO0FBQy9CLDJDQUE2QjtBQUM3Qiw2Q0FBK0I7QUFDL0Isa0VBQXlDO0FBQ3pDLGlDQUtlO0FBQ2YsMkNBQXlDO0FBQ3pDLDRDQUE4RTtBQUM5RSxpREFBNkM7QUFDN0MsZ0RBQTBDO0FBRTFDLE1BQU0sV0FBVyxHQUFHLElBQUksS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDO0FBVXpDLE1BQWEsaUJBQWlCO0lBSzVCLFlBQTZCLE1BQTBCO1FBQTFCLFdBQU0sR0FBTixNQUFNLENBQW9CO1FBSmhELGtCQUFhLEdBQXVCLEVBQUUsQ0FBQztRQUN2QyxtQkFBYyxHQUF1QixFQUFFLENBQUM7UUFDeEMsbUJBQWMsR0FBdUIsRUFBRSxDQUFDO1FBRzdDLElBQUksQ0FBQyxhQUFhLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUN4QyxDQUFDO0lBRU0sUUFBUSxDQUFDLEtBQXVCO1FBQ3JDLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxNQUFNLENBQzVDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLEtBQUssQ0FBQyxJQUFJLENBQ25DLENBQUM7UUFDRixJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBRU0sU0FBUyxDQUFDLEtBQXVCO1FBQ3RDLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQzlDLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLEtBQUssQ0FBQyxJQUFJLENBQ25DLENB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QzVEO1NBQ0YsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVNLE1BQU0sQ0FBQyxLQUFLLENBQUMsbUJBQW1CLENBQUMsV0FBeUI7UUFDL0QsTUFBTSxJQUFBLHVCQUFhLEVBQUMsT0FBTyxFQUFFLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDO0lBQzdELENBQUM7Q0FDRjtBQS9ORCxnQ0ErTkM7QUFFRCxTQUFTLDJCQUEyQjtJQUNsQyxJQUFJLEdBQUcsQ0FBQztJQUVSLElBQUk7UUFDRixHQUFHLEdBQUcsMEJBQVcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztLQUMxQjtJQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQ1YsZ0JBQU0sQ0FBQyxLQUFLLENBQUMsNkJBQTZCLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDaEQsT0FBTyxFQUFFLENBQUM7S0FDWDtJQUVELE9BQU8sR0FBRyxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFO1FBQ3pDLE9BQU8sT0FBTyxHQUFHLEtBQUssUUFBUTtZQUM1QixDQUFDLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxHQUFHLENBQUMsVUFBVSxDQUFDLEtBQUssQ0FBQztZQUMvQyxDQUFDLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDbEUsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQ29weXJpZ2h0IChjKSBIYXNoaUNvcnAsIEluY1xuLy8gU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IE1QTC0yLjBcbmltcG9ydCAqIGFzIGZzIGZyb20gXCJmcy1leHRyYVwiO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tIFwicGF0aFwiO1xuaW1wb3J0ICogYXMgY2hhbGsgZnJvbSBcImNoYWxrXCI7XG5pbXBvcnQgaW5kZW50U3RyaW5nIGZyb20gXCJpbmRlbnQtc3RyaW5nXCI7XG5pbXBvcnQge1xuICBDT05URVhUX0VOVixcbiAgTWFuaWZlc3QsXG4gIFN0YWNrTWFuaWZlc3QsXG4gIFRlcnJhZm9ybVN0YWNrTWV0YWRhdGEsXG59IGZyb20gXCJjZGt0ZlwiO1xuaW1wb3J0IHsgcGVyZm9ybWFuY2UgfSBmcm9tIFwicGVyZl9ob29rc1wiO1xuaW1wb3J0IHsgbG9nZ2VyLCByZWFkQ29uZmlnU3luYywgc2VuZFRlbGVtZXRyeSwgc2hlbGwgfSBmcm9tIFwiQGNka3RmL2NvbW1vbnNcIjtcbmltcG9ydCB7IENka3RmQ29uZmlnIH0gZnJvbSBcIi4vY2RrdGYtY29uZmlnXCI7XG5pbXBvcnQgeyBmb3JtYXQgfSBmcm9tIFwiQGNka3RmL2hjbC10b29sc1wiO1xuXG5jb25zdCBjaGFsa0NvbG91ciA9IG5ldyBjaGFsay5JbnN0YW5jZSgpO1xuXG5leHBvcnQgaW50ZXJmYWNlIFN5bnRoZXNpemVkU3RhY2tNZXRhZGF0YSB7XG4gIFwiLy9cIj86IHsgW2tleTogc3RyaW5nXTogVGVycmFmb3JtU3RhY2tNZXRhZGF0YSB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFN5bnRoZXNpemVkU3RhY2sgZXh0ZW5kcyBTdGFja01hbmlmZXN0IHtcbiAgY29udGVudDogc3RyaW5nO1xufVxuXG5leHBvcnQgY2xhc3MgU3RhY2tEZXBlbmRlbmNpZXMge1xuICBwdWJsaWMgcGVuZGluZ1N0YWNrczogU3ludGhlc2l6ZWRTdGFja1tdID0gW107XG4gIHB1YmxpYyBpbmZsaWdodFN0YWNrczogU3ludGhlc2l6ZWRTdGFja1tdID0gW107XG4gIHB1YmxpYyBkZXBsb3llZFN0YWNrczogU3ludGhlc2l6ZWRTdGFja1tdID0gW107XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZWFkb25seSBzdGFja3M6IFN5bnRoZXNpemVkU3RhY2tbXSkge1xuICAgIHRoaXMucGVuZGluZ1N0YWNrcyA9IFsuLi50aGlzLnN0YWNrc107XG4gIH1cblxuICBwdWJsaWMgc3RhcnRSdW4oc3RhY2s6IFN5bnRoZXNpemVkU3RhY2spOiB2b2lkIHtcbiAgICB0aGlzLnBlbmRpbmdTdGFja3MgPSB0aGlzLnBlbmRpbmdTdGFja3MuZmlsdGVyKFxuICAgICAgKGl0ZW0pID0+IGl0ZW0ubmFtZSAhPT0gc3RhY2submFtZVxuICAgICk7XG4gICAgdGhpcy5pbmZsaWdodFN0YWNrcy5wdXNoKHN0YWNrKTtcbiAgfVxuXG4gIHB1YmxpYyBmaW5pc2hSdW4oc3RhY2s6IFN5bnRoZXNpemVkU3RhY2spOiB2b2lkIHtcbiAgICB0aGlzLmluZmxpZ2h0U3RhY2tzID0gdGhpcy5pbmZsaWdodFN0YWNrcy5maWx0ZXIoXG4gICAgICAoaXRlbSkgPT4gaXRlbS5uYW1lICE9PSBzdGFjay5uYW1lXG4gICAgKTtcbiAgICB0aGlzLmRlcGxveWVkU3RhY2tzLnB1c2goc3RhY2spO1xuICB9XG5cbiAgcHVibGljIGdldCBwZW5kaW5nRGVwbG95YWJsZVN0YWNrcygpOiBTeW50aGVzaXplZFN0YWNrW10ge1xuICAgIHJldHVybiB0aGlzLnBlbmRpbmdTdGFja3MuZmlsdGVyKChwZW5kaW5nU3RhY2spID0+IHtcbiAgICAgIGNvbnN0IHVubWV0RGVwZW5kZW5jaWVzID0gcGVuZGluZ1N0YWNrLmRlcGVuZGVuY2llcy5maWx0ZXIoXG4gICAgICAgIChkZXBlbmRlbmN5KSA9PiB7XG4gICAgICAgICAgcmV0dXJuICF0aGlzLmRlcGxveWVkU3RhY2tzLnNvbWUoKGRlcGxveWVkU3RhY2spID0+IHtcbiAgICAgICAgICAgIHJldHVybiBkZXBsb3llZFN0YWNrLm5hbWUgPT09IGRlcGVuZGVuY3k7XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICk7XG5cbiAgICAgIHJldHVybiB1bm1ldERlcGVuZGVuY2llcy5sZW5ndGggPT09IDA7XG4gICAgfSk7XG4gIH1cbn1cblxuaW50ZXJmYWNlIE1hbmlmZXN0SnNvbiB7XG4gIHZlcnNpb246IHN0cmluZztcbiAgc3RhY2tzOiBTdGFja01hbmlmZXN0W107XG59XG5cbmV4cG9ydCB0eXBlIFN5bnRoT3JpZ2luID0gXCJ3YXRjaFwiO1xuXG5leHBvcnQgY2xhc3MgU3ludGhTdGFjayB7XG4gIHB1YmxpYyBzdGF0aWMgYXN5bmMgc3ludGgoXG4gICAgYWJvcnRTaWduYWw6IEFib3J0U2lnbmFsLFxuICAgIGNvbW1hbmQ6IHN0cmluZyxcbiAgICBvdXRkaXI6IHN0cmluZyxcbiAgICB3b3JraW5nRGlyZWN0b3J5ID0gcHJvY2Vzcy5jd2QoKSxcbiAgICBncmFjZWZ1bCA9IGZhbHNlLCAvLyB3aWxsIG5vdCBleGl0IHRoZSBwcm9jZXNzIGJ1dCByZXRocm93IHRoZSBlcnJvciBpbnN0ZWFkXG4gICAgbm9Db2xvciA9IGZhbHNlLFxuICAgIHN5bnRoT3JpZ2luPzogU3ludGhPcmlnaW4sXG4gICAgaGNsID0gZmFsc2VcbiAgKTogUHJvbWlzZTxTeW50aGVzaXplZFN0YWNrW10+IHtcbiAgICAvLyBzdGFydCBwZXJmb3JtYW5jZSB0aW1lclxuICAgIGNvbnN0IHN0YXJ0VGltZSA9IHBlcmZvcm1hbmNlLm5vdygpO1xuXG4gICAgY29uc3QgaXNEaXJlY3RvcnkgPSAoc291cmNlOiBzdHJpbmcpID0+IGZzLmxzdGF0U3luYyhzb3VyY2UpLmlzRGlyZWN0b3J5KCk7XG4gICAgY29uc3QgZ2V0RGlyZWN0b3JpZXMgPSAoc291cmNlOiBzdHJpbmcpID0+IHtcbiAgICAgIGlmICghZnMuZXhpc3RzU3luYyhzb3VyY2UpKSByZXR1cm4gW107XG4gICAgICByZXR1cm4gZnNcbiAgICAgICAgLnJlYWRkaXJTeW5jKHNvdXJjZSlcbiAgICAgICAgLm1hcCgobmFtZSkgPT4gcGF0aC5qb2luKHNvdXJjZSwgbmFtZSkpXG4gICAgICAgIC5maWx0ZXIoaXNEaXJlY3RvcnkpO1xuICAgIH07XG5cbiAgICBjb25zdCBleGlzdGluZ0RpcmVjdG9yaWVzID0gZ2V0RGlyZWN0b3JpZXMoXG4gICAgICBwYXRoLmpvaW4ob3V0ZGlyLCBNYW5pZmVzdC5zdGFja3NGb2xkZXIpXG4gICAgKTtcblxuICAgIGNvbnN0IGVudiA9IE9iamVjdC5mcm9tRW50cmllcyhcbiAgICAgIE9iamVjdC5lbnRyaWVzKHByb2Nlc3MuZW52KS5maWx0ZXIoXG4gICAgICAgIC8vIFdlIGRvbid0IHdhbnQgdG8gcGFzcyBUZXJyYWZvcm0gdmFyaWFibGVzIHRvIHRoZSBzeW50aCBjb21tYW5kIHNpbmNlIHRoZXkgc2hvdWxkIG9ubHkgYmUgdXNlZCBhdCBleGVjdXRpb24gdGltZVxuICAgICAgICAoW2tleV0pID0+ICFrZXkuc3RhcnRzV2l0aChcIlRGX1ZBUl9cIilcbiAgICAgIClcbiAgICApO1xuXG4gICAgLy8gSW5jcmVhc2VzIHRoZSBkZWZhdWx0IG1lbW9yeSBhdmFpbGFibGUgdG8gTm9kZS5qcyB3aGVuIHN5bnRoZXNpemluZyBhIFR5cGVTY3JpcHQgQ0RLIHByb2plY3QuXG4gICAgY29uc3Qgbm9kZU9wdHNTd2l0Y2ggPSBcIi0tbWF4LW9sZC1zcGFjZS1zaXplXCI7XG4gICAgY29uc3Qgbm9kZU9wdHNTZXR0aW5nID0gYCR7bm9kZU9wdHNTd2l0Y2h9PTQwOTZgO1xuICAgIGlmIChlbnYuTk9ERV9PUFRJT05TICYmICFlbnYuTk9ERV9PUFRJT05TLmluY2x1ZGVzKG5vZGVPcHRzU3dpdGNoKSkge1xuICAgICAgbG9nZ2VyLndhcm4oYFdBUk5JTkc6IEZvdW5kIE5PREVfT1BUSU9OUyBlbnZpcm9ubWVudCB2YXJpYWJsZSB3aXRob3V0IGEgc2V0dGluZyBmb3IgJHtub2RlT3B0c1N3aXRjaH1cblRoZSBzeW50aGVzaXppbmcgc3RlcCBmb3IgVHlwZVNjcmlwdCBtYXkgbmVlZCBhbiBpbmNyZWFzZWQgYW1vdW50IG9mIG1lbW9yeSBpZiBtdWx0aXBsZSBsYXJnZSBwcm92aWRlcnNcbmFyZSB1c2VkIHdpdGggbG9jYWxseSBnZW5lcmF0ZWQgYmluZGluZ3MuIFlvdSBjYW4gaWdub3JlIHRoaXMgaWYgeW91IGRvbid0IHVzZSBDREtURiB3aXRoIFR5cGVTY3JpcHQuXG5JZiBub3QgcHJlc2VudCwgdGhlIGNka3RmLWNsaSBzZXRzIGl0IHRvIE5PREVfT1BUSU9OUz1cIiR7bm9kZU9wdHNTZXR0aW5nfVwiIGJ5IGRlZmF1bHQuIEJ1dCBhc1xueW91ciBlbnZpcm9ubWVudCBhbHJlYWR5IGNvbnRhaW5zIGEgTk9ERV9PUFRJT05TIHZhcmlhYmxlLCB3ZSB3b24ndCBvdmVycmlkZSBpdC4gSGVuY2UsIHRoZSBhcHAgY29tbWFuZFxubWlnaHQgZmFpbCB3aGlsZSBzeW50aGVzaXppbmcgd2l0aCBhbiBvdXQgb2YgbWVtb3J5IGVycm9yLmApO1xuICAgIH0gZWxzZSBpZiAoIWVudi5OT0RFX09QVElPTlMpIHtcbiAgICAgIC8vIGluY3JlYXNlIG1lbW9yeSB0byBhbGxvdyB0cy1ub2RlICh3aGVuIHVzaW5nIFR5cGVTY3JpcHQpIHRvIGhhbmRsZSBsYXJnZSBhbW91bnRzIG9mIGdlbmVyYXRlZCBjb2RlIGluIG1lbW9yeVxuICAgICAgZW52Lk5PREVfT1BUSU9OUyA9IGAke2Vudi5OT0RFX09QVElPTlMgfHwgXCJcIn0gJHtub2RlT3B0c1NldHRpbmd9YC50cmltKCk7XG4gICAgfVxuXG4gICAgY29uc3QgY3VycmVudENvbnRleHQgPSBwcm9jZXNzLmVudltDT05URVhUX0VOVl1cbiAgICAgID8gSlNPTi5wYXJzZShwcm9jZXNzLmVudi5DREtURl9DT05URVhUX0pTT04pXG4gICAgICA6IHt9O1xuICAgIGNvbnN0IHJlbGF0aXZlTW9kdWxlcyA9IGdldFJlbGF0aXZlVGVycmFmb3JtTW9kdWxlcygpO1xuXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHNoZWxsKGNvbW1hbmQsIFtdLCB7XG4gICAgICAgIHNoZWxsOiB0cnVlLFxuICAgICAgICBlbnY6IHtcbiAgICAgICAgICAuLi5lbnYsXG4gICAgICAgICAgQ0RLVEZfT1VURElSOiBvdXRkaXIsXG4gICAgICAgICAgQ0RLVEZfQ09OVElOVUVfU1lOVEhfT05fRVJST1JfQU5OT1RBVElPTlM6IFwidHJ1ZVwiLCAvLyB3ZSB3YW50IHRvIGRpc3BsYXkgdGhlIGVycm9ycyBvdXJzZWx2ZXNcbiAgICAgICAgICBbQ09OVEVYVF9FTlZdOiBKU09OLnN0cmluZ2lmeSh7XG4gICAgICAgICAgICAuLi5jdXJyZW50Q29udGV4dCxcbiAgICAgICAgICAgIGNka3RmUmVsYXRpdmVNb2R1bGVzOiByZWxhdGl2ZU1vZHVsZXMsXG4gICAgICAgICAgfSksXG4gICAgICAgICAgU1lOVEhfSENMX09VVFBVVDogaGNsLnRvU3RyaW5nKCksXG4gICAgICAgIH0sXG4gICAgICAgIGN3ZDogd29ya2luZ0RpcmVjdG9yeSxcbiAgICAgICAgc2lnbmFsOiBhYm9ydFNpZ25hbCxcbiAgICAgICAgbm9Db2xvcjogbm9Db2xvcixcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGU6IGFueSkge1xuICAgICAgY29uc3QgZXJyb3JPdXRwdXQgPSBjaGFsa0NvbG91cmB7cmVkQnJpZ2h0IGNka3RmIGVuY291bnRlcmVkIGFuIGVycm9yIHdoaWxlIHN5bnRoZXNpemluZ31cblxuU3ludGggY29tbWFuZDoge2JsdWUgJHtjb21tYW5kfX1cbkVycm9yOiAgICAgICAgIHtyZWRCcmlnaHQgJHtlLm1lc3NhZ2V9fVxuJHtcbiAgZS5zdGRlcnJcbiAgICA/IGNoYWxrQ29sb3VyYFxuQ29tbWFuZCBvdXRwdXQgb24gc3RkZXJyOlxuXG57ZGltICR7aW5kZW50U3RyaW5nKGUuc3RkZXJyLCA0KX19XG5gXG4gICAgOiBcIlwiXG59XG4ke1xuICBlLnN0ZG91dFxuICAgID8gY2hhbGtDb2xvdXJgXG5Db21tYW5kIG91dHB1dCBvbiBzdGRvdXQ6XG5cbntkaW0gJHtpbmRlbnRTdHJpbmcoZS5zdGRvdXQsIDQpfX1cbmBcbiAgICA6IFwiXCJcbn1gO1xuICAgICAgYXdhaXQgdGhpcy5zeW50aEVycm9yVGVsZW1ldHJ5KHN5bnRoT3JpZ2luKTtcbiAgICAgIGlmIChncmFjZWZ1bCkge1xuICAgICAgICBlLmVycm9yT3V0cHV0ID0gZXJyb3JPdXRwdXQ7XG4gICAgICAgIHRocm93IGU7XG4gICAgICB9XG4gICAgICBjb25zb2xlLmVycm9yKGBFUlJPUjogJHtlcnJvck91dHB1dH1gKTtcbiAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICB9XG5cbiAgICAvLyBBcHBseSBmb3JtYXR0aW5nIHRvIEhDTCBmaWxlcyBpZiBoY2wgb3V0cHV0IHdhcyBzZWxlY3RlZFxuICAgIGlmIChoY2wpIHtcbiAgICAgIGF3YWl0IFN5bnRoU3RhY2suZm9ybWF0SGNsRmlsZXMob3V0ZGlyKTtcbiAgICB9XG5cbiAgICAvLyBlbmQgcGVyZm9ybWFuY2UgdGltZXJcbiAgICBjb25zdCBlbmRUaW1lID0gcGVyZm9ybWFuY2Uubm93KCk7XG5cbiAgICBsZXQgc3RhY2tzOiBTeW50aGVzaXplZFN0YWNrW10gPSBbXTtcbiAgICB0cnkge1xuICAgICAgc3RhY2tzID0gYXdhaXQgU3ludGhTdGFjay5yZWFkU3ludGhlc2l6ZWRTdGFja3Mob3V0ZGlyKTtcbiAgICB9IGNhdGNoIChlOiBhbnkpIHtcbiAgICAgIGNvbnN0IGVycm9yTWVzc2FnZSA9IGBFUlJPUjogc3ludGhlc2lzIGZhaWxlZCwgYmVjYXVzZSBhcHAgd2FzIGV4cGVjdGVkIHRvIGNhbGwgJ3N5bnRoKCknLCBidXQgZGlkbid0LiBUaHVzIFwiJHtvdXRkaXJ9LyR7TWFuaWZlc3QuZmlsZU5hbWV9XCIgIHdhcyBub3QgY3JlYXRlZDogJHtlfWA7XG4gICAgICBpZiAoZ3JhY2VmdWwpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yTWVzc2FnZSk7XG4gICAgICB9XG4gICAgICBsb2dnZXIuZXJyb3IoZXJyb3JNZXNzYWdlKTtcbiAgICAgIHByb2Nlc3MuZXhpdCgxKTtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLnN5bnRoVGVsZW1ldHJ5KGVuZFRpbWUgLSBzdGFydFRpbWUsIHN0YWNrcywgc3ludGhPcmlnaW4pO1xuXG4gICAgaWYgKHN0YWNrcy5sZW5ndGggPT09IDApIHtcbiAgICAgIGxvZ2dlci5lcnJvcihcIkVSUk9SOiBObyBUZXJyYWZvcm0gY29kZSBzeW50aGVzaXplZC5cIik7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RhY2tOYW1lcyA9IHN0YWNrcy5tYXAoKHMpID0+IHMubmFtZSk7XG4gICAgY29uc3Qgb3JwaGFuZWREaXJlY3RvcmllcyA9IGV4aXN0aW5nRGlyZWN0b3JpZXMuZmlsdGVyKFxuICAgICAgKGUpID0+ICFzdGFja05hbWVzLmluY2x1ZGVzKHBhdGguYmFzZW5hbWUoZSkpXG4gICAgKTtcblxuICAgIGZvciAoY29uc3Qgb3JwaGFuZWREaXJlY3Rvcnkgb2Ygb3JwaGFuZWREaXJlY3Rvcmllcykge1xuICAgICAgZnMucm1TeW5jKG9ycGhhbmVkRGlyZWN0b3J5LCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gc3RhY2tzO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBhc3luYyBmb3JtYXRIY2xGaWxlcyhvdXREaXI6IHN0cmluZykge1xuICAgIGNvbnN0IG1hbmlmZXN0UGF0aCA9IHBhdGguam9pbihvdXREaXIsIE1hbmlmZXN0LmZpbGVOYW1lKTtcbiAgICBpZiAoIShhd2FpdCBmcy5wYXRoRXhpc3RzKG1hbmlmZXN0UGF0aCkpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgIGBDb3VsZCBub3QgZmluZCBtYW5pZmVzdCBmaWxlIGF0ICR7bWFuaWZlc3RQYXRofS4gSW4gY2FzZSAtLXNraXAtc3ludGggd2FzIHBhc3NlZCwgcGxlYXNlIHRyeSBhZ2FpbiB3aXRob3V0IHRoZSBmbGFnLmBcbiAgICAgICk7XG4gICAgfVxuXG4gICAgY29uc3QgbWFuaWZlc3QgPSBKU09OLnBhcnNlKFxuICAgICAgZnMucmVhZEZpbGVTeW5jKG1hbmlmZXN0UGF0aCkudG9TdHJpbmcoKVxuICAgICkgYXMgTWFuaWZlc3RKc29uO1xuXG4gICAgZm9yIChjb25zdCBzdGFja05hbWUgaW4gbWFuaWZlc3Quc3RhY2tzKSB7XG4gICAgICBjb25zdCBzdGFjayA9IG1hbmlmZXN0LnN0YWNrc1tzdGFja05hbWVdO1xuICAgICAgY29uc3QgZmlsZVBhdGggPSBwYXRoLmpvaW4ob3V0RGlyLCBzdGFjay5zeW50aGVzaXplZFN0YWNrUGF0aCk7XG5cbiAgICAgIGNvbnN0IGhjbENvbnRlbnQgPSBmcy5yZWFkRmlsZVN5bmMoZmlsZVBhdGgpLnRvU3RyaW5nKCk7XG4gICAgICBjb25zdCBmb3JtYXR0ZWRIY2wgPSBhd2FpdCBmb3JtYXQoaGNsQ29udGVudCk7XG4gICAgICBmcy53cml0ZUZpbGVTeW5jKGZpbGVQYXRoLCBmb3JtYXR0ZWRIY2wpO1xuICAgIH1cbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgYXN5bmMgcmVhZFN5bnRoZXNpemVkU3RhY2tzKFxuICAgIG91dGRpcjogc3RyaW5nXG4gICk6IFByb21pc2U8U3ludGhlc2l6ZWRTdGFja1tdPiB7XG4gICAgY29uc3QgbWFuaWZlc3RQYXRoID0gcGF0aC5qb2luKG91dGRpciwgTWFuaWZlc3QuZmlsZU5hbWUpO1xuICAgIGlmICghKGF3YWl0IGZzLnBhdGhFeGlzdHMobWFuaWZlc3RQYXRoKSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYENvdWxkIG5vdCBmaW5kIG1hbmlmZXN0IGZpbGUgYXQgJHttYW5pZmVzdFBhdGh9LiBJbiBjYXNlIC0tc2tpcC1zeW50aCB3YXMgcGFzc2VkLCBwbGVhc2UgdHJ5IGFnYWluIHdpdGhvdXQgdGhlIGZsYWcuYFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCBzdGFja3M6IFN5bnRoZXNpemVkU3RhY2tbXSA9IFtdO1xuICAgIGNvbnN0IG1hbmlmZXN0ID0gSlNPTi5wYXJzZShcbiAgICAgIGZzLnJlYWRGaWxlU3luYyhtYW5pZmVzdFBhdGgpLnRvU3RyaW5nKClcbiAgICApIGFzIE1hbmlmZXN0SnNvbjtcblxuICAgIGZvciAoY29uc3Qgc3RhY2tOYW1lIGluIG1hbmlmZXN0LnN0YWNrcykge1xuICAgICAgY29uc3Qgc3RhY2sgPSBtYW5pZmVzdC5zdGFja3Nbc3RhY2tOYW1lXTtcbiAgICAgIGNvbnN0IGZpbGVQYXRoID0gcGF0aC5qb2luKG91dGRpciwgc3RhY2suc3ludGhlc2l6ZWRTdGFja1BhdGgpO1xuICAgICAgbGV0IGpzb25Db250ZW50OiBTeW50aGVzaXplZFN0YWNrTWV0YWRhdGEgPSB7fTtcbiAgICAgIGlmIChmaWxlUGF0aC5lbmRzV2l0aChcIi50Zi5qc29uXCIpKSB7XG4gICAgICAgIGpzb25Db250ZW50ID0gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMoZmlsZVBhdGgpLnRvU3RyaW5nKCkpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgbWV0YWRhdGFQYXRoID0gcGF0aC5qb2luKG91dGRpciwgc3RhY2suc3RhY2tNZXRhZGF0YVBhdGghKTtcbiAgICAgICAganNvbkNvbnRlbnQgPSBKU09OLnBhcnNlKGZzLnJlYWRGaWxlU3luYyhtZXRhZGF0YVBhdGgpLnRvU3RyaW5nKCkpO1xuICAgICAgfVxuXG4gICAgICBzdGFja3MucHVzaCh7XG4gICAgICAgIC4uLnN0YWNrLFxuICAgICAgICB3b3JraW5nRGlyZWN0b3J5OiBwYXRoLmpvaW4ob3V0ZGlyLCBzdGFjay53b3JraW5nRGlyZWN0b3J5KSxcbiAgICAgICAgY29udGVudDogSlNPTi5zdHJpbmdpZnkoanNvbkNvbnRlbnQsIG51bGwsIDIpLFxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHN0YWNrcztcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgYXN5bmMgc3ludGhUZWxlbWV0cnkoXG4gICAgdG90YWxUaW1lOiBudW1iZXIsXG4gICAgc3RhY2tzOiBTeW50aGVzaXplZFN0YWNrW10sXG4gICAgc3ludGhPcmlnaW4/OiBTeW50aE9yaWdpblxuICApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBjb25maWcgPSByZWFkQ29uZmlnU3luYygpO1xuXG4gICAgYXdhaXQgc2VuZFRlbGVtZXRyeShcInN5bnRoXCIsIHtcbiAgICAgIHRvdGFsVGltZTogdG90YWxUaW1lLFxuICAgICAgbGFuZ3VhZ2U6IGNvbmZpZy5sYW5ndWFnZSxcbiAgICAgIHN5bnRoT3JpZ2luLFxuICAgICAgc3RhY2tNZXRhZGF0YTogc3RhY2tzLm1hcChcbiAgICAgICAgKHN0YWNrKSA9PiBKU09OLnBhcnNlKHN0YWNrLmNvbnRlbnQpW1wiLy9cIl0ubWV0YWRhdGFcbiAgICAgICksXG4gICAgICByZXF1aXJlZFByb3ZpZGVyczogc3RhY2tzLm1hcChcbiAgICAgICAgKHN0YWNrOiBhbnkpID0+XG4gICAgICAgICAgSlNPTi5wYXJzZShzdGFjay5jb250ZW50KVtcInRlcnJhZm9ybVwiXS5yZXF1aXJlZF9wcm92aWRlcnNcbiAgICAgICksXG4gICAgfSk7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGFzeW5jIHN5bnRoRXJyb3JUZWxlbWV0cnkoc3ludGhPcmlnaW4/OiBTeW50aE9yaWdpbikge1xuICAgIGF3YWl0IHNlbmRUZWxlbWV0cnkoXCJzeW50aFwiLCB7IGVycm9yOiB0cnVlLCBzeW50aE9yaWdpbiB9KTtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRSZWxhdGl2ZVRlcnJhZm9ybU1vZHVsZXMoKSB7XG4gIGxldCBjZmc7XG5cbiAgdHJ5IHtcbiAgICBjZmcgPSBDZGt0ZkNvbmZpZy5yZWFkKCk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2dnZXIudHJhY2UoXCJDb3VsZCBub3QgcmVhZCBjZGt0Zi5qc29uOiBcIiArIGUpO1xuICAgIHJldHVybiBbXTtcbiAgfVxuXG4gIHJldHVybiBjZmcudGVycmFmb3JtTW9kdWxlcy5maWx0ZXIoKG1vZCkgPT4ge1xuICAgIHJldHVybiB0eXBlb2YgbW9kID09PSBcInN0cmluZ1wiXG4gICAgICA/IG1vZC5zdGFydHNXaXRoKFwiLi9cIikgfHwgbW9kLnN0YXJ0c1dpdGgoXCIuLi9cIilcbiAgICAgIDogbW9kLnNvdXJjZS5zdGFydHNXaXRoKFwiLi9cIikgfHwgbW9kLnNvdXJjZS5zdGFydHNXaXRoKFwiLi4vXCIpO1xuICB9KTtcbn1cbiJdfQ==