"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || function (mod) {
    if (mod && mod.__esModule) return mod;
    var result = {};
    if (mod != null) for (var k in mod) if (k !== "default" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);
    __setModuleDefault(result, mod);
    return result;
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.tryRemoveGeneratedConfigurationFile = exports.tryReadGeneratedConfigurationFile = exports.TerraformCli = exports.TerraformCliPlan = void 0;
// Copyright (c) HashiCorp, Inc
// SPDX-License-Identifier: MPL-2.0
const strip_ansi_1 = __importDefault(require("strip-ansi"));
const commons_1 = require("@cdktf/commons");
const terraform_1 = require("./terraform");
const deploy_machine_1 = require("./deploy-machine");
const waitFor_1 = require("xstate/lib/waitFor");
const errors_1 = require("../errors");
const terraform_json_1 = require("../terraform-json");
const pty_process_1 = require("./pty-process");
const path_1 = __importDefault(require("path"));
const fs = __importStar(require("fs-extra"));
const GENERATE_CONFIG_OUT_FILE = "generated_resources.tf";
class TerraformCliPlan extends terraform_1.AbstractTerraformPlan {
    constructor(planFile, plan) {
        super(planFile, plan === null || plan === void 0 ? void 0 : plan.resource_changes, plan === null || plan === void 0 ? void 0 : plan.output_changes);
        this.planFile = planFile;
        this.plan = plan;
    }
}
exports.TerraformCliPlan = TerraformCliPlan;
class AbstractOutputFilter {
}
// The plan might error if there is a variable missing, but the error message hints the user
// in a wrong direction. We therefore catch the error and rethrow it with a more helpful message
class VariableRequiredFilter extends AbstractOutputFilter {
    // Example for "No value for required variable" error
    // ╷
    // │ Error: No value for required variable
    // │
    // │   on cdk.tf.json line 31, in variable:
    // │   31:     "with-dashes": {
    // │
    // │ The root module input variable "with-dashes" is not set, and has no default
    // │ value. Use a -var or -var-file command line argument to provide a value for
    // │ this variable
    static condition(input) {
        const line = (0, strip_ansi_1.default)(input);
        return (line.includes("Error: No value for required variable") &&
            line.includes("The root module input variable"));
    }
    static transform(line) {
        const startMarker = 'The root module input variable "';
        const variableName = line.substring(line.indexOf(startMarker) + startMarker.length, line.indexOf('" is not set'));
        return (0, errors_1.missingVariable)(variableName);
    }
}
class TerraformCli {
    constructor(abortSignal, stack, createTerraformLogHandler = (_phase, _filter) => (_stdout, _isErr = false) => { } // eslint-disable-line @typescript-eslint/no-empty-function
    ) {
        this.abortSignal = abortSignal;
        this.stack = stack;
        this.workdir = stack.workingDirectory;
        this.onStdout =
            (phase, filter) => (stdout) => createTerraformLogHandler(phase, filter)(Buffer.isBuffer(stdout) ? stdout.toString() : stdout);
        this.onStderr =
            (phase, filter) => (stderr) => createTerraformLogHandler(phase, filter)(stderr.toString(), true);
    }
    async init(opts) {
        await this.setUserAgent();
        const args = ["init"];
        if (opts.needsUpgrade) {
            args.push("-upgrade");
        }
        if (opts.noColor) {
            args.push("-no-color");
        }
        // eslint-disable-next-line @typescript-eslint/no-empty-function
        let initCanNotContinue = (_err) => { };
        const rejectsIfInitCanNotContinue = new Promise((_resolve, reject) => {
            initCanNotContinue = reject;
        });
        const stdout = this.onStdout("init");
        const { actions, exitCode } = (0, pty_process_1.spawnPty)({
            file: commons_1.terraformBinaryName,
            args,
            options: {
                cwd: this.workdir,
                env: process.env,
            },
        }, (data) => {
            stdout(data);
            if (data.includes("Should Terraform migrate your existing state?")) {
                if (opts.migrateState) {
                    actions.writeLine("yes");
                }
                else {
                    actions.stop();
                    initCanNotContinue("Please pass the --migrate-state flag to migrate your state");
                }
            }
        });
        this.abortSignal.addEventListener("abort", () => {
            actions.stop();
        });
        const progress = exitCode.then((code) => {
            if (code !== 0) {
                throw new Error(`terraform init failed with exit code ${code}`);
            }
        });
        await Promise.race([progress, rejectsIfInitCanNotContinue]);
        // TODO: this might have performance implications because we don't know if we're
        // running a remote plan or a local one (so we run it always for all platforms)
        // while we'd only need it for remote plans
        if (opts.needsLockfileUpdate) {
            await (0, commons_1.exec)(commons_1.terraformBinaryName, [
                "providers",
                "lock",
                "-platform=linux_amd64",
                ...(opts.noColor ? ["-no-color"] : []),
            ], {
                cwd: this.workdir,
                env: process.env,
                signal: this.abortSignal,
                noColor: opts.noColor,
            }, this.onStdout("init"), this.onStderr("init"));
        }
    }
    get isCloudStack() {
        var _a, _b, _c;
        const parsedStack = terraform_json_1.terraformJsonSchema.parse(JSON.parse(this.stack.content));
        return Boolean(((_b = (_a = parsedStack.terraform) === null || _a === void 0 ? void 0 : _a.backend) === null || _b === void 0 ? void 0 : _b.remote) || ((_c = parsedStack.terraform) === null || _c === void 0 ? void 0 : _c.cloud));
    }
    get hasImports() {
        const parsedStack = terraform_json_1.terraformJsonSchema.parse(JSON.parse(this.stack.content));
        return Boolean(parsedStack.import);
    }
    async plan(opts) {
        const { destroy = false, refreshOnly = false, parallelism = -1, vars = [], varFiles = [], noColor = false, } = opts;
        const options = ["plan", "-input=false"];
        const generatedConfigFile = path_1.default.join(this.workdir, GENERATE_CONFIG_OUT_FILE);
        if (fs.existsSync(generatedConfigFile)) {
            fs.remove(generatedConfigFile);
        }
        if (this.hasImports) {
            options.push(`-generate-config-out=${GENERATE_CONFIG_OUT_FILE}`);
        }
        if (!this.isCloudStack) {
            const planFile = "plan";
            options.push("-out", planFile);
        }
        if (destroy) {
            options.push("-destroy");
        }
        if (refreshOnly) {
            options.push("-refresh-only");
        }
        if (parallelism > -1) {
            options.push(`-parallelism=${parallelism}`);
        }
        if (noColor) {
            options.push("-no-color");
        }
        vars.forEach((v) => options.push(`-var=${v}`));
        varFiles.forEach((v) => options.push(`-var-file=${v}`));
        commons_1.logger.debug(`Executing ${commons_1.terraformBinaryName} ${options.join(" ")} in ${this.workdir}`);
        await this.setUserAgent();
        await (0, commons_1.exec)(commons_1.terraformBinaryName, options, {
            cwd: this.workdir,
            env: process.env,
            signal: this.abortSignal,
            noColor,
        }, this.onStdout("plan", [VariableRequiredFilter]), this.onStderr("plan", [VariableRequiredFilter]));
    }
    async deploy({ autoApprove = false, refreshOnly = false, noColor = false, parallelism = -1, extraOptions = [], vars = [], varFiles = [], }, callback) {
        await this.setUserAgent();
        const service = (0, deploy_machine_1.createAndStartDeployService)({
            terraformBinaryName: commons_1.terraformBinaryName,
            workdir: this.workdir,
            refreshOnly,
            noColor,
            autoApprove,
            parallelism,
            extraOptions,
            vars,
            varFiles,
        });
        return this.handleService("deploy", service, callback);
    }
    async destroy({ autoApprove = false, parallelism = -1, noColor = false, extraOptions = [], vars = [], varFiles = [], }, callback) {
        await this.setUserAgent();
        const service = (0, deploy_machine_1.createAndStartDestroyService)({
            terraformBinaryName: commons_1.terraformBinaryName,
            workdir: this.workdir,
            autoApprove,
            parallelism,
            noColor,
            extraOptions,
            vars,
            varFiles,
        });
        return this.handleService("destroy", service, callback);
    }
    async handleService(type, service, callback) {
        // stop terraform apply if signaled as such from the outside (e.g. via ctrl+c)
        this.abortSignal.addEventListener("abort", () => {
            service.send("STOP");
        }, { once: true });
        // relay logs to stdout
        service.onEvent((event) => {
            commons_1.logger.trace(`Terraform CLI state machine event: ${JSON.stringify(event)}`);
            if ((0, deploy_machine_1.isDeployEvent)(event, "OUTPUT_RECEIVED"))
                this.onStdout(type)(event.output);
            else if ((0, deploy_machine_1.isDeployEvent)(event, "APPROVED_EXTERNALLY"))
                callback({ type: "external approval reply", approved: true });
            else if ((0, deploy_machine_1.isDeployEvent)(event, "REJECTED_EXTERNALLY"))
                callback({ type: "external approval reply", approved: false });
            else if ((0, deploy_machine_1.isDeployEvent)(event, "OVERRIDDEN_EXTERNALLY"))
                callback({
                    type: "external sentinel override reply",
                    overridden: true,
                });
            else if ((0, deploy_machine_1.isDeployEvent)(event, "OVERRIDE_REJECTED_EXTERNALLY"))
                callback({
                    type: "external sentinel override reply",
                    overridden: false,
                });
        });
        let previousState = "idle";
        service.onTransition((state) => {
            // only send updates on actual state change
            // onTransition is called even if the state didn't change but only an event happened
            if (state.matches(previousState))
                return;
            commons_1.logger.trace(`Terraform CLI state machine state transition: ${JSON.stringify(previousState)} => ${JSON.stringify(state.value)}`);
            if (state.matches({ running: "awaiting_approval" })) {
                callback({
                    type: "waiting for approval",
                    approve: () => service.send("APPROVE"),
                    reject: () => service.send("REJECT"),
                });
            }
            else if (state.matches({ running: "awaiting_sentinel_override" })) {
                callback({
                    type: "waiting for sentinel override",
                    override: () => service.send("OVERRIDE"),
                    reject: () => service.send("REJECT_OVERRIDE"),
                });
            }
            else if (state.matches({ running: "processing" })) {
                callback({
                    type: "running",
                    cancelled: Boolean(state.context.cancelled),
                });
            }
            previousState = state.value;
        });
        service.start();
        const state = await (0, waitFor_1.waitFor)(service, (state) => !!state.done, {
            timeout: Infinity,
        });
        commons_1.logger.trace(`Invoking Terraform CLI for ${type} done (state machine reached final state). Last event: ${JSON.stringify(state.event)}. Context: ${JSON.stringify(state.context)}`);
        // example events: { type: 'EXITED', exitCode: 0 }, { type: 'EXTERNAL_REJECT' }
        if (state.event.type === "EXITED" &&
            state.event.exitCode !== 0 &&
            !state.context.cancelled // don't fail if we cancelled the run
        ) {
            throw `Invoking Terraform CLI failed with exit code ${state.event.exitCode}`;
        }
        return { cancelled: Boolean(state.context.cancelled) };
    }
    async version() {
        try {
            return await (0, commons_1.exec)(commons_1.terraformBinaryName, ["-v"], {
                cwd: this.workdir,
                env: process.env,
                signal: this.abortSignal,
                noColor: true,
            }, this.onStdout("version"), this.onStderr("version"));
        }
        catch (_a) {
            throw new Error("Terraform CLI not present - Please install a current version https://learn.hashicorp.com/terraform/getting-started/install.html");
        }
    }
    async output() {
        const output = await (0, commons_1.exec)(commons_1.terraformBinaryName, ["output", "-json"], {
            cwd: this.workdir,
            env: process.env,
            signal: this.abortSignal,
            noColor: true,
        }, 
        // We don't need to log the output here since we use it later on
        () => { }, // eslint-disable-line @typescript-eslint/no-empty-function
        this.onStderr("output"));
        try {
            return JSON.parse(output);
        }
        catch (e) {
            throw commons_1.Errors.External(`Failed to parse terraform output: ${e}. The output was '${output}'`);
        }
    }
    async setUserAgent() {
        // Read the cdktf version from the 'cdk.tf.json' file
        // and set the user agent.
        const version = await (0, commons_1.readCDKTFVersion)(this.workdir);
        if (version != "") {
            process.env.TF_APPEND_USER_AGENT =
                "cdktf/" + version + " (+https://github.com/hashicorp/terraform-cdk)";
        }
    }
    // We don't need to clean anything up for a running execution in the CLI since there is no left-over state in contrast to an open Terraform Cloud run
    async abort() {
        return;
    }
}
exports.TerraformCli = TerraformCli;
async function tryReadGeneratedConfigurationFile(workingDir) {
    const generatedConfigPath = path_1.default.join(workingDir, GENERATE_CONFIG_OUT_FILE);
    if (!fs.existsSync(generatedConfigPath)) {
        return null;
    }
    return fs.readFileSync(generatedConfigPath, "utf-8");
}
exports.tryReadGeneratedConfigurationFile = tryReadGeneratedConfigurationFile;
async function tryRemoveGeneratedConfigurationFile(workingDir) {
    const generatedConfigPath = path_1.default.join(workingDir, GENERATE_CONFIG_OUT_FILE);
    if (fs.existsSync(generatedConfigPath)) {
        fs.unlinkSync(generatedConfigPath);
    }
}
exports.tryRemoveGeneratedConfigurationFile = tryRemoveGeneratedConfigurationFile;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVycmFmb3JtLWNsaS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInRlcnJhZm9ybS1jbGkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQSwrQkFBK0I7QUFDL0IsbUNBQW1DO0FBQ25DLDREQUFtQztBQUNuQyw0Q0FNd0I7QUFDeEIsMkNBTXFCO0FBRXJCLHFEQUswQjtBQUMxQixnREFBNkM7QUFDN0Msc0NBQTRDO0FBQzVDLHNEQUF3RDtBQUN4RCwrQ0FBeUM7QUFDekMsZ0RBQXdCO0FBQ3hCLDZDQUErQjtBQUUvQixNQUFNLHdCQUF3QixHQUFHLHdCQUF3QixDQUFDO0FBRTFELE1BQWEsZ0JBQ1gsU0FBUSxpQ0FBcUI7SUFHN0IsWUFDa0IsUUFBZ0IsRUFDaEIsSUFBNEI7UUFFNUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxJQUFJLGFBQUosSUFBSSx1QkFBSixJQUFJLENBQUUsZ0JBQWdCLEVBQUUsSUFBSSxhQUFKLElBQUksdUJBQUosSUFBSSxDQUFFLGNBQWMsQ0FBQyxDQUFDO1FBSDlDLGFBQVEsR0FBUixRQUFRLENBQVE7UUFDaEIsU0FBSSxHQUFKLElBQUksQ0FBd0I7SUFHOUMsQ0FBQztDQUNGO0FBVkQsNENBVUM7QUFFRCxNQUFlLG9CQUFvQjtDQUdsQztBQUdELDRGQUE0RjtBQUM1RixnR0FBZ0c7QUFDaEcsTUFBTSxzQkFBdUIsU0FBUSxvQkFBb0I7SUFDdkQscURBQXFEO0lBQ3JELElBQUk7SUFDSiwwQ0FBMEM7SUFDMUMsSUFBSTtJQUNKLDJDQUEyQztJQUMzQywrQkFBK0I7SUFDL0IsSUFBSTtJQUNKLGdGQUFnRjtJQUNoRixnRkFBZ0Y7SUFDaEYsa0JBQWtCO0lBQ1gsTUFBTSxDQUFDLFNBQVMsQ0FBQyxLQUFhO1FBQ25DLE1BQU0sSUFBSSxHQUFHLElBQUEsb0JBQVMsRUFBQyxLQUFLLENBQUMsQ0FBQztRQUU5QixPQUFPLENBQ0wsSUFBSSxDQUFDLFFBQVEsQ0FBQyx1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RSxDQUFDLFVBQVUsQ0FBQyxtQkFBbUIsQ0FBQyxFQUFFO1FBQ3RDLEVBQUUsQ0FBQyxVQUFVLENBQUMsbUJBQW1CLENBQUMsQ0FBQztLQUNwQztBQUNILENBQUM7QUFMRCxrRkFLQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgSGFzaGlDb3JwLCBJbmNcbi8vIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBNUEwtMi4wXG5pbXBvcnQgc3RyaXBBbnNpIGZyb20gXCJzdHJpcC1hbnNpXCI7XG5pbXBvcnQge1xuICBFcnJvcnMsXG4gIGV4ZWMsXG4gIGxvZ2dlcixcbiAgcmVhZENES1RGVmVyc2lvbixcbiAgdGVycmFmb3JtQmluYXJ5TmFtZSxcbn0gZnJvbSBcIkBjZGt0Zi9jb21tb25zXCI7XG5pbXBvcnQge1xuICBUZXJyYWZvcm0sXG4gIFRlcnJhZm9ybVBsYW4sXG4gIFRlcnJhZm9ybU91dHB1dCxcbiAgQWJzdHJhY3RUZXJyYWZvcm1QbGFuLFxuICBUZXJyYWZvcm1EZXBsb3lTdGF0ZSxcbn0gZnJvbSBcIi4vdGVycmFmb3JtXCI7XG5pbXBvcnQgeyBTeW50aGVzaXplZFN0YWNrIH0gZnJvbSBcIi4uL3N5bnRoLXN0YWNrXCI7XG5pbXBvcnQge1xuICBjcmVhdGVBbmRTdGFydERlcGxveVNlcnZpY2UsXG4gIGNyZWF0ZUFuZFN0YXJ0RGVzdHJveVNlcnZpY2UsXG4gIERlcGxveVN0YXRlLFxuICBpc0RlcGxveUV2ZW50LFxufSBmcm9tIFwiLi9kZXBsb3ktbWFjaGluZVwiO1xuaW1wb3J0IHsgd2FpdEZvciB9IGZyb20gXCJ4c3RhdGUvbGliL3dhaXRGb3JcIjtcbmltcG9ydCB7IG1pc3NpbmdWYXJpYWJsZSB9IGZyb20gXCIuLi9lcnJvcnNcIjtcbmltcG9ydCB7IHRlcnJhZm9ybUpzb25TY2hlbWEgfSBmcm9tIFwiLi4vdGVycmFmb3JtLWpzb25cIjtcbmltcG9ydCB7IHNwYXduUHR5IH0gZnJvbSBcIi4vcHR5LXByb2Nlc3NcIjtcbmltcG9ydCBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgKiBhcyBmcyBmcm9tIFwiZnMtZXh0cmFcIjtcblxuY29uc3QgR0VORVJBVEVfQ09ORklHX09VVF9GSUxFID0gXCJnZW5lcmF0ZWRfcmVzb3VyY2VzLnRmXCI7XG5cbmV4cG9ydCBjbGFzcyBUZXJyYWZvcm1DbGlQbGFuXG4gIGV4dGVuZHMgQWJzdHJhY3RUZXJyYWZvcm1QbGFuXG4gIGltcGxlbWVudHMgVGVycmFmb3JtUGxhblxue1xuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgcmVhZG9ubHkgcGxhbkZpbGU6IHN0cmluZyxcbiAgICBwdWJsaWMgcmVhZG9ubHkgcGxhbjogeyBba2V5OiBzdHJpbmddOiBhbnkgfVxuICApIHtcbiAgICBzdXBlcihwbGFuRmlsZSwgcGxhbj8ucmVzb3VyY2VfY2hhbmdlcywgcGxhbj8ub3V0cHV0X2NoYW5nZXMpO1xuICB9XG59XG5cbmFic3RyYWN0IGNsYXNzIEFic3RyYWN0T3V0cHV0RmlsdGVyIHtcbiAgcHVibGljIHN0YXRpYyBjb25kaXRpb246IChsaW5lOiBzdHJpbmcpID0+IGJvb2xlYW47XG4gIHB1YmxpYyBzdGF0aWMgdHJhbnNmb3JtOiAobGluZTogc3RyaW5nKSA9PiBzdHJpbmc7XG59XG5leHBvcnQgdHlwZSBPdXRwdXRGaWx0ZXIgPSB0eXBlb2YgQWJzdHJhY3RPdXRwdXRGaWx0ZXI7XG5cbi8vIFRoZSBwbGFuIG1pZ2h0IGVycm9yIGlmIHRoZXJlIGlzIGEgdmFyaWFibGUgbWlzc2luZywgYnV0IHRoZSBlcnJvciBtZXNzYWdlIGhpbnRzIHRoZSB1c2VyXG4vLyBpbiBhIHdyb25nIGRpcmVjdGlvbi4gV2UgdGhlcmVmb3JlIGNhdGNoIHRoZSBlcnJvciBhbmQgcmV0aHJvdyBpdCB3aXRoIGEgbW9yZSBoZWxwZnVsIG1lc3NhZ2VcbmNsYXNzIFZhcmlhYmxlUmVxdWlyZWRGaWx0ZXIgZXh0ZW5kcyBBYnN0cmFjdE91dHB1dEZpbHRlciB7XG4gIC8vIEV4YW1wbGUgZm9yIFwiTm8gdmFsdWUgZm9yIHJlcXVpcmVkIHZhcmlhYmxlXCIgZXJyb3JcbiAgLy8g4pW3XG4gIC8vIOKUgiBFcnJvcjogTm8gdmFsdWUgZm9yIHJlcXVpcmVkIHZhcmlhYmxlXG4gIC8vIOKUglxuICAvLyDilIIgICBvbiBjZGsudGYuanNvbiBsaW5lIDMxLCBpbiB2YXJpYWJsZTpcbiAgLy8g4pSCICAgMzE6ICAgICBcIndpdGgtZGFzaGVzXCI6IHtcbiAgLy8g4pSCXG4gIC8vIOKUgiBUaGUgcm9vdCBtb2R1bGUgaW5wdXQgdmFyaWFibGUgXCJ3aXRoLWRhc2hlc1wiIGlzIG5vdCBzZXQsIGFuZCBoYXMgbm8gZGVmYXVsdFxuICAvLyDilIIgdmFsdWUuIFVzZSBhIC12YXIgb3IgLXZhci1maWxlIGNvbW1hbmQgbGluZSBhcmd1bWVudCB0byBwcm92aWRlIGEgdmFsdWUgZm9yXG4gIC8vIOKUgiB0aGlzIHZhcmlhYmxlXG4gIHB1YmxpYyBzdGF0aWMgY29uZGl0aW9uKGlucHV0OiBzdHJpbmcpIHtcbiAgICBjb25zdCBsaW5lID0gc3RyaXBBbnNpKGlucHV0KTtcblxuICAgIHJldHVybiAoXG4gICAgICBsaW5lLmluY2x1ZGVzKFwiRXJyb3I6IE5vIHZhbHVlIGZvciByZXF1aXJlZCB2YXJpYWJsZVwiKSAmJlxuICAgICAgbGluZS5pbmNsdWRlcyhcIlRoZSByb290IG1vZHVsZSBpbnB1dCB2YXJpYWJsZVwiKVxuICAgICk7XG4gIH1cbiAgcHVibGljIHN0YXRpYyB0cmFuc2Zvcm0obGluZTogc3RyaW5nKSB7XG4gICAgY29uc3Qgc3RhcnRNYXJrZXIgPSAnVGhlIHJvb3QgbW9kdWxlIGlucHV0IHZhcmlhYmxlIFwiJztcbiAgICBjb25zdCB2YXJpYWJsZU5hbWUgPSBsaW5lLnN1YnN0cmluZyhcbiAgICAgIGxpbmUuaW5kZXhPZihzdGFydE1hcmtlcikgKyBzdGFydE1hcmtlci5sZW5ndGgsXG4gICAgICBsaW5lLmluZGV4T2YoJ1wiIGlzIG5vdCBzZXQnKVxuICAgICk7XG5cbiAgICByZXR1cm4gbWlzc2luZ1ZhcmlhYmxlKHZhcmlhYmxlTmFtZSk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFRlcnJhZm9ybUNsaSBpbXBsZW1lbnRzIFRlcnJhZm9ybSB7XG4gIHB1YmxpYyByZWFkb25seSB3b3JrZGlyOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgb25TdGRvdXQ6IChcbiAgICBzdGF0ZU5hbWU6IHN0cmluZyxcbiAgICBmaWx0ZXI/OiBPdXRwdXRGaWx0ZXJbXVxuICApID0+IChzdGRvdXQ6IEJ1ZmZlciB8IHN0cmluZykgPT4gdm9pZDtcbiAgcHJpdmF0ZSByZWFkb25seSBvblN0ZGVycjogKFxuICAgIHN0YXRlTmFtZTogc3RyaW5nLFxuICAgIGZpbHRlcj86IE91dHB1dEZpbHRlcltdXG4gICkgPT4gKHN0ZGVycjogc3RyaW5nIHwgVWludDhBcnJheSkgPT4gdm9pZDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGFib3J0U2lnbmFsOiBBYm9ydFNpZ25hbCxcbiAgICBwdWJsaWMgcmVhZG9ubHkgc3RhY2s6IFN5bnRoZXNpemVkU3RhY2ssXG4gICAgY3JlYXRlVGVycmFmb3JtTG9nSGFuZGxlciA9IChfcGhhc2U6IHN0cmluZywgX2ZpbHRlcj86IE91dHB1dEZpbHRlcltdKSA9PlxuICAgICAgKF9zdGRvdXQ6IHN0cmluZywgX2lzRXJyID0gZmFsc2UpID0+IHt9IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWVtcHR5LWZ1bmN0aW9uXG4gICkge1xuICAgIHRoaXMud29ya2RpciA9IHN0YWNrLndvcmtpbmdEaXJlY3Rvcnk7XG4gICAgdGhpcy5vblN0ZG91dCA9XG4gICAgICAocGhhc2U6IHN0cmluZywgZmlsdGVyPzogT3V0cHV0RmlsdGVyW10pID0+IChzdGRvdXQ6IEJ1ZmZlciB8IHN0cmluZykgPT5cbiAgICAgICAgY3JlYXRlVGVycmFmb3JtTG9nSGFuZGxlcihcbiAgICAgICAgICBwaGFzZSxcbiAgICAgICAgICBmaWx0ZXJcbiAgICAgICAgKShCdWZmZXIuaXNCdWZmZXIoc3Rkb3V0KSA/IHN0ZG91dC50b1N0cmluZygpIDogc3Rkb3V0KTtcbiAgICB0aGlzLm9uU3RkZXJyID1cbiAgICAgIChwaGFzZTogc3RyaW5nLCBmaWx0ZXI/OiBPdXRwdXRGaWx0ZXJbXSkgPT5cbiAgICAgIChzdGRlcnI6IHN0cmluZyB8IFVpbnQ4QXJyYXkpID0+XG4gICAgICAgIGNyZWF0ZVRlcnJhZm9ybUxvZ0hhbmRsZXIocGhhc2UsIGZpbHRlcikoc3RkZXJyLnRvU3RyaW5nKCksIHRydWUpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGluaXQob3B0czoge1xuICAgIG5lZWRzVXBncmFkZTogYm9vbGVhbjtcbiAgICBub0NvbG9yPzogYm9vbGVhbjtcbiAgICBtaWdyYXRlU3RhdGU6IGJvb2xlYW47XG4gICAgbmVlZHNMb2NrZmlsZVVwZGF0ZTogYm9vbGVhbjtcbiAgfSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IHRoaXMuc2V0VXNlckFnZW50KCk7XG5cbiAgICBjb25zdCBhcmdzID0gW1wiaW5pdFwiXTtcbiAgICBpZiAob3B0cy5uZWVkc1VwZ3JhZGUpIHtcbiAgICAgIGFyZ3MucHVzaChcIi11cGdyYWRlXCIpO1xuICAgIH1cbiAgICBpZiAob3B0cy5ub0NvbG9yKSB7XG4gICAgICBhcmdzLnB1c2goXCItbm8tY29sb3JcIik7XG4gICAgfVxuXG4gICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1lbXB0eS1mdW5jdGlvblxuICAgIGxldCBpbml0Q2FuTm90Q29udGludWUgPSAoX2VycjogYW55KSA9PiB7fTtcbiAgICBjb25zdCByZWplY3RzSWZJbml0Q2FuTm90Q29udGludWUgPSBuZXcgUHJvbWlzZSgoX3Jlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgaW5pdENhbk5vdENvbnRpbnVlID0gcmVqZWN0O1xuICAgIH0pO1xuXG4gICAgY29uc3Qgc3Rkb3V0ID0gdGhpcy5vblN0ZG91dChcImluaXRcIik7XG4gICAgY29uc3QgeyBhY3Rpb25zLCBleGl0Q29kZSB9ID0gc3Bhd25QdHkoXG4gICAgICB7XG4gICAgICAgIGZpbGU6IHRlcnJhZm9ybUJpbmFyeU5hbWUsXG4gICAgICAgIGFyZ3MsXG4gICAgICAgIG9wdGlvbnM6IHtcbiAgICAgICAgICBjd2Q6IHRoaXMud29ya2RpcixcbiAgICAgICAgICBlbnY6IHByb2Nlc3MuZW52IGFzIGFueSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgICAoZGF0YSkgPT4ge1xuICAgICAgICBzdGRvdXQoZGF0YSk7XG4gICAgICAgIGlmIChkYXRhLmluY2x1ZGVzKFwiU2hvdWxkIFRlcnJhZm9ybSBtaWdyYXRlIHlvdXIgZXhpc3Rpbmcgc3RhdGU/XCIpKSB7XG4gICAgICAgICAgaWYgKG9wdHMubWlncmF0ZVN0YXRlKSB7XG4gICAgICAgICAgICBhY3Rpb25zLndyaXRlTGluZShcInllc1wiKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYWN0aW9ucy5zdG9wKCk7XG4gICAgICAgICAgICBpbml0Q2FuTm90Q29udGludWUoXG4gICAgICAgICAgICAgIFwiUGxlYXNlIHBhc3MgdGhlIC0tbWlncmF0ZS1zdGF0ZSBmbGFnIHRvIG1pZ3JhdGUgeW91ciBzdGF0ZVwiXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgICk7XG4gICAgdGhpcy5hYm9ydFNpZ25hbC5hZGRFdmVudExpc3RlbmVyKFwiYWJvcnRcIiwgKCkgPT4ge1xuICAgICAgYWN0aW9ucy5zdG9wKCk7XG4gICAgfSk7XG5cbiAgICBjb25zdCBwcm9ncmVzcyA9IGV4aXRDb2RlLnRoZW4oKGNvZGUpID0+IHtcbiAgICAgIGlmIChjb2RlICE9PSAwKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgdGVycmFmb3JtIGluaXQgZmFpbGVkIHdpdGggZXhpdCBjb2RlICR7Y29kZX1gKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBhd2FpdCBQcm9taXNlLnJhY2UoW3Byb2dyZXNzLCByZWplY3RzSWZJbml0Q2FuTm90Q29udGludWVdKTtcblxuICAgIC8vIFRPRE86IHRoaXMgbWlnaHQgaGF2ZSBwZXJmb3JtYW5jZSBpbXBsaWNhdGlvbnMgYmVjYXVzZSB3ZSBkb24ndCBrbm93IGlmIHdlJ3JlXG4gICAgLy8gcnVubmluZyBhIHJlbW90ZSBwbGFuIG9yIGEgbG9jYWwgb25lIChzbyB3ZSBydW4gaXQgYWx3YXlzIGZvciBhbGwgcGxhdGZvcm1zKVxuICAgIC8vIHdoaWxlIHdlJ2Qgb25seSBuZWVkIGl0IGZvciByZW1vdGUgcGxhbnNcbiAgICBpZiAob3B0cy5uZWVkc0xvY2tmaWxlVXBkYXRlKSB7XG4gICAgICBhd2FpdCBleGVjKFxuICAgICAgICB0ZXJyYWZvcm1CaW5hcnlOYW1lLFxuICAgICAgICBbXG4gICAgICAgICAgXCJwcm92aWRlcnNcIixcbiAgICAgICAgICBcImxvY2tcIixcbiAgICAgICAgICBcIi1wbGF0Zm9ybT1saW51eF9hbWQ2NFwiLFxuICAgICAgICAgIC4uLihvcHRzLm5vQ29sb3IgPyBbXCItbm8tY29sb3JcIl0gOiBbXSksXG4gICAgICAgIF0sXG4gICAgICAgIHtcbiAgICAgICAgICBjd2Q6IHRoaXMud29ya2RpcixcbiAgICAgICAgICBlbnY6IHByb2Nlc3MuZW52LFxuICAgICAgICAgIHNpZ25hbDogdGhpcy5hYm9ydFNpZ25hbCxcbiAgICAgICAgICBub0NvbG9yOiBvcHRzLm5vQ29sb3IsXG4gICAgICAgIH0sXG4gICAgICAgIHRoaXMub25TdGRvdXQoXCJpbml0XCIpLFxuICAgICAgICB0aGlzLm9uU3RkZXJyKFwiaW5pdFwiKVxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldCBpc0Nsb3VkU3RhY2soKTogYm9vbGVhbiB7XG4gICAgY29uc3QgcGFyc2VkU3RhY2sgPSB0ZXJyYWZvcm1Kc29uU2NoZW1hLnBhcnNlKFxuICAgICAgSlNPTi5wYXJzZSh0aGlzLnN0YWNrLmNvbnRlbnQpXG4gICAgKTtcblxuICAgIHJldHVybiBCb29sZWFuKFxuICAgICAgcGFyc2VkU3RhY2sudGVycmFmb3JtPy5iYWNrZW5kPy5yZW1vdGUgfHwgcGFyc2VkU3RhY2sudGVycmFmb3JtPy5jbG91ZFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGdldCBoYXNJbXBvcnRzKCk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHBhcnNlZFN0YWNrID0gdGVycmFmb3JtSnNvblNjaGVtYS5wYXJzZShcbiAgICAgIEpTT04ucGFyc2UodGhpcy5zdGFjay5jb250ZW50KVxuICAgICk7XG5cbiAgICByZXR1cm4gQm9vbGVhbihwYXJzZWRTdGFjay5pbXBvcnQpO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHBsYW4ob3B0czoge1xuICAgIGRlc3Ryb3k6IGJvb2xlYW47XG4gICAgcmVmcmVzaE9ubHk/OiBib29sZWFuO1xuICAgIHBhcmFsbGVsaXNtPzogbnVtYmVyO1xuICAgIHZhcnM/OiBzdHJpbmdbXTtcbiAgICB2YXJGaWxlcz86IHN0cmluZ1tdO1xuICAgIG5vQ29sb3I/OiBib29sZWFuO1xuICB9KTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3Qge1xuICAgICAgZGVzdHJveSA9IGZhbHNlLFxuICAgICAgcmVmcmVzaE9ubHkgPSBmYWxzZSxcbiAgICAgIHBhcmFsbGVsaXNtID0gLTEsXG4gICAgICB2YXJzID0gW10sXG4gICAgICB2YXJGaWxlcyA9IFtdLFxuICAgICAgbm9Db2xvciA9IGZhbHNlLFxuICAgIH0gPSBvcHRzO1xuICAgIGNvbnN0IG9wdGlvbnMgPSBbXCJwbGFuXCIsIFwiLWlucHV0PWZhbHNlXCJdO1xuXG4gICAgY29uc3QgZ2VuZXJhdGVkQ29uZmlnRmlsZSA9IHBhdGguam9pbihcbiAgICAgIHRoaXMud29ya2RpcixcbiAgICAgIEdFTkVSQVRFX0NPTkZJR19PVVRfRklMRVxuICAgICk7XG4gICAgaWYgKGZzLmV4aXN0c1N5bmMoZ2VuZXJhdGVkQ29uZmlnRmlsZSkpIHtcbiAgICAgIGZzLnJlbW92ZShnZW5lcmF0ZWRDb25maWdGaWxlKTtcbiAgICB9XG4gICAgaWYgKHRoaXMuaGFzSW1wb3J0cykge1xuICAgICAgb3B0aW9ucy5wdXNoKGAtZ2VuZXJhdGUtY29uZmlnLW91dD0ke0dFTkVSQVRFX0NPTkZJR19PVVRfRklMRX1gKTtcbiAgICB9XG4gICAgaWYgKCF0aGlzLmlzQ2xvdWRTdGFjaykge1xuICAgICAgY29uc3QgcGxhbkZpbGUgPSBcInBsYW5cIjtcbiAgICAgIG9wdGlvbnMucHVzaChcIi1vdXRcIiwgcGxhbkZpbGUpO1xuICAgIH1cblxuICAgIGlmIChkZXN0cm95KSB7XG4gICAgICBvcHRpb25zLnB1c2goXCItZGVzdHJveVwiKTtcbiAgICB9XG4gICAgaWYgKHJlZnJlc2hPbmx5KSB7XG4gICAgICBvcHRpb25zLnB1c2goXCItcmVmcmVzaC1vbmx5XCIpO1xuICAgIH1cbiAgICBpZiAocGFyYWxsZWxpc20gPiAtMSkge1xuICAgICAgb3B0aW9ucy5wdXNoKGAtcGFyYWxsZWxpc209JHtwYXJhbGxlbGlzbX1gKTtcbiAgICB9XG4gICAgaWYgKG5vQ29sb3IpIHtcbiAgICAgIG9wdGlvbnMucHVzaChcIi1uby1jb2xvclwiKTtcbiAgICB9XG5cbiAgICB2YXJzLmZvckVhY2goKHYpID0+IG9wdGlvbnMucHVzaChgLXZhcj0ke3Z9YCkpO1xuICAgIHZhckZpbGVzLmZvckVhY2goKHYpID0+IG9wdGlvbnMucHVzaChgLXZhci1maWxlPSR7dn1gKSk7XG5cbiAgICBsb2dnZXIuZGVidWcoXG4gICAgICBgRXhlY3V0aW5nICR7dGVycmFmb3JtQmluYXJ5TmFtZX0gJHtvcHRpb25zLmpvaW4oXCIgXCIpfSBpbiAke3RoaXMud29ya2Rpcn1gXG4gICAgKTtcblxuICAgIGF3YWl0IHRoaXMuc2V0VXNlckFnZW50KCk7XG5cbiAgICBhd2FpdCBleGVjKFxuICAgICAgdGVycmFmb3JtQmluYXJ5TmFtZSxcbiAgICAgIG9wdGlvbnMsXG4gICAgICB7XG4gICAgICAgIGN3ZDogdGhpcy53b3JrZGlyLFxuICAgICAgICBlbnY6IHByb2Nlc3MuZW52LFxuICAgICAgICBzaWduYWw6IHRoaXMuYWJvcnRTaWduYWwsXG4gICAgICAgIG5vQ29sb3IsXG4gICAgICB9LFxuICAgICAgdGhpcy5vblN0ZG91dChcInBsYW5cIiwgW1ZhcmlhYmxlUmVxdWlyZWRGaWx0ZXJdKSxcbiAgICAgIHRoaXMub25TdGRlcnIoXCJwbGFuXCIsIFtWYXJpYWJsZVJlcXVpcmVkRmlsdGVyXSlcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGRlcGxveShcbiAgICB7XG4gICAgICBhdXRvQXBwcm92ZSA9IGZhbHNlLFxuICAgICAgcmVmcmVzaE9ubHkgPSBmYWxzZSxcbiAgICAgIG5vQ29sb3IgPSBmYWxzZSxcbiAgICAgIHBhcmFsbGVsaXNtID0gLTEsXG4gICAgICBleHRyYU9wdGlvbnMgPSBbXSxcbiAgICAgIHZhcnMgPSBbXSxcbiAgICAgIHZhckZpbGVzID0gW10sXG4gICAgfSxcbiAgICBjYWxsYmFjazogKHN0YXRlOiBUZXJyYWZvcm1EZXBsb3lTdGF0ZSkgPT4gdm9pZFxuICApOiBQcm9taXNlPHsgY2FuY2VsbGVkOiBib29sZWFuIH0+IHtcbiAgICBhd2FpdCB0aGlzLnNldFVzZXJBZ2VudCgpO1xuICAgIGNvbnN0IHNlcnZpY2UgPSBjcmVhdGVBbmRTdGFydERlcGxveVNlcnZpY2Uoe1xuICAgICAgdGVycmFmb3JtQmluYXJ5TmFtZSxcbiAgICAgIHdvcmtkaXI6IHRoaXMud29ya2RpcixcbiAgICAgIHJlZnJlc2hPbmx5LFxuICAgICAgbm9Db2xvcixcbiAgICAgIGF1dG9BcHByb3ZlLFxuICAgICAgcGFyYWxsZWxpc20sXG4gICAgICBleHRyYU9wdGlvbnMsXG4gICAgICB2YXJzLFxuICAgICAgdmFyRmlsZXMsXG4gICAgfSk7XG4gICAgcmV0dXJuIHRoaXMuaGFuZGxlU2VydmljZShcImRlcGxveVwiLCBzZXJ2aWNlLCBjYWxsYmFjayk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZGVzdHJveShcbiAgICB7XG4gICAgICBhdXRvQXBwcm92ZSA9IGZhbHNlLFxuICAgICAgcGFyYWxsZWxpc20gPSAtMSxcbiAgICAgIG5vQ29sb3IgPSBmYWxzZSxcbiAgICAgIGV4dHJhT3B0aW9ucyA9IFtdLFxuICAgICAgdmFycyA9IFtdLFxuICAgICAgdmFyRmlsZXMgPSBbXSxcbiAgICB9LFxuICAgIGNhbGxiYWNrOiAoc3RhdGU6IFRlcnJhZm9ybURlcGxveVN0YXRlKSA9PiB2b2lkXG4gICk6IFByb21pc2U8eyBjYW5jZWxsZWQ6IGJvb2xlYW4gfT4ge1xuICAgIGF3YWl0IHRoaXMuc2V0VXNlckFnZW50KCk7XG4gICAgY29uc3Qgc2VydmljZSA9IGNyZWF0ZUFuZFN0YXJ0RGVzdHJveVNlcnZpY2Uoe1xuICAgICAgdGVycmFmb3JtQmluYXJ5TmFtZSxcbiAgICAgIHdvcmtkaXI6IHRoaXMud29ya2RpcixcbiAgICAgIGF1dG9BcHByb3ZlLFxuICAgICAgcGFyYWxsZWxpc20sXG4gICAgICBub0NvbG9yLFxuICAgICAgZXh0cmFPcHRpb25zLFxuICAgICAgdmFycyxcbiAgICAgIHZhckZpbGVzLFxuICAgIH0pO1xuICAgIHJldHVybiB0aGlzLmhhbmRsZVNlcnZpY2UoXCJkZXN0cm95XCIsIHNlcnZpY2UsIGNhbGxiYWNrKTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgaGFuZGxlU2VydmljZShcbiAgICB0eXBlOiBcImRlcGxveVwiIHwgXCJkZXN0cm95XCIsXG4gICAgc2VydmljZTpcbiAgICAgIHwgUmV0dXJuVHlwZTx0eXBlb2YgY3JlYXRlQW5kU3RhcnREZXBsb3lTZXJ2aWNlPlxuICAgICAgfCBSZXR1cm5UeXBlPHR5cGVvZiBjcmVhdGVBbmRTdGFydERlc3Ryb3lTZXJ2aWNlPixcbiAgICBjYWxsYmFjazogKHN0YXRlOiBUZXJyYWZvcm1EZXBsb3lTdGF0ZSkgPT4gdm9pZFxuICApOiBQcm9taXNlPHsgY2FuY2VsbGVkOiBib29sZWFuIH0+IHtcbiAgICAvLyBzdG9wIHRlcnJhZm9ybSBhcHBseSBpZiBzaWduYWxlZCBhcyBzdWNoIGZyb20gdGhlIG91dHNpZGUgKGUuZy4gdmlhIGN0cmwrYylcbiAgICB0aGlzLmFib3J0U2lnbmFsLmFkZEV2ZW50TGlzdGVuZXIoXG4gICAgICBcImFib3J0XCIsXG4gICAgICAoKSA9PiB7XG4gICAgICAgIHNlcnZpY2Uuc2VuZChcIlNUT1BcIik7XG4gICAgICB9LFxuICAgICAgeyBvbmNlOiB0cnVlIH1cbiAgICApO1xuXG4gICAgLy8gcmVsYXkgbG9ncyB0byBzdGRvdXRcbiAgICBzZXJ2aWNlLm9uRXZlbnQoKGV2ZW50KSA9PiB7XG4gICAgICBsb2dnZXIudHJhY2UoXG4gICAgICAgIGBUZXJyYWZvcm0gQ0xJIHN0YXRlIG1hY2hpbmUgZXZlbnQ6ICR7SlNPTi5zdHJpbmdpZnkoZXZlbnQpfWBcbiAgICAgICk7XG4gICAgICBpZiAoaXNEZXBsb3lFdmVudChldmVudCwgXCJPVVRQVVRfUkVDRUlWRURcIikpXG4gICAgICAgIHRoaXMub25TdGRvdXQodHlwZSkoZXZlbnQub3V0cHV0KTtcbiAgICAgIGVsc2UgaWYgKGlzRGVwbG95RXZlbnQoZXZlbnQsIFwiQVBQUk9WRURfRVhURVJOQUxMWVwiKSlcbiAgICAgICAgY2FsbGJhY2soeyB0eXBlOiBcImV4dGVybmFsIGFwcHJvdmFsIHJlcGx5XCIsIGFwcHJvdmVkOiB0cnVlIH0pO1xuICAgICAgZWxzZSBpZiAoaXNEZXBsb3lFdmVudChldmVudCwgXCJSRUpFQ1RFRF9FWFRFUk5BTExZXCIpKVxuICAgICAgICBjYWxsYmFjayh7IHR5cGU6IFwiZXh0ZXJuYWwgYXBwcm92YWwgcmVwbHlcIiwgYXBwcm92ZWQ6IGZhbHNlIH0pO1xuICAgICAgZWxzZSBpZiAoaXNEZXBsb3lFdmVudChldmVudCwgXCJPVkVSUklEREVOX0VYVEVSTkFMTFlcIikpXG4gICAgICAgIGNhbGxiYWNrKHtcbiAgICAgICAgICB0eXBlOiBcImV4dGVybmFsIHNlbnRpbmVsIG92ZXJyaWRlIHJlcGx5XCIsXG4gICAgICAgICAgb3ZlcnJpZGRlbjogdHJ1ZSxcbiAgICAgICAgfSk7XG4gICAgICBlbHNlIGlmIChpc0RlcGxveUV2ZW50KGV2ZW50LCBcIk9WRVJSSURFX1JFSkVDVEVEX0VYVEVSTkFMTFlcIikpXG4gICAgICAgIGNhbGxiYWNrKHtcbiAgICAgICAgICB0eXBlOiBcImV4dGVybmFsIHNlbnRpbmVsIG92ZXJyaWRlIHJlcGx5XCIsXG4gICAgICAgICAgb3ZlcnJpZGRlbjogZmFsc2UsXG4gICAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgbGV0IHByZXZpb3VzU3RhdGU6IERlcGxveVN0YXRlW1widmFsdWVcIl0gPSBcImlkbGVcIjtcblxuICAgIHNlcnZpY2Uub25UcmFuc2l0aW9uKChzdGF0ZSkgPT4ge1xuICAgICAgLy8gb25seSBzZW5kIHVwZGF0ZXMgb24gYWN0dWFsIHN0YXRlIGNoYW5nZVxuICAgICAgLy8gb25UcmFuc2l0aW9uIGlzIGNhbGxlZCBldmVuIGlmIHRoZSBzdGF0ZSBkaWRuJ3QgY2hhbmdlIGJ1dCBvbmx5IGFuIGV2ZW50IGhhcHBlbmVkXG4gICAgICBpZiAoc3RhdGUubWF0Y2hlcyhwcmV2aW91c1N0YXRlIGFzIERlcGxveVN0YXRlW1widmFsdWVcIl0pKSByZXR1cm47XG5cbiAgICAgIGxvZ2dlci50cmFjZShcbiAgICAgICAgYFRlcnJhZm9ybSBDTEkgc3RhdGUgbWFjaGluZSBzdGF0ZSB0cmFuc2l0aW9uOiAke0pTT04uc3RyaW5naWZ5KFxuICAgICAgICAgIHByZXZpb3VzU3RhdGVcbiAgICAgICAgKX0gPT4gJHtKU09OLnN0cmluZ2lmeShzdGF0ZS52YWx1ZSl9YFxuICAgICAgKTtcblxuICAgICAgaWYgKHN0YXRlLm1hdGNoZXMoeyBydW5uaW5nOiBcImF3YWl0aW5nX2FwcHJvdmFsXCIgfSkpIHtcbiAgICAgICAgY2FsbGJhY2soe1xuICAgICAgICAgIHR5cGU6IFwid2FpdGluZyBmb3IgYXBwcm92YWxcIixcbiAgICAgICAgICBhcHByb3ZlOiAoKSA9PiBzZXJ2aWNlLnNlbmQoXCJBUFBST1ZFXCIpLFxuICAgICAgICAgIHJlamVjdDogKCkgPT4gc2VydmljZS5zZW5kKFwiUkVKRUNUXCIpLFxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSBpZiAoc3RhdGUubWF0Y2hlcyh7IHJ1bm5pbmc6IFwiYXdhaXRpbmdfc2VudGluZWxfb3ZlcnJpZGVcIiB9KSkge1xuICAgICAgICBjYWxsYmFjayh7XG4gICAgICAgICAgdHlwZTogXCJ3YWl0aW5nIGZvciBzZW50aW5lbCBvdmVycmlkZVwiLFxuICAgICAgICAgIG92ZXJyaWRlOiAoKSA9PiBzZXJ2aWNlLnNlbmQoXCJPVkVSUklERVwiKSxcbiAgICAgICAgICByZWplY3Q6ICgpID0+IHNlcnZpY2Uuc2VuZChcIlJFSkVDVF9PVkVSUklERVwiKSxcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2UgaWYgKHN0YXRlLm1hdGNoZXMoeyBydW5uaW5nOiBcInByb2Nlc3NpbmdcIiB9KSkge1xuICAgICAgICBjYWxsYmFjayh7XG4gICAgICAgICAgdHlwZTogXCJydW5uaW5nXCIsXG4gICAgICAgICAgY2FuY2VsbGVkOiBCb29sZWFuKHN0YXRlLmNvbnRleHQuY2FuY2VsbGVkKSxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgICBwcmV2aW91c1N0YXRlID0gc3RhdGUudmFsdWUgYXMgRGVwbG95U3RhdGVbXCJ2YWx1ZVwiXTtcbiAgICB9KTtcbiAgICBzZXJ2aWNlLnN0YXJ0KCk7XG4gICAgY29uc3Qgc3RhdGUgPSBhd2FpdCB3YWl0Rm9yKHNlcnZpY2UsIChzdGF0ZSkgPT4gISFzdGF0ZS5kb25lLCB7XG4gICAgICB0aW1lb3V0OiBJbmZpbml0eSxcbiAgICB9KTtcblxuICAgIGxvZ2dlci50cmFjZShcbiAgICAgIGBJbnZva2luZyBUZXJyYWZvcm0gQ0xJIGZvciAke3R5cGV9IGRvbmUgKHN0YXRlIG1hY2hpbmUgcmVhY2hlZCBmaW5hbCBzdGF0ZSkuIExhc3QgZXZlbnQ6ICR7SlNPTi5zdHJpbmdpZnkoXG4gICAgICAgIHN0YXRlLmV2ZW50XG4gICAgICApfS4gQ29udGV4dDogJHtKU09OLnN0cmluZ2lmeShzdGF0ZS5jb250ZXh0KX1gXG4gICAgKTtcblxuICAgIC8vIGV4YW1wbGUgZXZlbnRzOiB7IHR5cGU6ICdFWElURUQnLCBleGl0Q29kZTogMCB9LCB7IHR5cGU6ICdFWFRFUk5BTF9SRUpFQ1QnIH1cbiAgICBpZiAoXG4gICAgICBzdGF0ZS5ldmVudC50eXBlID09PSBcIkVYSVRFRFwiICYmXG4gICAgICBzdGF0ZS5ldmVudC5leGl0Q29kZSAhPT0gMCAmJlxuICAgICAgIXN0YXRlLmNvbnRleHQuY2FuY2VsbGVkIC8vIGRvbid0IGZhaWwgaWYgd2UgY2FuY2VsbGVkIHRoZSBydW5cbiAgICApIHtcbiAgICAgIHRocm93IGBJbnZva2luZyBUZXJyYWZvcm0gQ0xJIGZhaWxlZCB3aXRoIGV4aXQgY29kZSAke3N0YXRlLmV2ZW50LmV4aXRDb2RlfWA7XG4gICAgfVxuXG4gICAgcmV0dXJuIHsgY2FuY2VsbGVkOiBCb29sZWFuKHN0YXRlLmNvbnRleHQuY2FuY2VsbGVkKSB9O1xuICB9XG5cbiAgcHVibGljIGFzeW5jIHZlcnNpb24oKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IGV4ZWMoXG4gICAgICAgIHRlcnJhZm9ybUJpbmFyeU5hbWUsXG4gICAgICAgIFtcIi12XCJdLFxuICAgICAgICB7XG4gICAgICAgICAgY3dkOiB0aGlzLndvcmtkaXIsXG4gICAgICAgICAgZW52OiBwcm9jZXNzLmVudixcbiAgICAgICAgICBzaWduYWw6IHRoaXMuYWJvcnRTaWduYWwsXG4gICAgICAgICAgbm9Db2xvcjogdHJ1ZSxcbiAgICAgICAgfSxcbiAgICAgICAgdGhpcy5vblN0ZG91dChcInZlcnNpb25cIiksXG4gICAgICAgIHRoaXMub25TdGRlcnIoXCJ2ZXJzaW9uXCIpXG4gICAgICApO1xuICAgIH0gY2F0Y2gge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICBcIlRlcnJhZm9ybSBDTEkgbm90IHByZXNlbnQgLSBQbGVhc2UgaW5zdGFsbCBhIGN1cnJlbnQgdmVyc2lvbiBodHRwczovL2xlYXJuLmhhc2hpY29ycC5jb20vdGVycmFmb3JtL2dldHRpbmctc3RhcnRlZC9pbnN0YWxsLmh0bWxcIlxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgb3V0cHV0KCk6IFByb21pc2U8eyBba2V5OiBzdHJpbmddOiBUZXJyYWZvcm1PdXRwdXQgfT4ge1xuICAgIGNvbnN0IG91dHB1dCA9IGF3YWl0IGV4ZWMoXG4gICAgICB0ZXJyYWZvcm1CaW5hcnlOYW1lLFxuICAgICAgW1wib3V0cHV0XCIsIFwiLWpzb25cIl0sXG4gICAgICB7XG4gICAgICAgIGN3ZDogdGhpcy53b3JrZGlyLFxuICAgICAgICBlbnY6IHByb2Nlc3MuZW52LFxuICAgICAgICBzaWduYWw6IHRoaXMuYWJvcnRTaWduYWwsXG4gICAgICAgIG5vQ29sb3I6IHRydWUsXG4gICAgICB9LFxuICAgICAgLy8gV2UgZG9uJ3QgbmVlZCB0byBsb2cgdGhlIG91dHB1dCBoZXJlIHNpbmNlIHdlIHVzZSBpdCBsYXRlciBvblxuICAgICAgKCkgPT4ge30sIC8vIGVzbGludC1kaXNhYmxlLWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLWVtcHR5LWZ1bmN0aW9uXG4gICAgICB0aGlzLm9uU3RkZXJyKFwib3V0cHV0XCIpXG4gICAgKTtcblxuICAgIHRyeSB7XG4gICAgICByZXR1cm4gSlNPTi5wYXJzZShvdXRwdXQpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRocm93IEVycm9ycy5FeHRlcm5hbChcbiAgICAgICAgYEZhaWxlZCB0byBwYXJzZSB0ZXJyYWZvcm0gb3V0cHV0OiAke2V9LiBUaGUgb3V0cHV0IHdhcyAnJHtvdXRwdXR9J2BcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHVibGljIGFzeW5jIHNldFVzZXJBZ2VudCgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyBSZWFkIHRoZSBjZGt0ZiB2ZXJzaW9uIGZyb20gdGhlICdjZGsudGYuanNvbicgZmlsZVxuICAgIC8vIGFuZCBzZXQgdGhlIHVzZXIgYWdlbnQuXG4gICAgY29uc3QgdmVyc2lvbiA9IGF3YWl0IHJlYWRDREtURlZlcnNpb24odGhpcy53b3JrZGlyKTtcbiAgICBpZiAodmVyc2lvbiAhPSBcIlwiKSB7XG4gICAgICBwcm9jZXNzLmVudi5URl9BUFBFTkRfVVNFUl9BR0VOVCA9XG4gICAgICAgIFwiY2RrdGYvXCIgKyB2ZXJzaW9uICsgXCIgKCtodHRwczovL2dpdGh1Yi5jb20vaGFzaGljb3JwL3RlcnJhZm9ybS1jZGspXCI7XG4gICAgfVxuICB9XG5cbiAgLy8gV2UgZG9uJ3QgbmVlZCB0byBjbGVhbiBhbnl0aGluZyB1cCBmb3IgYSBydW5uaW5nIGV4ZWN1dGlvbiBpbiB0aGUgQ0xJIHNpbmNlIHRoZXJlIGlzIG5vIGxlZnQtb3ZlciBzdGF0ZSBpbiBjb250cmFzdCB0byBhbiBvcGVuIFRlcnJhZm9ybSBDbG91ZCBydW5cbiAgcHVibGljIGFzeW5jIGFib3J0KCkge1xuICAgIHJldHVybjtcbiAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdHJ5UmVhZEdlbmVyYXRlZENvbmZpZ3VyYXRpb25GaWxlKFxuICB3b3JraW5nRGlyOiBzdHJpbmdcbik6IFByb21pc2U8c3RyaW5nIHwgbnVsbD4ge1xuICBjb25zdCBnZW5lcmF0ZWRDb25maWdQYXRoID0gcGF0aC5qb2luKHdvcmtpbmdEaXIsIEdFTkVSQVRFX0NPTkZJR19PVVRfRklMRSk7XG4gIGlmICghZnMuZXhpc3RzU3luYyhnZW5lcmF0ZWRDb25maWdQYXRoKSkge1xuICAgIHJldHVybiBudWxsO1xuICB9XG4gIHJldHVybiBmcy5yZWFkRmlsZVN5bmMoZ2VuZXJhdGVkQ29uZmlnUGF0aCwgXCJ1dGYtOFwiKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHRyeVJlbW92ZUdlbmVyYXRlZENvbmZpZ3VyYXRpb25GaWxlKHdvcmtpbmdEaXI6IHN0cmluZykge1xuICBjb25zdCBnZW5lcmF0ZWRDb25maWdQYXRoID0gcGF0aC5qb2luKHdvcmtpbmdEaXIsIEdFTkVSQVRFX0NPTkZJR19PVVRfRklMRSk7XG4gIGlmIChmcy5leGlzdHNTeW5jKGdlbmVyYXRlZENvbmZpZ1BhdGgpKSB7XG4gICAgZnMudW5saW5rU3luYyhnZW5lcmF0ZWRDb25maWdQYXRoKTtcbiAgfVxufVxuIl19