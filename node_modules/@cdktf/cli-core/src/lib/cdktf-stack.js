"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CdktfStack = void 0;
const output_1 = require("./output");
const commons_1 = require("@cdktf/commons");
const terraform_logs_1 = require("./server/terraform-logs");
const terraform_cli_1 = require("./models/terraform-cli");
const dependency_manager_1 = require("./dependencies/dependency-manager");
const terraform_json_1 = require("./terraform-json");
const terraform_provider_lock_1 = require("./terraform-provider-lock");
const convert_1 = require("./convert");
async function getTerraformClient(abortSignal, stack, createTerraformLogHandler) {
    return new terraform_cli_1.TerraformCli(abortSignal, stack, createTerraformLogHandler);
}
class CdktfStack {
    constructor(options) {
        this.options = options;
        this.stopped = false;
        this.currentState = "idle";
        this.stack = options.stack;
        this.parsedContent = terraform_json_1.terraformJsonSchema.parse(JSON.parse(this.stack.content));
    }
    get isPending() {
        return this.currentState === "idle" && !this.stopped;
    }
    get isDone() {
        return (this.currentState === "done" ||
            this.currentState === "errored" ||
            this.stopped);
    }
    get isRunning() {
        return !this.isPending && !this.isDone;
    }
    updateState(update) {
        commons_1.logger.debug(`[${this.stack.name}]: ${update.type}`);
        this.currentState = update.type;
        switch (update.type) {
            case "idle":
            case "done":
                break;
            case "errored":
                this.error = update.error;
                this.options.onUpdate(update);
                break;
            case "outputs fetched":
            case "deployed":
                commons_1.logger.debug(`Outputs: ${JSON.stringify(update.outputs)}`);
                commons_1.logger.debug(`OutputsByConstructId: ${JSON.stringify(update.outputsByConstructId)}`);
                this.outputs = update.outputs;
                this.outputsByConstructId = update.outputsByConstructId;
                this.options.onUpdate(update);
                break;
            default:
                this.options.onUpdate(update);
                break;
        }
    }
    createTerraformLogHandler(phase, filters) {
        commons_1.logger.debug("Creating terraform log handler", phase);
        const onLog = this.options.onLog;
        return (msg, isError = false) => {
            const message = (0, terraform_logs_1.extractJsonLogIfPresent)(msg);
            commons_1.logger.debug(`[${this.options.stack.name}](${phase}): ${msg}`);
            const filterToApply = filters === null || filters === void 0 ? void 0 : filters.find((filter) => filter.condition(message));
            const filteredMessage = filterToApply
                ? filterToApply.transform(message)
                : message;
            if (filteredMessage) {
                commons_1.logger.debug(`Filter ${filterToApply} applied on line '${message}' with result '${filteredMessage}'`);
            }
            if (onLog) {
                onLog({ message: filteredMessage, isError });
            }
        };
    }
    async terraformClient() {
        return await getTerraformClient(this.options.abortSignal, this.options.stack, this.createTerraformLogHandler.bind(this));
    }
    async initalizeTerraform(noColor) {
        var _a;
        const terraform = await this.terraformClient();
        const needsLockfileUpdate = await this.checkNeedsLockfileUpdate();
        const needsUpgrade = await this.checkNeedsUpgrade();
        await terraform.init({
            needsUpgrade,
            noColor: noColor !== null && noColor !== void 0 ? noColor : false,
            needsLockfileUpdate,
            migrateState: (_a = this.options.migrateState) !== null && _a !== void 0 ? _a : false,
        });
        return terraform;
    }
    requiredProviders() {
        var _a;
        // Read required providers from the stack output
        const requiredProviders = (_a = this.parsedContent.terraform) === null || _a === void 0 ? void 0 : _a.required_providers;
        return Object.values(requiredProviders || {}).reduce((acc, obj) => {
            const constraint = new dependency_manager_1.ProviderConstraint(obj.source, obj.version);
            acc[constraint.source] = constraint;
            return acc;
        }, {});
    }
    async checkNeedsLockfileUpdate() {
        if (this.options.migrateState) {
            // If we're migrating state, we need to init
            return true;
        }
        const lock = new terraform_provider_lock_1.TerraformProviderLock(this.stack.workingDirectory);
        const lockFileExists = await lock.hasProviderLockFile();
        if (!lockFileExists) {
            // If we don't have a lock file, this is probably the first init
            return true;
        }
        const requiredProviders = this.requiredProviders();
        for (const provider of Object.values(requiredProviders)) {
            const hasProvider = await lock.hasMatchingProvider(provider);
            if (!hasProvider) {
                // If we don't have a provider or version doesn't match, we need to init
                return true;
            }
        }
        return false;
    }
    async checkNeedsUpgrade() {
        const lock = new terraform_provider_lock_1.TerraformProviderLock(this.stack.workingDirectory);
        const allProviders = this.requiredProviders();
        const lockedProviders = Object.values(await lock.providers());
        // Check if any provider contained in `providers` violates constraints in `lockedProviders`
        // Upgrade if some provider constraint not met
        // If a provider wasn't preset in lockedProviders, that's fine; it will just get added
        return lockedProviders.some((lockedProvider) => {
            var _a;
            const lockedConstraint = lockedProvider.constraints;
            if (!lockedConstraint) {
                // Provider lock doesn't have a constraint specified, so we can't check.
                // This shouldn't happen
                commons_1.logger.debug(`Provider lock doesn't have a constraint for ${lockedProvider.name}`);
                return false;
            }
            const provider = allProviders[lockedConstraint.source];
            if (!provider) {
                // else no longer using this provider, so won't cause problems
                return;
            }
            return !lockedConstraint.matchesVersion((_a = provider.version) !== null && _a !== void 0 ? _a : ">0");
        });
    }
    async run(cb) {
        if (this.stopped) {
            return;
        }
        try {
            this.currentWorkPromise = cb();
            await this.currentWorkPromise;
            this.updateState({ type: "done" });
        }
        catch (e) {
            commons_1.logger.trace("Error in currentWorkPromise", e);
            this.currentWorkPromise = undefined;
            this.updateState({
                type: "errored",
                stackName: this.stack.name,
                error: String(e),
            });
            throw e;
        }
        finally {
            this.currentWorkPromise = undefined;
        }
    }
    async diff({ refreshOnly, terraformParallelism, vars, varFiles, noColor, }) {
        await this.run(async () => {
            this.updateState({ type: "planning", stackName: this.stack.name });
            const terraform = await this.terraformClient();
            await terraform.plan({
                destroy: false,
                refreshOnly,
                parallelism: terraformParallelism,
                vars,
                varFiles,
                noColor,
            });
            this.updateState({ type: "planned", stackName: this.stack.name });
            // Find generated file
            const configFile = await (0, terraform_cli_1.tryReadGeneratedConfigurationFile)(this.stack.workingDirectory);
            if (configFile) {
                this.updateState({
                    type: "import with configuration detected",
                    stackName: this.stack.name,
                    configuration: configFile,
                });
                const convertedCode = await (0, convert_1.convertConfigurationFile)(configFile, this.stack.workingDirectory);
                this.updateState({
                    type: "import with configuration converted",
                    stackName: this.stack.name,
                    configuration: convertedCode,
                });
                const onLog = this.options.onLog;
                if (onLog) {
                    onLog({
                        message: `Import without configuration detected. Terraform has created configuration for it:
${configFile}

CDKTF has translated the code to the following:

${convertedCode}

Please review the code and make any necessary changes before adding it to your codebase.
Make sure to only copy the code within the construct's constructor.

NOTE: Your resource has not yet become managed by CDKTF. 
To finish the import remove the call "generateConfigForImport", add the above code within the construct's constructor, and then append the call importFrom(<resource_id_to_import_from>) to the generated code: 

new SomeResource(...).importFrom("some_id")
`,
                        isError: false,
                    });
                }
                await (0, terraform_cli_1.tryRemoveGeneratedConfigurationFile)(this.stack.workingDirectory);
            }
        });
    }
    async deploy(opts) {
        const { refreshOnly, terraformParallelism, noColor, vars, varFiles } = opts;
        await this.run(async () => {
            this.updateState({ type: "planning", stackName: this.stack.name });
            const terraform = await this.terraformClient();
            const { cancelled } = await terraform.deploy({
                autoApprove: this.options.autoApprove,
                refreshOnly,
                parallelism: terraformParallelism,
                vars,
                varFiles,
                noColor,
            }, (state) => {
                // state updates while apply runs that affect the UI
                if (state.type === "running" && !state.cancelled) {
                    this.updateState({
                        type: "deploying",
                        stackName: this.stack.name,
                    });
                }
                else if (state.type === "waiting for approval") {
                    this.updateState({
                        type: "waiting for stack approval",
                        stackName: this.stack.name,
                        approve: state.approve,
                        reject: () => {
                            state.reject();
                            this.updateState({
                                type: "dismissed",
                                stackName: this.stack.name,
                            });
                        },
                    });
                }
                else if (state.type === "waiting for sentinel override") {
                    this.updateState({
                        type: "waiting for stack sentinel override",
                        stackName: this.stack.name,
                        override: state.override,
                        reject: () => {
                            state.reject();
                            this.updateState({
                                type: "dismissed",
                                stackName: this.stack.name,
                            });
                        },
                    });
                }
                else if (state.type === "external approval reply") {
                    this.updateState({
                        type: "external stack approval reply",
                        stackName: this.stack.name,
                        approved: state.approved,
                    });
                }
                else if (state.type === "external sentinel override reply") {
                    this.updateState({
                        type: "external stack sentinel override reply",
                        stackName: this.stack.name,
                        overridden: state.overridden,
                    });
                }
            });
            if (!cancelled) {
                const outputs = await terraform.output();
                const outputsByConstructId = (0, output_1.getConstructIdsForOutputs)(JSON.parse(this.stack.content), outputs);
                this.updateState({
                    type: "deployed",
                    stackName: this.stack.name,
                    outputs,
                    outputsByConstructId,
                });
            }
        });
    }
    async destroy(opts) {
        const { terraformParallelism, noColor, vars, varFiles } = opts;
        await this.run(async () => {
            this.updateState({ type: "planning", stackName: this.stack.name });
            const terraform = await this.terraformClient();
            const { cancelled } = await terraform.destroy({
                autoApprove: this.options.autoApprove,
                parallelism: terraformParallelism,
                vars,
                varFiles,
                noColor,
            }, (state) => {
                // state updates while apply runs that affect the UI
                if (state.type === "running" && !state.cancelled) {
                    this.updateState({
                        type: "destroying",
                        stackName: this.stack.name,
                    });
                }
                else if (state.type === "waiting for approval") {
                    this.updateState({
                        type: "waiting for stack approval",
                        stackName: this.stack.name,
                        approve: state.approve,
                        reject: () => {
                            state.reject();
                            this.updateState({
                                type: "dismissed",
                                stackName: this.stack.name,
                            });
                        },
                    });
                }
                else if (state.type === "waiting for sentinel override") {
                    this.updateState({
                        type: "waiting for stack sentinel override",
                        stackName: this.stack.name,
                        override: state.override,
                        reject: () => {
                            state.reject();
                            this.updateState({
                                type: "dismissed",
                                stackName: this.stack.name,
                            });
                        },
                    });
                }
                else if (state.type === "external approval reply") {
                    this.updateState({
                        type: "external stack approval reply",
                        stackName: this.stack.name,
                        approved: state.approved,
                    });
                }
                else if (state.type === "external sentinel override reply") {
                    this.updateState({
                        type: "external stack sentinel override reply",
                        stackName: this.stack.name,
                        overridden: state.overridden,
                    });
                }
            });
            if (!cancelled)
                this.updateState({
                    type: "destroyed",
                    stackName: this.stack.name,
                });
        });
    }
    async fetchOutputs() {
        await this.run(async () => {
            const terraform = await this.terraformClient();
            const outputs = await terraform.output();
            const outputsByConstructId = (0, output_1.getConstructIdsForOutputs)(JSON.parse(this.stack.content), outputs);
            this.updateState({
                type: "outputs fetched",
                stackName: this.stack.name,
                outputs,
                outputsByConstructId,
            });
        });
        return this.outputs;
    }
    async stop() {
        this.stopped = true;
    }
}
exports.CdktfStack = CdktfStack;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2RrdGYtc3RhY2suanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjZGt0Zi1zdGFjay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFJQSxxQ0FBNkU7QUFDN0UsNENBQXdDO0FBQ3hDLDREQUFrRTtBQUNsRSwwREFLZ0M7QUFDaEMsMEVBQXVFO0FBQ3ZFLHFEQUF1RTtBQUN2RSx1RUFBa0U7QUFDbEUsdUNBQXFEO0FBNEZyRCxLQUFLLFVBQVUsa0JBQWtCLENBQy9CLFdBQXdCLEVBQ3hCLEtBQXVCLEVBQ3ZCLHlCQUdpRDtJQUVqRCxPQUFPLElBQUksNEJBQVksQ0FBQyxXQUFXLEVBQUUsS0FBSyxFQUFFLHlCQUF5QixDQUFDLENBQUM7QUFDekUsQ0FBQztBQTJCRCxNQUFhLFVBQVU7SUFVckIsWUFBbUIsT0FBMEI7UUFBMUIsWUFBTyxHQUFQLE9BQU8sQ0FBbUI7UUFOdEMsWUFBTyxHQUFHLEtBQUssQ0FBQztRQUVQLGlCQUFZLEdBQXFCLE1BQU0sQ0FBQztRQUt0RCxJQUFJLENBQUMsS0FBSyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUM7UUFDM0IsSUFBSSxDQUFDLGFBQWEsR0FBRyxvQ0FBbUIsQ0FBQyxLQUFLLENBQzVDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FDL0IsQ0FBQztJQUNKLENBQUM7SUFFRCxJQUFXLFNBQVM7UUFDbEIsT0FBTyxJQUFJLENBQUMsWUFBWSxLQUFLLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDdkQsQ0FBQztJQUNELElBQVcsTUFBTTtRQUNmLE9BQU8sQ0FDTCxJQUFJLENBQUMsWUFBWSxLQUFLLE1BQU07WUFDNUIsSUFBSSxDQUFDLFlBQVksS0FBSyxTQUFTO1lBQy9CLElBQUksQ0FBQyxPQUFPLENBQ2IsQ0FBQztJQUNKLENBQUM7SUFDRCxJQUFXLFNBQVM7UUFDbEIsT0FBTyxDQUFDLElBQUksQ0FBQyxTQUFTLElBQUksQ0FB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S0FBSyxDQUFDLFlBQVk7UUFDdkIsTUFBTSxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssSUFBSSxFQUFFO1lBQ3hCLE1BQU0sU0FBUyxHQUFHLE1BQU0sSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1lBRS9DLE1BQU0sT0FBTyxHQUFHLE1BQU0sU0FBUyxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ3pDLE1BQU0sb0JBQW9CLEdBQUcsSUFBQSxrQ0FBeUIsRUFDcEQsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUM5QixPQUFPLENBQ1IsQ0FBQztZQUNGLElBQUksQ0FBQyxXQUFXLENBQUM7Z0JBQ2YsSUFBSSxFQUFFLGlCQUFpQjtnQkFDdkIsU0FBUyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSTtnQkFDMUIsT0FBTztnQkFDUCxvQkFBb0I7YUFDckIsQ0FBQyxDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDdEIsQ0FBQztJQUVNLEtBQUssQ0FBQyxJQUFJO1FBQ2YsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7SUFDdEIsQ0FBQztDQUNGO0FBcGRELGdDQW9kQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIENvcHlyaWdodCAoYykgSGFzaGlDb3JwLCBJbmNcbi8vIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBNUEwtMi4wXG5pbXBvcnQgeyBTeW50aGVzaXplZFN0YWNrIH0gZnJvbSBcIi4vc3ludGgtc3RhY2tcIjtcbmltcG9ydCB7IFRlcnJhZm9ybSB9IGZyb20gXCIuL21vZGVscy90ZXJyYWZvcm1cIjtcbmltcG9ydCB7IGdldENvbnN0cnVjdElkc0Zvck91dHB1dHMsIE5lc3RlZFRlcnJhZm9ybU91dHB1dHMgfSBmcm9tIFwiLi9vdXRwdXRcIjtcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gXCJAY2RrdGYvY29tbW9uc1wiO1xuaW1wb3J0IHsgZXh0cmFjdEpzb25Mb2dJZlByZXNlbnQgfSBmcm9tIFwiLi9zZXJ2ZXIvdGVycmFmb3JtLWxvZ3NcIjtcbmltcG9ydCB7XG4gIFRlcnJhZm9ybUNsaSxcbiAgT3V0cHV0RmlsdGVyLFxuICB0cnlSZWFkR2VuZXJhdGVkQ29uZmlndXJhdGlvbkZpbGUsXG4gIHRyeVJlbW92ZUdlbmVyYXRlZENvbmZpZ3VyYXRpb25GaWxlLFxufSBmcm9tIFwiLi9tb2RlbHMvdGVycmFmb3JtLWNsaVwiO1xuaW1wb3J0IHsgUHJvdmlkZXJDb25zdHJhaW50IH0gZnJvbSBcIi4vZGVwZW5kZW5jaWVzL2RlcGVuZGVuY3ktbWFuYWdlclwiO1xuaW1wb3J0IHsgdGVycmFmb3JtSnNvblNjaGVtYSwgVGVycmFmb3JtU3RhY2sgfSBmcm9tIFwiLi90ZXJyYWZvcm0tanNvblwiO1xuaW1wb3J0IHsgVGVycmFmb3JtUHJvdmlkZXJMb2NrIH0gZnJvbSBcIi4vdGVycmFmb3JtLXByb3ZpZGVyLWxvY2tcIjtcbmltcG9ydCB7IGNvbnZlcnRDb25maWd1cmF0aW9uRmlsZSB9IGZyb20gXCIuL2NvbnZlcnRcIjtcblxuZXhwb3J0IHR5cGUgU3RhY2tVcGRhdGUgPVxuICB8IHtcbiAgICAgIHR5cGU6IFwicGxhbm5pbmdcIjtcbiAgICAgIHN0YWNrTmFtZTogc3RyaW5nO1xuICAgIH1cbiAgfCB7XG4gICAgICB0eXBlOiBcInBsYW5uZWRcIjtcbiAgICAgIHN0YWNrTmFtZTogc3RyaW5nO1xuICAgIH1cbiAgfCB7XG4gICAgICB0eXBlOiBcImRlcGxveWluZ1wiO1xuICAgICAgc3RhY2tOYW1lOiBzdHJpbmc7XG4gICAgfVxuICB8IHtcbiAgICAgIHR5cGU6IFwiZGVwbG95IHVwZGF0ZVwiO1xuICAgICAgc3RhY2tOYW1lOiBzdHJpbmc7XG4gICAgICBkZXBsb3lPdXRwdXQ6IHN0cmluZztcbiAgICB9XG4gIHwge1xuICAgICAgdHlwZTogXCJkZXBsb3llZFwiO1xuICAgICAgc3RhY2tOYW1lOiBzdHJpbmc7XG4gICAgICBvdXRwdXRzQnlDb25zdHJ1Y3RJZDogTmVzdGVkVGVycmFmb3JtT3V0cHV0cztcbiAgICAgIG91dHB1dHM6IFJlY29yZDxzdHJpbmcsIGFueT47XG4gICAgfVxuICB8IHtcbiAgICAgIHR5cGU6IFwiZGVzdHJveWluZ1wiO1xuICAgICAgc3RhY2tOYW1lOiBzdHJpbmc7XG4gICAgfVxuICB8IHtcbiAgICAgIHR5cGU6IFwiZGVzdHJveSB1cGRhdGVcIjtcbiAgICAgIHN0YWNrTmFtZTogc3RyaW5nO1xuICAgICAgZGVzdHJveU91dHB1dDogc3RyaW5nO1xuICAgIH1cbiAgfCB7XG4gICAgICB0eXBlOiBcImRlc3Ryb3llZFwiO1xuICAgICAgc3RhY2tOYW1lOiBzdHJpbmc7XG4gICAgfVxuICB8IHtcbiAgICAgIHR5cGU6IFwib3V0cHV0cyBmZXRjaGVkXCI7XG4gICAgICBzdGFja05hbWU6IHN0cmluZztcbiAgICAgIG91dHB1dHNCeUNvbnN0cnVjdElkOiBOZXN0ZWRUZXJyYWZvcm1PdXRwdXRzO1xuICAgICAgb3V0cHV0czogUmVjb3JkPHN0cmluZywgYW55PjtcbiAgICB9XG4gIHwge1xuICAgICAgdHlwZTogXCJlcnJvcmVkXCI7XG4gICAgICBzdGFja05hbWU6IHN0cmluZztcbiAgICAgIGVycm9yOiBzdHJpbmc7XG4gICAgfVxuICB8IHtcbiAgICAgIHR5cGU6IFwiZGlzbWlzc2VkXCI7XG4gICAgICBzdGFja05hbWU6IHN0cmluZztcbiAgICB9XG4gIHwge1xuICAgICAgdHlwZTogXCJpbXBvcnQgd2l0aCBjb25maWd1cmF0aW9uIGRldGVjdGVkXCI7XG4gICAgICBzdGFja05hbWU6IHN0cmluZztcbiAgICAgIGNvbmZpZ3VyYXRpb246IHN0cmluZztcbiAgICB9XG4gIHwge1xuICAgICAgdHlwZTogXCJpbXBvcnQgd2l0aCBjb25maWd1cmF0aW9uIGNvbnZlcnRlZFwiO1xuICAgICAgc3RhY2tOYW1lOiBzdHJpbmc7XG4gICAgICBjb25maWd1cmF0aW9uOiBzdHJpbmc7XG4gICAgfTtcblxuZXhwb3J0IHR5cGUgU3RhY2tVc2VySW5wdXRVcGRhdGUgPVxuICB8IFN0YWNrQXBwcm92YWxVcGRhdGVcbiAgfCBTdGFja1NlbnRpbmVsT3ZlcnJpZGVVcGRhdGU7XG5cbmV4cG9ydCB0eXBlIFN0YWNrQXBwcm92YWxVcGRhdGUgPSB7XG4gIHR5cGU6IFwid2FpdGluZyBmb3Igc3RhY2sgYXBwcm92YWxcIjtcbiAgc3RhY2tOYW1lOiBzdHJpbmc7XG4gIGFwcHJvdmU6ICgpID0+IHZvaWQ7XG4gIHJlamVjdDogKCkgPT4gdm9pZDtcbn07XG5leHBvcnQgdHlwZSBTdGFja1NlbnRpbmVsT3ZlcnJpZGVVcGRhdGUgPSB7XG4gIHR5cGU6IFwid2FpdGluZyBmb3Igc3RhY2sgc2VudGluZWwgb3ZlcnJpZGVcIjtcbiAgc3RhY2tOYW1lOiBzdHJpbmc7XG4gIG92ZXJyaWRlOiAoKSA9PiB2b2lkO1xuICByZWplY3Q6ICgpID0+IHZvaWQ7XG59O1xuZXhwb3J0IHR5cGUgRXh0ZXJuYWxTdGFja0FwcHJvdmFsVXBkYXRlID0ge1xuICB0eXBlOiBcImV4dGVybmFsIHN0YWNrIGFwcHJvdmFsIHJlcGx5XCI7XG4gIHN0YWNrTmFtZTogc3RyaW5nO1xuICBhcHByb3ZlZDogYm9vbGVhbjsgLy8gZmFsc2UgPSByZWplY3RlZFxufTtcbmV4cG9ydCB0eXBlIEV4dGVybmFsU3RhY2tTZW50aW5lbE92ZXJyaWRlVXBkYXRlID0ge1xuICB0eXBlOiBcImV4dGVybmFsIHN0YWNrIHNlbnRpbmVsIG92ZXJyaWRlIHJlcGx5XCI7XG4gIHN0YWNrTmFtZTogc3RyaW5nO1xuICBvdmVycmlkZGVuOiBib29sZWFuOyAvLyBmYWxzZSA9IHJlamVjdGVkXG59O1xuXG5hc3luYyBmdW5jdGlvbiBnZXRUZXJyYWZvcm1DbGllbnQoXG4gIGFib3J0U2lnbmFsOiBBYm9ydFNpZ25hbCxcbiAgc3RhY2s6IFN5bnRoZXNpemVkU3RhY2ssXG4gIGNyZWF0ZVRlcnJhZm9ybUxvZ0hhbmRsZXI6IChcbiAgICBwaGFzZTogc3RyaW5nLFxuICAgIGZpbHRlcj86IE91dHB1dEZpbHRlcltdXG4gICkgPT4gKG1lc3NhZ2U6IHN0cmluZywgaXNFcnJvcj86IGJvb2xlYW4pID0+IHZvaWRcbik6IFByb21pc2U8VGVycmFmb3JtPiB7XG4gIHJldHVybiBuZXcgVGVycmFmb3JtQ2xpKGFib3J0U2lnbmFsLCBzdGFjaywgY3JlYXRlVGVycmFmb3JtTG9nSGFuZGxlcik7XG59XG5cbnR5cGUgQ2RrdGZTdGFja09wdGlvbnMgPSB7XG4gIHN0YWNrOiBTeW50aGVzaXplZFN0YWNrO1xuICBvblVwZGF0ZTogKFxuICAgIHVwZGF0ZTpcbiAgICAgIHwgU3RhY2tVcGRhdGVcbiAgICAgIHwgU3RhY2tBcHByb3ZhbFVwZGF0ZVxuICAgICAgfCBFeHRlcm5hbFN0YWNrQXBwcm92YWxVcGRhdGVcbiAgICAgIHwgU3RhY2tTZW50aW5lbE92ZXJyaWRlVXBkYXRlXG4gICAgICB8IEV4dGVybmFsU3RhY2tTZW50aW5lbE92ZXJyaWRlVXBkYXRlXG4gICkgPT4gdm9pZDtcbiAgb25Mb2c/OiAobG9nOiB7IG1lc3NhZ2U6IHN0cmluZzsgaXNFcnJvcjogYm9vbGVhbiB9KSA9PiB2b2lkO1xuICBhdXRvQXBwcm92ZT86IGJvb2xlYW47XG4gIG1pZ3JhdGVTdGF0ZT86IGJvb2xlYW47XG4gIGFib3J0U2lnbmFsOiBBYm9ydFNpZ25hbDtcbn07XG5cbnR5cGUgQ2RrdGZTdGFja1N0YXRlcyA9XG4gIHwgU3RhY2tVcGRhdGVbXCJ0eXBlXCJdXG4gIHwgU3RhY2tBcHByb3ZhbFVwZGF0ZVtcInR5cGVcIl1cbiAgfCBTdGFja1NlbnRpbmVsT3ZlcnJpZGVVcGRhdGVbXCJ0eXBlXCJdXG4gIHwgRXh0ZXJuYWxTdGFja0FwcHJvdmFsVXBkYXRlW1widHlwZVwiXVxuICB8IEV4dGVybmFsU3RhY2tTZW50aW5lbE92ZXJyaWRlVXBkYXRlW1widHlwZVwiXVxuICB8IFwiaWRsZVwiXG4gIHwgXCJkb25lXCI7XG5cbmV4cG9ydCBjbGFzcyBDZGt0ZlN0YWNrIHtcbiAgcHVibGljIHN0YWNrOiBTeW50aGVzaXplZFN0YWNrO1xuICBwdWJsaWMgb3V0cHV0cz86IFJlY29yZDxzdHJpbmcsIGFueT47XG4gIHB1YmxpYyBvdXRwdXRzQnlDb25zdHJ1Y3RJZD86IE5lc3RlZFRlcnJhZm9ybU91dHB1dHM7XG4gIHB1YmxpYyBzdG9wcGVkID0gZmFsc2U7XG4gIHB1YmxpYyBjdXJyZW50V29ya1Byb21pc2U6IFByb21pc2U8dm9pZD4gfCB1bmRlZmluZWQ7XG4gIHB1YmxpYyByZWFkb25seSBjdXJyZW50U3RhdGU6IENka3RmU3RhY2tTdGF0ZXMgPSBcImlkbGVcIjtcbiAgcHVibGljIGVycm9yPzogc3RyaW5nO1xuICBwcml2YXRlIHJlYWRvbmx5IHBhcnNlZENvbnRlbnQ6IFRlcnJhZm9ybVN0YWNrO1xuXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyBvcHRpb25zOiBDZGt0ZlN0YWNrT3B0aW9ucykge1xuICAgIHRoaXMuc3RhY2sgPSBvcHRpb25zLnN0YWNrO1xuICAgIHRoaXMucGFyc2VkQ29udGVudCA9IHRlcnJhZm9ybUpzb25TY2hlbWEucGFyc2UoXG4gICAgICBKU09OLnBhcnNlKHRoaXMuc3RhY2suY29udGVudClcbiAgICApO1xuICB9XG5cbiAgcHVibGljIGdldCBpc1BlbmRpbmcoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuY3VycmVudFN0YXRlID09PSBcImlkbGVcIiAmJiAhdGhpcy5zdG9wcGVkO1xuICB9XG4gIHB1YmxpYyBnZXQgaXNEb25lKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAoXG4gICAgICB0aGlzLmN1cnJlbnRTdGF0ZSA9PT0gXCJkb25lXCIgfHxcbiAgICAgIHRoaXMuY3VycmVudFN0YXRlID09PSBcImVycm9yZWRcIiB8fFxuICAgICAgdGhpcy5zdG9wcGVkXG4gICAgKTtcbiAgfVxuICBwdWJsaWMgZ2V0IGlzUnVubmluZygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gIXRoaXMuaXNQZW5kaW5nICYmICF0aGlzLmlzRG9uZTtcbiAgfVxuXG4gIHByaXZhdGUgdXBkYXRlU3RhdGUoXG4gICAgdXBkYXRlOlxuICAgICAgfCBTdGFja1VwZGF0ZVxuICAgICAgfCBTdGFja0FwcHJvdmFsVXBkYXRlXG4gICAgICB8IFN0YWNrU2VudGluZWxPdmVycmlkZVVwZGF0ZVxuICAgICAgfCBFeHRlcm5hbFN0YWNrQXBwcm92YWxVcGRhdGVcbiAgICAgIHwgRXh0ZXJuYWxTdGFja1NlbnRpbmVsT3ZlcnJpZGVVcGRhdGVcbiAgICAgIHwgeyB0eXBlOiBcImlkbGVcIiB9XG4gICAgICB8IHsgdHlwZTogXCJkb25lXCIgfVxuICApIHtcbiAgICBsb2dnZXIuZGVidWcoYFske3RoaXMuc3RhY2submFtZX1dOiAke3VwZGF0ZS50eXBlfWApO1xuICAgICh0aGlzLmN1cnJlbnRTdGF0ZSBhcyBDZGt0ZlN0YWNrU3RhdGVzKSA9IHVwZGF0ZS50eXBlO1xuICAgIHN3aXRjaCAodXBkYXRlLnR5cGUpIHtcbiAgICAgIGNhc2UgXCJpZGxlXCI6XG4gICAgICBjYXNlIFwiZG9uZVwiOlxuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSBcImVycm9yZWRcIjpcbiAgICAgICAgdGhpcy5lcnJvciA9IHVwZGF0ZS5lcnJvcjtcbiAgICAgICAgdGhpcy5vcHRpb25zLm9uVXBkYXRlKHVwZGF0ZSk7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIFwib3V0cHV0cyBmZXRjaGVkXCI6XG4gICAgICBjYXNlIFwiZGVwbG95ZWRcIjpcbiAgICAgICAgbG9nZ2VyLmRlYnVnKGBPdXRwdXRzOiAke0pTT04uc3RyaW5naWZ5KHVwZGF0ZS5vdXRwdXRzKX1gKTtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgICAgIGBPdXRwdXRzQnlDb25zdHJ1Y3RJZDogJHtKU09OLnN0cmluZ2lmeSh1cGRhdGUub3V0cHV0c0J5Q29uc3RydWN0SWQpfWBcbiAgICAgICAgKTtcbiAgICAgICAgdGhpcy5vdXRwdXRzID0gdXBkYXRlLm91dHB1dHM7XG4gICAgICAgIHRoaXMub3V0cHV0c0J5Q29uc3RydWN0SWQgPSB1cGRhdGUub3V0cHV0c0J5Q29uc3RydWN0SWQ7XG4gICAgICAgIHRoaXMub3B0aW9ucy5vblVwZGF0ZSh1cGRhdGUpO1xuICAgICAgICBicmVhaztcblxuICAgICAgZGVmYXVsdDpcbiAgICAgICAgdGhpcy5vcHRpb25zLm9uVXBkYXRlKHVwZGF0ZSk7XG4gICAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlVGVycmFmb3JtTG9nSGFuZGxlcihcbiAgICBwaGFzZTogc3RyaW5nLFxuICAgIGZpbHRlcnM/OiBPdXRwdXRGaWx0ZXJbXVxuICApOiAobWVzc2FnZTogc3RyaW5nLCBpc0Vycm9yPzogYm9vbGVhbikgPT4gdm9pZCB7XG4gICAgbG9nZ2VyLmRlYnVnKFwiQ3JlYXRpbmcgdGVycmFmb3JtIGxvZyBoYW5kbGVyXCIsIHBoYXNlKTtcblxuICAgIGNvbnN0IG9uTG9nID0gdGhpcy5vcHRpb25zLm9uTG9nO1xuICAgIHJldHVybiAobXNnOiBzdHJpbmcsIGlzRXJyb3IgPSBmYWxzZSkgPT4ge1xuICAgICAgY29uc3QgbWVzc2FnZSA9IGV4dHJhY3RKc29uTG9nSWZQcmVzZW50KG1zZyk7XG4gICAgICBsb2dnZXIuZGVidWcoYFske3RoaXMub3B0aW9ucy5zdGFjay5uYW1lfV0oJHtwaGFzZX0pOiAke21zZ31gKTtcblxuICAgICAgY29uc3QgZmlsdGVyVG9BcHBseSA9IGZpbHRlcnM/LmZpbmQoKGZpbHRlcikgPT5cbiAgICAgICAgZmlsdGVyLmNvbmRpdGlvbihtZXNzYWdlKVxuICAgICAgKTtcbiAgICAgIGNvbnN0IGZpbHRlcmVkTWVzc2FnZSA9IGZpbHRlclRvQXBwbHlcbiAgICAgICAgPyBmaWx0ZXJUb0FwcGx5LnRyYW5zZm9ybShtZXNzYWdlKVxuICAgICAgICA6IG1lc3NhZ2U7XG5cbiAgICAgIGlmIChmaWx0ZXJlZE1lc3NhZ2UpIHtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgICAgIGBGaWx0ZXIgJHtmaWx0ZXJUb0FwcGx5fSBhcHBsaWVkIG9uIGxpbmUgJyR7bWVzc2FnZX0nIHdpdGggcmVzdWx0ICcke2ZpbHRlcmVkTWVzc2FnZX0nYFxuICAgICAgICApO1xuICAgICAgfVxuXG4gICAgICBpZiAob25Mb2cpIHtcbiAgICAgICAgb25Mb2coeyBtZXNzYWdlOiBmaWx0ZXJlZE1lc3NhZ2UsIGlzRXJyb3IgfSk7XG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgdGVycmFmb3JtQ2xpZW50KCkge1xuICAgIHJldHVybiBhd2FpdCBnZXRUZXJyYWZvcm1DbGllbnQoXG4gICAgICB0aGlzLm9wdGlvbnMuYWJvcnRTaWduYWwsXG4gICAgICB0aGlzLm9wdGlvbnMuc3RhY2ssXG4gICAgICB0aGlzLmNyZWF0ZVRlcnJhZm9ybUxvZ0hhbmRsZXIuYmluZCh0aGlzKVxuICAgICk7XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgaW5pdGFsaXplVGVycmFmb3JtKG5vQ29sb3I/OiBib29sZWFuKSB7XG4gICAgY29uc3QgdGVycmFmb3JtID0gYXdhaXQgdGhpcy50ZXJyYWZvcm1DbGllbnQoKTtcbiAgICBjb25zdCBuZWVkc0xvY2tmaWxlVXBkYXRlID0gYXdhaXQgdGhpcy5jaGVja05lZWRzTG9ja2ZpbGVVcGRhdGUoKTtcbiAgICBjb25zdCBuZWVkc1VwZ3JhZGUgPSBhd2FpdCB0aGlzLmNoZWNrTmVlZHNVcGdyYWRlKCk7XG4gICAgYXdhaXQgdGVycmFmb3JtLmluaXQoe1xuICAgICAgbmVlZHNVcGdyYWRlLFxuICAgICAgbm9Db2xvcjogbm9Db2xvciA/PyBmYWxzZSxcbiAgICAgIG5lZWRzTG9ja2ZpbGVVcGRhdGUsXG4gICAgICBtaWdyYXRlU3RhdGU6IHRoaXMub3B0aW9ucy5taWdyYXRlU3RhdGUgPz8gZmFsc2UsXG4gICAgfSk7XG4gICAgcmV0dXJuIHRlcnJhZm9ybTtcbiAgfVxuXG4gIHByaXZhdGUgcmVxdWlyZWRQcm92aWRlcnMoKSB7XG4gICAgLy8gUmVhZCByZXF1aXJlZCBwcm92aWRlcnMgZnJvbSB0aGUgc3RhY2sgb3V0cHV0XG4gICAgY29uc3QgcmVxdWlyZWRQcm92aWRlcnMgPSB0aGlzLnBhcnNlZENvbnRlbnQudGVycmFmb3JtPy5yZXF1aXJlZF9wcm92aWRlcnM7XG5cbiAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyhyZXF1aXJlZFByb3ZpZGVycyB8fCB7fSkucmVkdWNlKChhY2MsIG9iaikgPT4ge1xuICAgICAgY29uc3QgY29uc3RyYWludCA9IG5ldyBQcm92aWRlckNvbnN0cmFpbnQob2JqLnNvdXJjZSwgb2JqLnZlcnNpb24pO1xuICAgICAgYWNjW2NvbnN0cmFpbnQuc291cmNlXSA9IGNvbnN0cmFpbnQ7XG4gICAgICByZXR1cm4gYWNjO1xuICAgIH0sIHt9IGFzIFJlY29yZDxzdHJpbmcsIFByb3ZpZGVyQ29uc3RyYWludD4pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBjaGVja05lZWRzTG9ja2ZpbGVVcGRhdGUoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgaWYgKHRoaXMub3B0aW9ucy5taWdyYXRlU3RhdGUpIHtcbiAgICAgIC8vIElmIHdlJ3JlIG1pZ3JhdGluZyBzdGF0ZSwgd2UgbmVlZCB0byBpbml0XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgY29uc3QgbG9jayA9IG5ldyBUZXJyYWZvcm1Qcm92aWRlckxvY2sodGhpcy5zdGFjay53b3JraW5nRGlyZWN0b3J5KTtcbiAgICBjb25zdCBsb2NrRmlsZUV4aXN0cyA9IGF3YWl0IGxvY2suaGFzUHJvdmlkZXJMb2NrRmlsZSgpO1xuXG4gICAgaWYgKCFsb2NrRmlsZUV4aXN0cykge1xuICAgICAgLy8gSWYgd2UgZG9uJ3QgaGF2ZSBhIGxvY2sgZmlsZSwgdGhpcyBpcyBwcm9iYWJseSB0aGUgZmlyc3QgaW5pdFxuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgY29uc3QgcmVxdWlyZWRQcm92aWRlcnMgPSB0aGlzLnJlcXVpcmVkUHJvdmlkZXJzKCk7XG5cbiAgICBmb3IgKGNvbnN0IHByb3ZpZGVyIG9mIE9iamVjdC52YWx1ZXMocmVxdWlyZWRQcm92aWRlcnMpKSB7XG4gICAgICBjb25zdCBoYXNQcm92aWRlciA9IGF3YWl0IGxvY2suaGFzTWF0Y2hpbmdQcm92aWRlcihwcm92aWRlcik7XG4gICAgICBpZiAoIWhhc1Byb3ZpZGVyKSB7XG4gICAgICAgIC8vIElmIHdlIGRvbid0IGhhdmUgYSBwcm92aWRlciBvciB2ZXJzaW9uIGRvZXNuJ3QgbWF0Y2gsIHdlIG5lZWQgdG8gaW5pdFxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGNoZWNrTmVlZHNVcGdyYWRlKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IGxvY2sgPSBuZXcgVGVycmFmb3JtUHJvdmlkZXJMb2NrKHRoaXMuc3RhY2sud29ya2luZ0RpcmVjdG9yeSk7XG4gICAgY29uc3QgYWxsUHJvdmlkZXJzID0gdGhpcy5yZXF1aXJlZFByb3ZpZGVycygpO1xuICAgIGNvbnN0IGxvY2tlZFByb3ZpZGVycyA9IE9iamVjdC52YWx1ZXMoYXdhaXQgbG9jay5wcm92aWRlcnMoKSk7XG5cbiAgICAvLyBDaGVjayBpZiBhbnkgcHJvdmlkZXIgY29udGFpbmVkIGluIGBwcm92aWRlcnNgIHZpb2xhdGVzIGNvbnN0cmFpbnRzIGluIGBsb2NrZWRQcm92aWRlcnNgXG4gICAgLy8gVXBncmFkZSBpZiBzb21lIHByb3ZpZGVyIGNvbnN0cmFpbnQgbm90IG1ldFxuICAgIC8vIElmIGEgcHJvdmlkZXIgd2Fzbid0IHByZXNldCBpbiBsb2NrZWRQcm92aWRlcnMsIHRoYXQncyBmaW5lOyBpdCB3aWxsIGp1c3QgZ2V0IGFkZGVkXG4gICAgcmV0dXJuIGxvY2tlZFByb3ZpZGVycy5zb21lKChsb2NrZWRQcm92aWRlcikgPT4ge1xuICAgICAgY29uc3QgbG9ja2VkQ29uc3RyYWludCA9IGxvY2tlZFByb3ZpZGVyLmNvbnN0cmFpbnRzO1xuICAgICAgaWYgKCFsb2NrZWRDb25zdHJhaW50KSB7XG4gICAgICAgIC8vIFByb3ZpZGVyIGxvY2sgZG9lc24ndCBoYXZlIGEgY29uc3RyYWludCBzcGVjaWZpZWQsIHNvIHdlIGNhbid0IGNoZWNrLlxuICAgICAgICAvLyBUaGlzIHNob3VsZG4ndCBoYXBwZW5cbiAgICAgICAgbG9nZ2VyLmRlYnVnKFxuICAgICAgICAgIGBQcm92aWRlciBsb2NrIGRvZXNuJ3QgaGF2ZSBhIGNvbnN0cmFpbnQgZm9yICR7bG9ja2VkUHJvdmlkZXIubmFtZX1gXG4gICAgICAgICk7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcHJvdmlkZXIgPSBhbGxQcm92aWRlcnNbbG9ja2VkQ29uc3RyYWludC5zb3VyY2VdO1xuICAgICAgaWYgKCFwcm92aWRlcikge1xuICAgICAgICAvLyBlbHNlIG5vIGxvbmdlciB1c2luZyB0aGlzIHByb3ZpZGVyLCBzbyB3b24ndCBjYXVzZSBwcm9ibGVtc1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIHJldHVybiAhbG9ja2VkQ29uc3RyYWludC5tYXRjaGVzVmVyc2lvbihwcm92aWRlci52ZXJzaW9uID8/IFwiPjBcIik7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHJ1bihjYjogKCkgPT4gUHJvbWlzZTx2b2lkPikge1xuICAgIGlmICh0aGlzLnN0b3BwZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0cnkge1xuICAgICAgdGhpcy5jdXJyZW50V29ya1Byb21pc2UgPSBjYigpO1xuICAgICAgYXdhaXQgdGhpcy5jdXJyZW50V29ya1Byb21pc2U7XG4gICAgICB0aGlzLnVwZGF0ZVN0YXRlKHsgdHlwZTogXCJkb25lXCIgfSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbG9nZ2VyLnRyYWNlKFwiRXJyb3IgaW4gY3VycmVudFdvcmtQcm9taXNlXCIsIGUpO1xuICAgICAgdGhpcy5jdXJyZW50V29ya1Byb21pc2UgPSB1bmRlZmluZWQ7XG4gICAgICB0aGlzLnVwZGF0ZVN0YXRlKHtcbiAgICAgICAgdHlwZTogXCJlcnJvcmVkXCIsXG4gICAgICAgIHN0YWNrTmFtZTogdGhpcy5zdGFjay5uYW1lLFxuICAgICAgICBlcnJvcjogU3RyaW5nKGUpLFxuICAgICAgfSk7XG4gICAgICB0aHJvdyBlO1xuICAgIH0gZmluYWxseSB7XG4gICAgICB0aGlzLmN1cnJlbnRXb3JrUHJvbWlzZSA9IHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgYXN5bmMgZGlmZih7XG4gICAgcmVmcmVzaE9ubHksXG4gICAgdGVycmFmb3JtUGFyYWxsZWxpc20sXG4gICAgdmFycyxcbiAgICB2YXJGaWxlcyxcbiAgICBub0NvbG9yLFxuICB9OiB7XG4gICAgcmVmcmVzaE9ubHk/OiBib29sZWFuO1xuICAgIHRlcnJhZm9ybVBhcmFsbGVsaXNtPzogbnVtYmVyO1xuICAgIHZhcnM/OiBzdHJpbmdbXTtcbiAgICB2YXJGaWxlcz86IHN0cmluZ1tdO1xuICAgIG5vQ29sb3I/OiBib29sZWFuO1xuICB9KSB7XG4gICAgYXdhaXQgdGhpcy5ydW4oYXN5bmMgKCkgPT4ge1xuICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7IHR5cGU6IFwicGxhbm5pbmdcIiwgc3RhY2tOYW1lOiB0aGlzLnN0YWNrLm5hbWUgfSk7XG4gICAgICBjb25zdCB0ZXJyYWZvcm0gPSBhd2FpdCB0aGlzLnRlcnJhZm9ybUNsaWVudCgpO1xuXG4gICAgICBhd2FpdCB0ZXJyYWZvcm0ucGxhbih7XG4gICAgICAgIGRlc3Ryb3k6IGZhbHNlLFxuICAgICAgICByZWZyZXNoT25seSxcbiAgICAgICAgcGFyYWxsZWxpc206IHRlcnJhZm9ybVBhcmFsbGVsaXNtLFxuICAgICAgICB2YXJzLFxuICAgICAgICB2YXJGaWxlcyxcbiAgICAgICAgbm9Db2xvcixcbiAgICAgIH0pO1xuICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7IHR5cGU6IFwicGxhbm5lZFwiLCBzdGFja05hbWU6IHRoaXMuc3RhY2submFtZSB9KTtcblxuICAgICAgLy8gRmluZCBnZW5lcmF0ZWQgZmlsZVxuICAgICAgY29uc3QgY29uZmlnRmlsZSA9IGF3YWl0IHRyeVJlYWRHZW5lcmF0ZWRDb25maWd1cmF0aW9uRmlsZShcbiAgICAgICAgdGhpcy5zdGFjay53b3JraW5nRGlyZWN0b3J5XG4gICAgICApO1xuICAgICAgaWYgKGNvbmZpZ0ZpbGUpIHtcbiAgICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7XG4gICAgICAgICAgdHlwZTogXCJpbXBvcnQgd2l0aCBjb25maWd1cmF0aW9uIGRldGVjdGVkXCIsXG4gICAgICAgICAgc3RhY2tOYW1lOiB0aGlzLnN0YWNrLm5hbWUsXG4gICAgICAgICAgY29uZmlndXJhdGlvbjogY29uZmlnRmlsZSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgY29uc3QgY29udmVydGVkQ29kZSA9IGF3YWl0IGNvbnZlcnRDb25maWd1cmF0aW9uRmlsZShcbiAgICAgICAgICBjb25maWdGaWxlLFxuICAgICAgICAgIHRoaXMuc3RhY2sud29ya2luZ0RpcmVjdG9yeVxuICAgICAgICApO1xuICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlKHtcbiAgICAgICAgICB0eXBlOiBcImltcG9ydCB3aXRoIGNvbmZpZ3VyYXRpb24gY29udmVydGVkXCIsXG4gICAgICAgICAgc3RhY2tOYW1lOiB0aGlzLnN0YWNrLm5hbWUsXG4gICAgICAgICAgY29uZmlndXJhdGlvbjogY29udmVydGVkQ29kZSxcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IG9uTG9nID0gdGhpcy5vcHRpb25zLm9uTG9nO1xuICAgICAgICBpZiAob25Mb2cpIHtcbiAgICAgICAgICBvbkxvZyh7XG4gICAgICAgICAgICBtZXNzYWdlOiBgSW1wb3J0IHdpdGhvdXQgY29uZmlndXJhdGlvbiBkZXRlY3RlZC4gVGVycmFmb3JtIGhhcyBjcmVhdGVkIGNvbmZpZ3VyYXRpb24gZm9yIGl0OlxuJHtjb25maWdGaWxlfVxuXG5DREtURiBoYXMgdHJhbnNsYXRlZCB0aGUgY29kZSB0byB0aGUgZm9sbG93aW5nOlxuXG4ke2NvbnZlcnRlZENvZGV9XG5cblBsZWFzZSByZXZpZXcgdGhlIGNvZGUgYW5kIG1ha2UgYW55IG5lY2Vzc2FyeSBjaGFuZ2VzIGJlZm9yZSBhZGRpbmcgaXQgdG8geW91ciBjb2RlYmFzZS5cbk1ha2Ugc3VyZSB0byBvbmx5IGNvcHkgdGhlIGNvZGUgd2l0aGluIHRoZSBjb25zdHJ1Y3QncyBjb25zdHJ1Y3Rvci5cblxuTk9URTogWW91ciByZXNvdXJjZSBoYXMgbm90IHlldCBiZWNvbWUgbWFuYWdlZCBieSBDREtURi4gXG5UbyBmaW5pc2ggdGhlIGltcG9ydCByZW1vdmUgdGhlIGNhbGwgXCJnZW5lcmF0ZUNvbmZpZ0ZvckltcG9ydFwiLCBhZGQgdGhlIGFib3ZlIGNvZGUgd2l0aGluIHRoZSBjb25zdHJ1Y3QncyBjb25zdHJ1Y3RvciwgYW5kIHRoZW4gYXBwZW5kIHRoZSBjYWxsIGltcG9ydEZyb20oPHJlc291cmNlX2lkX3RvX2ltcG9ydF9mcm9tPikgdG8gdGhlIGdlbmVyYXRlZCBjb2RlOiBcblxubmV3IFNvbWVSZXNvdXJjZSguLi4pLmltcG9ydEZyb20oXCJzb21lX2lkXCIpXG5gLFxuICAgICAgICAgICAgaXNFcnJvcjogZmFsc2UsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgYXdhaXQgdHJ5UmVtb3ZlR2VuZXJhdGVkQ29uZmlndXJhdGlvbkZpbGUodGhpcy5zdGFjay53b3JraW5nRGlyZWN0b3J5KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBkZXBsb3kob3B0czoge1xuICAgIHJlZnJlc2hPbmx5PzogYm9vbGVhbjtcbiAgICB0ZXJyYWZvcm1QYXJhbGxlbGlzbT86IG51bWJlcjtcbiAgICBub0NvbG9yPzogYm9vbGVhbjtcbiAgICB2YXJzPzogc3RyaW5nW107XG4gICAgdmFyRmlsZXM/OiBzdHJpbmdbXTtcbiAgfSkge1xuICAgIGNvbnN0IHsgcmVmcmVzaE9ubHksIHRlcnJhZm9ybVBhcmFsbGVsaXNtLCBub0NvbG9yLCB2YXJzLCB2YXJGaWxlcyB9ID0gb3B0cztcbiAgICBhd2FpdCB0aGlzLnJ1bihhc3luYyAoKSA9PiB7XG4gICAgICB0aGlzLnVwZGF0ZVN0YXRlKHsgdHlwZTogXCJwbGFubmluZ1wiLCBzdGFja05hbWU6IHRoaXMuc3RhY2submFtZSB9KTtcbiAgICAgIGNvbnN0IHRlcnJhZm9ybSA9IGF3YWl0IHRoaXMudGVycmFmb3JtQ2xpZW50KCk7XG5cbiAgICAgIGNvbnN0IHsgY2FuY2VsbGVkIH0gPSBhd2FpdCB0ZXJyYWZvcm0uZGVwbG95KFxuICAgICAgICB7XG4gICAgICAgICAgYXV0b0FwcHJvdmU6IHRoaXMub3B0aW9ucy5hdXRvQXBwcm92ZSxcbiAgICAgICAgICByZWZyZXNoT25seSxcbiAgICAgICAgICBwYXJhbGxlbGlzbTogdGVycmFmb3JtUGFyYWxsZWxpc20sXG4gICAgICAgICAgdmFycyxcbiAgICAgICAgICB2YXJGaWxlcyxcbiAgICAgICAgICBub0NvbG9yLFxuICAgICAgICB9LFxuICAgICAgICAoc3RhdGUpID0+IHtcbiAgICAgICAgICAvLyBzdGF0ZSB1cGRhdGVzIHdoaWxlIGFwcGx5IHJ1bnMgdGhhdCBhZmZlY3QgdGhlIFVJXG4gICAgICAgICAgaWYgKHN0YXRlLnR5cGUgPT09IFwicnVubmluZ1wiICYmICFzdGF0ZS5jYW5jZWxsZWQpIHtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlU3RhdGUoe1xuICAgICAgICAgICAgICB0eXBlOiBcImRlcGxveWluZ1wiLFxuICAgICAgICAgICAgICBzdGFja05hbWU6IHRoaXMuc3RhY2submFtZSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUudHlwZSA9PT0gXCJ3YWl0aW5nIGZvciBhcHByb3ZhbFwiKSB7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlKHtcbiAgICAgICAgICAgICAgdHlwZTogXCJ3YWl0aW5nIGZvciBzdGFjayBhcHByb3ZhbFwiLFxuICAgICAgICAgICAgICBzdGFja05hbWU6IHRoaXMuc3RhY2submFtZSxcbiAgICAgICAgICAgICAgYXBwcm92ZTogc3RhdGUuYXBwcm92ZSxcbiAgICAgICAgICAgICAgcmVqZWN0OiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgc3RhdGUucmVqZWN0KCk7XG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7XG4gICAgICAgICAgICAgICAgICB0eXBlOiBcImRpc21pc3NlZFwiLFxuICAgICAgICAgICAgICAgICAgc3RhY2tOYW1lOiB0aGlzLnN0YWNrLm5hbWUsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlLnR5cGUgPT09IFwid2FpdGluZyBmb3Igc2VudGluZWwgb3ZlcnJpZGVcIikge1xuICAgICAgICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7XG4gICAgICAgICAgICAgIHR5cGU6IFwid2FpdGluZyBmb3Igc3RhY2sgc2VudGluZWwgb3ZlcnJpZGVcIixcbiAgICAgICAgICAgICAgc3RhY2tOYW1lOiB0aGlzLnN0YWNrLm5hbWUsXG4gICAgICAgICAgICAgIG92ZXJyaWRlOiBzdGF0ZS5vdmVycmlkZSxcbiAgICAgICAgICAgICAgcmVqZWN0OiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgc3RhdGUucmVqZWN0KCk7XG4gICAgICAgICAgICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7XG4gICAgICAgICAgICAgICAgICB0eXBlOiBcImRpc21pc3NlZFwiLFxuICAgICAgICAgICAgICAgICAgc3RhY2tOYW1lOiB0aGlzLnN0YWNrLm5hbWUsXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlLnR5cGUgPT09IFwiZXh0ZXJuYWwgYXBwcm92YWwgcmVwbHlcIikge1xuICAgICAgICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7XG4gICAgICAgICAgICAgIHR5cGU6IFwiZXh0ZXJuYWwgc3RhY2sgYXBwcm92YWwgcmVwbHlcIixcbiAgICAgICAgICAgICAgc3RhY2tOYW1lOiB0aGlzLnN0YWNrLm5hbWUsXG4gICAgICAgICAgICAgIGFwcHJvdmVkOiBzdGF0ZS5hcHByb3ZlZCxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUudHlwZSA9PT0gXCJleHRlcm5hbCBzZW50aW5lbCBvdmVycmlkZSByZXBseVwiKSB7XG4gICAgICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlKHtcbiAgICAgICAgICAgICAgdHlwZTogXCJleHRlcm5hbCBzdGFjayBzZW50aW5lbCBvdmVycmlkZSByZXBseVwiLFxuICAgICAgICAgICAgICBzdGFja05hbWU6IHRoaXMuc3RhY2submFtZSxcbiAgICAgICAgICAgICAgb3ZlcnJpZGRlbjogc3RhdGUub3ZlcnJpZGRlbixcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgKTtcblxuICAgICAgaWYgKCFjYW5jZWxsZWQpIHtcbiAgICAgICAgY29uc3Qgb3V0cHV0cyA9IGF3YWl0IHRlcnJhZm9ybS5vdXRwdXQoKTtcbiAgICAgICAgY29uc3Qgb3V0cHV0c0J5Q29uc3RydWN0SWQgPSBnZXRDb25zdHJ1Y3RJZHNGb3JPdXRwdXRzKFxuICAgICAgICAgIEpTT04ucGFyc2UodGhpcy5zdGFjay5jb250ZW50KSxcbiAgICAgICAgICBvdXRwdXRzXG4gICAgICAgICk7XG5cbiAgICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7XG4gICAgICAgICAgdHlwZTogXCJkZXBsb3llZFwiLFxuICAgICAgICAgIHN0YWNrTmFtZTogdGhpcy5zdGFjay5uYW1lLFxuICAgICAgICAgIG91dHB1dHMsXG4gICAgICAgICAgb3V0cHV0c0J5Q29uc3RydWN0SWQsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIGFzeW5jIGRlc3Ryb3kob3B0czoge1xuICAgIHRlcnJhZm9ybVBhcmFsbGVsaXNtPzogbnVtYmVyO1xuICAgIHZhcnM/OiBzdHJpbmdbXTtcbiAgICB2YXJGaWxlcz86IHN0cmluZ1tdO1xuICAgIG5vQ29sb3I/OiBib29sZWFuO1xuICB9KSB7XG4gICAgY29uc3QgeyB0ZXJyYWZvcm1QYXJhbGxlbGlzbSwgbm9Db2xvciwgdmFycywgdmFyRmlsZXMgfSA9IG9wdHM7XG4gICAgYXdhaXQgdGhpcy5ydW4oYXN5bmMgKCkgPT4ge1xuICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7IHR5cGU6IFwicGxhbm5pbmdcIiwgc3RhY2tOYW1lOiB0aGlzLnN0YWNrLm5hbWUgfSk7XG4gICAgICBjb25zdCB0ZXJyYWZvcm0gPSBhd2FpdCB0aGlzLnRlcnJhZm9ybUNsaWVudCgpO1xuICAgICAgY29uc3QgeyBjYW5jZWxsZWQgfSA9IGF3YWl0IHRlcnJhZm9ybS5kZXN0cm95KFxuICAgICAgICB7XG4gICAgICAgICAgYXV0b0FwcHJvdmU6IHRoaXMub3B0aW9ucy5hdXRvQXBwcm92ZSxcbiAgICAgICAgICBwYXJhbGxlbGlzbTogdGVycmFmb3JtUGFyYWxsZWxpc20sXG4gICAgICAgICAgdmFycyxcbiAgICAgICAgICB2YXJGaWxlcyxcbiAgICAgICAgICBub0NvbG9yLFxuICAgICAgICB9LFxuICAgICAgICAoc3RhdGUpID0+IHtcbiAgICAgICAgICAvLyBzdGF0ZSB1cGRhdGVzIHdoaWxlIGFwcGx5IHJ1bnMgdGhhdCBhZmZlY3QgdGhlIFVJXG4gICAgICAgICAgaWYgKHN0YXRlLnR5cGUgPT09IFwicnVubmluZ1wiICYmICFzdGF0ZS5jYW5jZWxsZWQpIHtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlU3RhdGUoe1xuICAgICAgICAgICAgICB0eXBlOiBcImRlc3Ryb3lpbmdcIixcbiAgICAgICAgICAgICAgc3RhY2tOYW1lOiB0aGlzLnN0YWNrLm5hbWUsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlLnR5cGUgPT09IFwid2FpdGluZyBmb3IgYXBwcm92YWxcIikge1xuICAgICAgICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7XG4gICAgICAgICAgICAgIHR5cGU6IFwid2FpdGluZyBmb3Igc3RhY2sgYXBwcm92YWxcIixcbiAgICAgICAgICAgICAgc3RhY2tOYW1lOiB0aGlzLnN0YWNrLm5hbWUsXG4gICAgICAgICAgICAgIGFwcHJvdmU6IHN0YXRlLmFwcHJvdmUsXG4gICAgICAgICAgICAgIHJlamVjdDogKCkgPT4ge1xuICAgICAgICAgICAgICAgIHN0YXRlLnJlamVjdCgpO1xuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlU3RhdGUoe1xuICAgICAgICAgICAgICAgICAgdHlwZTogXCJkaXNtaXNzZWRcIixcbiAgICAgICAgICAgICAgICAgIHN0YWNrTmFtZTogdGhpcy5zdGFjay5uYW1lLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZS50eXBlID09PSBcIndhaXRpbmcgZm9yIHNlbnRpbmVsIG92ZXJyaWRlXCIpIHtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlU3RhdGUoe1xuICAgICAgICAgICAgICB0eXBlOiBcIndhaXRpbmcgZm9yIHN0YWNrIHNlbnRpbmVsIG92ZXJyaWRlXCIsXG4gICAgICAgICAgICAgIHN0YWNrTmFtZTogdGhpcy5zdGFjay5uYW1lLFxuICAgICAgICAgICAgICBvdmVycmlkZTogc3RhdGUub3ZlcnJpZGUsXG4gICAgICAgICAgICAgIHJlamVjdDogKCkgPT4ge1xuICAgICAgICAgICAgICAgIHN0YXRlLnJlamVjdCgpO1xuICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlU3RhdGUoe1xuICAgICAgICAgICAgICAgICAgdHlwZTogXCJkaXNtaXNzZWRcIixcbiAgICAgICAgICAgICAgICAgIHN0YWNrTmFtZTogdGhpcy5zdGFjay5uYW1lLFxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZS50eXBlID09PSBcImV4dGVybmFsIGFwcHJvdmFsIHJlcGx5XCIpIHtcbiAgICAgICAgICAgIHRoaXMudXBkYXRlU3RhdGUoe1xuICAgICAgICAgICAgICB0eXBlOiBcImV4dGVybmFsIHN0YWNrIGFwcHJvdmFsIHJlcGx5XCIsXG4gICAgICAgICAgICAgIHN0YWNrTmFtZTogdGhpcy5zdGFjay5uYW1lLFxuICAgICAgICAgICAgICBhcHByb3ZlZDogc3RhdGUuYXBwcm92ZWQsXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlLnR5cGUgPT09IFwiZXh0ZXJuYWwgc2VudGluZWwgb3ZlcnJpZGUgcmVwbHlcIikge1xuICAgICAgICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7XG4gICAgICAgICAgICAgIHR5cGU6IFwiZXh0ZXJuYWwgc3RhY2sgc2VudGluZWwgb3ZlcnJpZGUgcmVwbHlcIixcbiAgICAgICAgICAgICAgc3RhY2tOYW1lOiB0aGlzLnN0YWNrLm5hbWUsXG4gICAgICAgICAgICAgIG92ZXJyaWRkZW46IHN0YXRlLm92ZXJyaWRkZW4sXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICk7XG5cbiAgICAgIGlmICghY2FuY2VsbGVkKVxuICAgICAgICB0aGlzLnVwZGF0ZVN0YXRlKHtcbiAgICAgICAgICB0eXBlOiBcImRlc3Ryb3llZFwiLFxuICAgICAgICAgIHN0YWNrTmFtZTogdGhpcy5zdGFjay5uYW1lLFxuICAgICAgICB9KTtcbiAgICB9KTtcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBmZXRjaE91dHB1dHMoKSB7XG4gICAgYXdhaXQgdGhpcy5ydW4oYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgdGVycmFmb3JtID0gYXdhaXQgdGhpcy50ZXJyYWZvcm1DbGllbnQoKTtcblxuICAgICAgY29uc3Qgb3V0cHV0cyA9IGF3YWl0IHRlcnJhZm9ybS5vdXRwdXQoKTtcbiAgICAgIGNvbnN0IG91dHB1dHNCeUNvbnN0cnVjdElkID0gZ2V0Q29uc3RydWN0SWRzRm9yT3V0cHV0cyhcbiAgICAgICAgSlNPTi5wYXJzZSh0aGlzLnN0YWNrLmNvbnRlbnQpLFxuICAgICAgICBvdXRwdXRzXG4gICAgICApO1xuICAgICAgdGhpcy51cGRhdGVTdGF0ZSh7XG4gICAgICAgIHR5cGU6IFwib3V0cHV0cyBmZXRjaGVkXCIsXG4gICAgICAgIHN0YWNrTmFtZTogdGhpcy5zdGFjay5uYW1lLFxuICAgICAgICBvdXRwdXRzLFxuICAgICAgICBvdXRwdXRzQnlDb25zdHJ1Y3RJZCxcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRoaXMub3V0cHV0cztcbiAgfVxuXG4gIHB1YmxpYyBhc3luYyBzdG9wKCkge1xuICAgIHRoaXMuc3RvcHBlZCA9IHRydWU7XG4gIH1cbn1cbiJdfQ==